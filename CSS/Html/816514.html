<header><h1>How To Configure IPSec Tunneling in Windows Server 2003</h1></header><div class='kb-notice-section section'>Template: Unmanaged Tech Community - HOWTO</div><div><span></span></div><div class='kb-securedata-section section'>DO NOT DELETE OR ARCHIVE THIS ARTICLE<br>This article is referenced by TechNet.<br>Contact the Content Business Manager for this product if you have any questions.<br></div><div class='kb-notice-section section'><span><div class='kb-notice-section section'>For a Microsoft Windows 2000 version of this article, see <a id='kb-link-1' href='/EN-US/help/252735'>252735 </a>.<br></div></span></div><div class='kb-notice-section section'><a class='bookmark' id='99'></a><h3 class='sbody-h3'>IN THIS TASK</h3><ul class='sbody-free_list'><li><a managed-link="" href='#1' target="" bookmark-id='1'>SUMMARY</a></li><li><a managed-link="" href='#2' target="" bookmark-id='2'>MORE INFORMATION</a><ul class='sbody-free_list'><li><a managed-link="" href='#21' target="" bookmark-id='21'>Create IPSec Policy</a></li><li><a managed-link="" href='#22' target="" bookmark-id='22'>Build a Filter List from NetA to NetB</a></li><li><a managed-link="" href='#23' target="" bookmark-id='23'>Build a Filter List from NetB to NetA</a></li><li><a managed-link="" href='#24' target="" bookmark-id='24'>Configure a Rule for a NetA-to-NetB Tunnel</a></li><li><a managed-link="" href='#25' target="" bookmark-id='25'>Configure a Rule for a NetB-to-NetA Tunnel</a></li><li><a managed-link="" href='#255' target="" bookmark-id='255'>Assign Your New IPSec Policy to Your Windows Server 2003 Gateway</a></li><li><a managed-link="" href='#256' target="" bookmark-id='256'>Configure Routing and Remote Access Filtering</a></li><li><a managed-link="" href='#257' target="" bookmark-id='257'>Configure Static Routes in Routing and Remote Access</a></li><li><a managed-link="" href='#26' target="" bookmark-id='26'>Test Your IPSec Tunnel</a></li><li><a managed-link="" href='#266' target="" bookmark-id='266'>Enable Auditing for Logon Events and Object Access</a></li><li><a managed-link="" href='#27' target="" bookmark-id='27'>IP Security Monitor</a></li><li><a managed-link="" href='#28' target="" bookmark-id='28'>Network Monitor</a></li><li><a managed-link="" href='#288' target="" bookmark-id='288'>Actual Test</a></li></ul></li><li><a managed-link="" href='#29' target="" bookmark-id='29'>REFERENCES</a></li></ul><a class='bookmark' id='1'></a></div><div class='kb-summary-section section'> You can use IP Security (IPSec) in tunnel mode to encapsulate Internet Protocol (IP) packets and optionally encrypt them. The primary reason for using IPSec tunnel mode (sometimes referred to as &quot;pure IPSec tunnel&quot;) in Windows Server 2003 is for interoperability with non-Microsoft routers or gateways that do not support Layer 2 Tunneling Protocol (L2TP)/IPSec or PPTP virtual private network (VPN) tunneling technology.<br><br><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><br><a class='bookmark' id='2'></a></div><div class='kb-moreinformation-section section'>Windows Server 2003 supports IPSec tunneling for situations where both tunnel endpoints have static IP addresses. This is primarily useful in gateway-to-gateway implementations. However, it may also work for specialized network security scenarios between a gateway or router and a server. (For example, a Windows Server 2003 router that routes traffic from its external interface to an internal Windows Server 2003-based computer that secures the internal path by establishing an IPSec tunnel to the internal server that provides services to the external clients).<br><br> Windows Server 2003 IPSec tunneling is not supported for client remote access VPN use because the Internet Engineering Task Force (IETF) IPSec Requests for Comments (RFCs) do not currently provide a remote access solution in the Internet Key Exchange (IKE) protocol for client-to-gateway connections. IETF RFC 2661, Layer Two Tunneling Protocol &quot;L2TP,&quot; was specifically developed by Cisco, Microsoft, and others to provide client remote access VPN connections. In Windows Server 2003, client remote access VPN connections are protected using an automatically generated IPSec policy that uses IPSec transport mode (not tunnel mode) when the L2TP tunnel type is selected.<br><br> Windows Server 2003 IPSec tunneling also does not support protocol-specific and port-specific tunnels. While the Microsoft Management Console (MMC) IPSec Policy snap-in is very general and allows you to associate any type of filter with a tunnel, make sure that you use only address information in the specification of a filter for a tunnel rule.<br><br> For more information about how the IPSec and IKE protocols work, see the <span class='sbody-italic'>Microsoft Windows Server 2003 Resource Kit</span>.<br><br> This article describes how to configure an IPSec tunnel on a Windows Server 2003 gateway. Because the IPSec tunnel secures only traffic that is specified in the IPSec filters that you configure, this article also describes how to configure filters in the Routing and Remote Access service to prevent traffic outside the tunnel from being received or forwarded. This article uses the following scenario to make it easy to follow the configuration steps:<br><br><div class='table-responsive'><table class='sbody-table table'><tr class='sbody-tr'><td class='sbody-td'> NetA-<br>WIN2003intIP-</td><td class='sbody-td'>-Windows Server 2003 gateway-<br>-WIN2003extIP-</td><td class='sbody-td'>-Internet-</td><td class='sbody-td'>-non-Microsoft gateway-<br>-3rdExtIP-</td><td class='sbody-td'>-NetB<br>-3rdIntIP</td></tr></table></div><br><strong class='sbody-strong'>NetA</strong> is the network ID of the Windows Server 2003 gateway internal network.<br><br><strong class='sbody-strong'>WIN2003intIP</strong> is the IP address that is assigned to the Windows Server 2003 gateway internal network adapter.<br><br><strong class='sbody-strong'>WIN2003extIP</strong> is the IP address that is assigned to the Windows Server 2003 gateway external network adapter.<br><br><strong class='sbody-strong'>3rdExtIP</strong> is the IP address that is assigned to the non-Microsoft gateway external network adapter.<br><br><strong class='sbody-strong'>3rdIntIP</strong> is the IP address that is assigned to the non-Microsoft gateway internal network adapter.<br><br><strong class='sbody-strong'>NetB</strong> is the network ID of the non-Microsoft gateway internal network. <br><br> The goal is for the Windows Server 2003 gateway and the non-Microsoft gateway to establish an IPSec tunnel when traffic from <strong class='sbody-strong'>NetA</strong> must be routed to<br> <strong class='sbody-strong'>NetB</strong> or when traffic from<br> <strong class='sbody-strong'>NetB</strong> must be routed to<br> <strong class='sbody-strong'>NetA</strong> so traffic is routed over a secure session.<br><br>If you want to configure an IPSec policy, you must build two filters: one filter to match packets going from <strong class='sbody-strong'>NetA</strong> to<br> <strong class='sbody-strong'>NetB</strong> (tunnel 1), and one filter to match packets going from<br> <strong class='sbody-strong'>NetB</strong> to <strong class='sbody-strong'>NetA</strong> (tunnel 2). You must configure a filter action to specify how the tunnel is secured (a tunnel is represented by a rule, so two rules are created).<br><br><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='21'></a><h3 class='sbody-h3'>Create IPSec Policy</h3> Typically, a Windows Server 2003 gateway is not a member of a domain, so a local IPSec policy is created. If the Windows Server 2003 gateway is a member of a domain that has IPSec policy applied to all members of the domain by default, this prevents the Windows Server 2003 gateway from having a local IPSec policy. In this case, you can create an organizational unit in Active Directory, make the Windows Server 2003 gateway a member of this organizational unit, and assign the IPSec policy to the Group Policy object (GPO) of the organizational unit. For more information, see the &quot;Creating, modifying, and assigning IPSec policies&quot; section of Windows Server 2003 online Help.<ol class='sbody-num_list'><li> Click <strong class='uiterm'>Start</strong>, click <strong class='uiterm'>Run</strong>, and then type <span class='sbody-userinput'>secpol.msc</span> to start the IP Security Policy Management snap-in.</li><li>Right-click <strong class='uiterm'>IP Security Policies on Local Computer</strong>, and then click <strong class='uiterm'>Create IP Security Policy</strong>.</li><li>Click <strong class='uiterm'>Next</strong>, and then type a name for your policy (for example, <span class='sbody-userinput'>IPSec Tunnel with non-Microsoft Gateway</span>). Click<br><strong class='uiterm'>Next</strong>.<br><br><span class='text-base'>Note</span> You can also type information in the<br><strong class='uiterm'>Description</strong> box.</li><li>Click to clear the <strong class='uiterm'>Activate the default response rule</strong> check box, and then click <strong class='uiterm'>Next</strong>.</li><li>Click <strong class='uiterm'>Finish</strong> (leave the<br><strong class='uiterm'>Edit</strong> check box selected).</li></ol><span class='text-base'>Note</span> The IPSec policy is created with default settings for the IKE main mode. The IPSec tunnel is made up of two rules. Each rule specifies a tunnel endpoint. Because there are two tunnel endpoints, there are two rules. The filters in each rule must represent the source and destination IP addresses in IP packets that are sent to that rule&#39;s tunnel endpoint.<br><br><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='22'></a><h3 class='sbody-h3'>Build a Filter List from NetA to NetB</h3><ol class='sbody-num_list'><li>In the new policy properties, click to clear the<br><strong class='uiterm'>Use Add Wizard</strong> check box, and then click <strong class='uiterm'>Add</strong>to create a new rule.</li><li>Click the <strong class='uiterm'>IP Filter List</strong> tab, and then click<br><strong class='uiterm'>Add</strong>.</li><li>Type an appropriate name for the filter list, click to clear the <strong class='uiterm'>Use Add Wizard</strong> check box, and then click<br><strong class='uiterm'>Add</strong>.</li><li>In the <strong class='uiterm'>Source address</strong> box, click <strong class='uiterm'>A specific IP Subnet</strong>, and then type the <strong class='uiterm'>IP Address</strong>and <strong class='uiterm'>Subnet mask</strong>to for <strong class='sbody-strong'>NetA</strong>.</li><li>In the <strong class='uiterm'>Destination address</strong> box, click<br><strong class='uiterm'>A specific IP Subnet</strong>, and then type the <strong class='uiterm'>IP Address</strong> and <strong class='uiterm'>Subnet mask</strong> for <strong class='sbody-strong'>NetB</strong>.</li><li>Click to clear the <strong class='uiterm'>Mirrored</strong> check box.</li><li>Click the <strong class='uiterm'>Protocol</strong> tab. Make sure that the<br><strong class='uiterm'>protocol type</strong> is set to <strong class='uiterm'>Any</strong>, because IPSec tunnels do not support protocol-specific or port-specific filters.</li><li>If you want to type a description for your filter, click the <strong class='uiterm'>Description</strong> tab. It is generally a good idea to give the filter the same name that you used for the filter list. The filter name appears in the IPSec monitor when the tunnel is active.</li><li>Click <strong class='uiterm'>OK</strong>.</li></ol><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='23'></a><h3 class='sbody-h3'>Build a Filter List from NetB to NetA</h3><ol class='sbody-num_list'><li>Click the <strong class='uiterm'>IP Filter List</strong> tab, and then click <strong class='uiterm'>Add</strong>.</li><li>Type an appropriate name for the filter list, click to clear the <strong class='uiterm'>Use Add Wizard</strong> check box, and then click<br><strong class='uiterm'>Add</strong>.</li><li>In the <strong class='uiterm'>Source address</strong> box, click <strong class='uiterm'>A specific IP Subnet</strong>, and then type the <strong class='uiterm'>IP Address</strong>and <strong class='uiterm'>Subnet mask</strong> for <strong class='sbody-strong'>NetB</strong>.</li><li>In the <strong class='uiterm'>Destination address</strong> box, click<br><strong class='uiterm'>A specific IP Subnet</strong>, and then type the <strong class='uiterm'>IP Address</strong> and <strong class='uiterm'>Subnet mask</strong> for <strong class='sbody-strong'>NetA</strong>.</li><li>Click to clear the <strong class='uiterm'>Mirrored</strong> check box.</li><li>If you want to type a description for your filter, click the <strong class='uiterm'>Description</strong> tab.</li><li>Click <strong class='uiterm'>OK</strong>.</li></ol><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='24'></a><h3 class='sbody-h3'>Configure a Rule for a NetA-to-NetB Tunnel</h3><ol class='sbody-num_list'><li>Click the <strong class='uiterm'>IP Filter List</strong> tab, and then click to select the filter list that you created.</li><li>Click the <strong class='uiterm'>Tunnel Setting</strong> tab, click<br><strong class='uiterm'>The tunnel endpoint is specified by this IP Address</strong> box, and then type <span class='sbody-userinput'><strong class='sbody-strong'>3rdextip</strong></span> (where<br><strong class='sbody-strong'>3rdextip</strong> is the IP address that is assigned to the non-Microsoft gateway external network adapter).</li><li>Click the <strong class='uiterm'>Connection Type</strong> tab, click<br><strong class='uiterm'>All network connections</strong> (or click <strong class='uiterm'>Local area network (LAN)</strong> if <strong class='sbody-strong'>WIN2003extIP</strong> is not an ISDN, PPP, or direct-connect serial connection).</li><li>Click the <strong class='uiterm'>Filter Action</strong> tab, click to clear the <strong class='uiterm'>Use Add Wizard</strong> check box, and then click<br><strong class='uiterm'>Add</strong> to create a new filter action because the default actions allow incoming traffic in clear text.</li><li>Keep the <strong class='uiterm'>Negotiate security</strong> option enabled, and then click to clear the <strong class='uiterm'>Accept unsecured communication, but always respond using IPSec</strong> check box. You must do this for secure operation.<br><br><span class='text-base'>Note</span> None of the check boxes at the bottom of the <strong class='uiterm'>Filter Action</strong> dialog box are selected as an initial configuration for a filter action that applies to tunnel rules. Only the <strong class='uiterm'>Use session key perfect forward secrecy (PFS)</strong> check box is a valid setting for tunnels if the other end of the tunnel is also configured to use PFS.</li><li>Click <strong class='uiterm'>Add</strong>, and keep the <strong class='uiterm'>Integrity and encryption</strong> option selected (or you can select the <strong class='uiterm'>Custom (for expert users)</strong> option if you want to define specific algorithms and session key lifetimes). Encapsulating Security Payload (ESP) is one of the two IPSec protocols.</li><li>Click <strong class='uiterm'>OK</strong>. Click the<br><strong class='uiterm'>General</strong> tab, type a name for the new filter action (for example, <span class='sbody-userinput'>IPSec tunnel: ESP DES/MD5</span>), and then click <strong class='uiterm'>OK</strong>.</li><li>Click to select the filter action that you just created.<br></li><li>Click the <strong class='uiterm'>Authentication Methods</strong> tab, configure the authentication method that you want (use <strong class='uiterm'>preshared key</strong> for testing, and otherwise use <strong class='uiterm'>certificates</strong>). Kerberos is technically possible if both ends of the tunnel are in trusted domains, and  each trusted domain&#39;s IP address (IP address of a domain controller) is reachable on the network by both ends of the tunnel during IKE negotiation of the tunnel (before it is established). But this is rare.</li><li>Click <strong class='uiterm'>Close</strong>.</li></ol><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='25'></a><h3 class='sbody-h3'>Configure a Rule for a NetB-to-NetA Tunnel</h3><ol class='sbody-num_list'><li>In IPSec policy properties, click <strong class='uiterm'>Add</strong> to create a new rule.</li><li>Click the <strong class='uiterm'>IP Filter List</strong> tab, click to select the filter list that you created (from <strong class='sbody-strong'>NetB</strong> to<br><strong class='sbody-strong'>NetA</strong>).</li><li>Click the <strong class='uiterm'>Tunnel Setting</strong> tab, click<br><strong class='uiterm'>The tunnel endpoint is specified by this IP Address</strong> box, and then type <span class='sbody-userinput'><strong class='sbody-strong'>WIN2003extIP</strong></span> (where<br><strong class='sbody-strong'>WIN2003extIP</strong> is the IP address that is assigned to the Windows Server 2003 gateway external network adapter).</li><li>Click the <strong class='uiterm'>Connection Type</strong> tab, click<br><strong class='uiterm'>All network connections</strong> (or click <strong class='uiterm'>Local area network (LAN)</strong> if <strong class='sbody-strong'>WIN2003extIP</strong> is not an ISDN, PPP, or direct-connect serial connection). Any outbound traffic on the interface type that matches the filters tries to be tunneled to the tunnel endpoint that is specified in the rule. Inbound traffic that matches the filters is discarded because it must be received secured by an IPSec tunnel.</li><li>Click the <strong class='uiterm'>Filter Action</strong> tab, and then click to select the filter action that you created.</li><li>Click the <strong class='uiterm'>Authentication Methods</strong> tab, and then configure the same method that you used in the first rule (the same method must be used in both rules).</li><li>Click <strong class='uiterm'>OK</strong>, make sure both rules that you created are enabled in your policy, and then click <strong class='uiterm'>OK</strong> again.</li></ol><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='255'></a><h3 class='sbody-h3'>Assign Your New IPSec Policy to Your Windows Server 2003 Gateway</h3>In the IP Security Policies on Local Computer MMC snap-in, right-click your new policy, and then click <strong class='uiterm'>Assign</strong>. A green arrow appears in the folder icon next to your policy.<br><br> After your policy is assigned, you have two additional active filters (Routing and Remote Access automatically creates IPSec filters for L2TP traffic). To see the active filters, type the following command at a command prompt:<div class='indent'><span class='sbody-userinput'>netdiag /test:ipsec /debug</span></div> You can optionally redirect the output of this command to a text file so you can view it with a text editor (such as Notepad) by typing the following command: <div class='indent'><span class='sbody-userinput'>netdiag /test:ipsec /debug &gt; <strong class='sbody-strong'>filename</strong>.txt</span></div> The <strong class='uiterm'>netdiag</strong> command is available after you install the Microsoft Windows Server 2003 Support Tools. To install the Support Tools, locate the Support\Tools folder on your Windows Server 2003 CD-ROM, right-click the Suptools.msi file, and then click <strong class='uiterm'>Install</strong>. After installation, you may have to run the<br> <strong class='uiterm'>netdiag</strong> command from the <strong class='sbody-strong'>%SystemRoot%</strong>\Program Files\Support Tools folder (where <strong class='sbody-strong'>%SystemRoot%</strong> is the drive where Windows Server 2003 is installed).<br><br> The tunnel filters look similar to the following example:<pre class='sbody-pre'><br>Local IPSec Policy Active: &#39;IPSec tunnel with {tunnel endpoint}&#39; IP Security Policy Path:<br>SOFTWARE\Policies\Microsoft\Windows\IPSec\Policy\Local\ipsecPolicy{-longnumber-} <br><br>There are two filters<br>From NetA to NetB<br>Filter ID: {-long number-}<br>Policy ID: {-long number-}<br>IPSEC_POLICY PolicyId = {-long number-}<br>Flags: 0x0<br>Tunnel Addr: 0.0.0.0<br>PHASE 2 OFFERS Count = 1<br>Offer #0:<br>ESP[ DES MD5 HMAC] <br>Rekey: 0 seconds / 0 bytes. <br>AUTHENTICATION INFO Count = 1<br>Method = Preshared key: -actual key-<br>Src Addr: NetA Src Mask: -subnet mask-<br>Dest Addr: NetB Dest Mask: -subnet mask-<br>Tunnel Addr: 3rdExtIP Src Port: 0 Dest Port: 0<br>Protocol: 0 TunnelFilter: Yes<br>Flags : Outbound<br>From NetB to NetA<br>Filter ID: {-long number-}<br>Policy ID: {-long number-}<br>IPSEC_POLICY PolicyId = {-long number-}<br>Flags: 0x0<br>Tunnel Addr: 0.0.0.0<br>PHASE 2 OFFERS Count = 1<br>Offer #0:<br>ESP[ DES MD5 HMAC] <br>Rekey: 0 seconds / 0 bytes. <br>AUTHENTICATION INFO Count = 1<br>Method = Preshared key: -actual key-<br>Src Addr: NetB Src Mask: -subnet mask-<br>Dest Addr: NetA Dest Mask: -subnet mask-<br>Tunnel Addr: W2KextIP Src Port: 0 Dest Port: 0<br>Protocol: 0 TunnelFilter: Yes<br>Flags: Inbound </pre><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='256'></a><h3 class='sbody-h3'>Configure Routing and Remote Access Filtering</h3> If you want to prevent traffic that does not have a source or destination address that matches <strong class='sbody-strong'>NetA</strong> or<br> <strong class='sbody-strong'>NetB</strong>, create an output filter for the external interface in the Routing and Remote Access MMC so that the filter drops all traffic except packets from <strong class='sbody-strong'>NetA</strong> to<br> <strong class='sbody-strong'>NetB</strong>. Also create an input filter so the filter drops all traffic except packets from <strong class='sbody-strong'>NetB</strong> to<br> <strong class='sbody-strong'>NetA</strong>. You also have to allow traffic to and from<br> <strong class='sbody-strong'>WIN2003extIP</strong> and <strong class='sbody-strong'>3rdExtIP</strong> to allow IKE negotiation when the tunnel is being created. Routing and Remote Access filtering is performed over IPSec. You do not have to specifically allow the IPSec protocol because it never reaches the IP packet filter layer. The following example is a very simple representation of the Windows Server 2003 TCP/IP architecture: <pre class='sbody-pre'><br>Application layer <br>Transport layer (TCP|UDP|ICMP|RAW) <br>---- Network layer start ---- <br>IP Packet Filter (where NAT/Routing and Remote Access filtering is done) <br>IPSec (where IPSec filters are implemented) <br>Fragmentation/Reassembly <br>---- Network layer end ------ <br>NDIS Interface <br>Datalink layer <br>Physical layer  </pre> To configure the filters in the Routing and Remote Access service, load the Routing and Remote Access MMC and follow these steps: <br> <ol class='sbody-num_list'><li>Expand your server tree under <strong class='uiterm'>Routing and Remote Access</strong>, expand the <strong class='uiterm'>IP Routing</strong> subtree, and then click<br><strong class='uiterm'>General</strong>.</li><li>Right-click <strong class='uiterm'><strong class='sbody-strong'>WIN2003extIP</strong></strong>, and then click <strong class='uiterm'>Properties</strong>.</li><li>Click <strong class='uiterm'>Outbound Filters</strong>, and then click<br><strong class='uiterm'>New</strong>.</li><li>Click to select the <strong class='uiterm'>Source network</strong> and<br><strong class='uiterm'>Destination network</strong> check boxes.</li><li>In the <strong class='uiterm'>Source network</strong> box, type the<br><strong class='uiterm'>IP address</strong> and <strong class='uiterm'>Subnet mask</strong> for <strong class='sbody-strong'>NetA</strong>.</li><li>In the <strong class='uiterm'>Destination network</strong> box, type the <strong class='uiterm'>IP address</strong> and <strong class='uiterm'>Subnet mask</strong> for <strong class='sbody-strong'>NetB</strong>. </li><li>Keep the protocol set to <strong class='uiterm'>Any</strong>, and then click <strong class='uiterm'>OK</strong>.</li><li>Click <strong class='uiterm'>New</strong>, and then click to select the<br><strong class='uiterm'>Source network</strong> and <strong class='uiterm'>Destination network</strong> check boxes.</li><li>In the <strong class='uiterm'>Source network</strong> box, type the<br><strong class='uiterm'>IP address</strong> and <strong class='uiterm'>Subnet mask</strong> for<br><strong class='sbody-strong'>WIN2003extIP</strong>. </li><li>In the <strong class='uiterm'>Destination network</strong> box, type the <strong class='uiterm'>IP address</strong> and <strong class='uiterm'>Subnet mask</strong> for <strong class='sbody-strong'>3rdExtIP</strong> (for IKE negotiation use a subnet mask of 255.255.255.255).</li><li>Keep the protocol set to <strong class='uiterm'>Any</strong>, and then click <strong class='uiterm'>OK</strong>.</li><li>Click to select the <strong class='uiterm'>Drop all packets except those that meet the criteria below</strong> check box, and then click<br><strong class='uiterm'>OK</strong>.</li><li>Click <strong class='uiterm'>Input Filters</strong>, click<br><strong class='uiterm'>Add</strong>, and then click to select the <strong class='uiterm'>Source network</strong> and <strong class='uiterm'>Destination network</strong> check boxes.</li><li>In the <strong class='uiterm'>Source network</strong> box, type the<br><strong class='uiterm'>IP address</strong> and <strong class='uiterm'>Subnet mask</strong> for<br><strong class='sbody-strong'>NetB</strong>.</li><li>In the <strong class='uiterm'>Destination network</strong> box, type the <strong class='uiterm'>IP address</strong> and <strong class='uiterm'>Subnet mask</strong> for <strong class='sbody-strong'>NetA</strong>. </li><li>Keep the protocol set to <strong class='uiterm'>Any</strong>, and then click <strong class='uiterm'>OK</strong>.</li><li>Click <strong class='uiterm'>New</strong>, and then click to select the<br><strong class='uiterm'>Source network</strong> and <strong class='uiterm'>Destination network</strong> check boxes.</li><li>In the <strong class='uiterm'>Source network</strong> box, type the<br><strong class='uiterm'>IP address</strong> and <strong class='uiterm'>Subnet mask</strong> for <strong class='sbody-strong'>3rdExtIP</strong>.</li><li>In the <strong class='uiterm'>Destination network</strong> box, type the <strong class='uiterm'>IP address</strong> and <strong class='uiterm'>Subnet mask</strong> for <strong class='sbody-strong'>WIN2003extIP</strong> (for IKE negotiation use a subnet mask of 255.255.255.255).</li><li>Keep the protocol set to <strong class='uiterm'>Any</strong>, and then click <strong class='uiterm'>OK</strong>.</li><li>Click to select the <strong class='uiterm'>Drop all packets except those that meet the criteria below</strong> check box, and then click<br><strong class='uiterm'>OK</strong> two times.<br><br><span class='text-base'>Note</span> If the Routing and Remote Access server has more than one interface that is connected to the Internet, or if you have multiple IPSec tunnels, create Routing and Remote Access exempt filters for each IPSec tunnel (each source and destination IP subnet) for every Internet interface. </li></ol><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='257'></a><h3 class='sbody-h3'>Configure Static Routes in Routing and Remote Access</h3> The Windows Server 2003 gateway must have a route in its route table for <strong class='sbody-strong'>NetB</strong>. To configure this route, add a static route in the Routing and Remote Access MMC. If the Windows Server 2003 gateway is multihomed with two or more network adapters on the same external network (or two or more networks that can reach the destination tunnel IP<br> <strong class='sbody-strong'>3rdExtIP</strong>), the potential exists for the following: <br> <ul class='sbody-free_list'><li>Outbound tunnel traffic leaves on one interface, and the inbound tunnel traffic is received on a different interface. Even if you use IPSec offload network adapters, receiving on a different interface (than the outbound tunnel traffic is sent on) does not allow the receiving network adapter to process the encryption in hardware, because only the outbound interface can offload the Security Association (SA).</li><li>Outbound tunnel traffic leaves on an interface that is different from the interface that has the tunnel endpoint IP address. The source IP of the tunneled packet is the source IP on the outbound interface. If this is not the source IP that is expected by the other end, the tunnel is not established (or packets are dropped by the remote endpoint if the tunnel has already been established).</li></ul> To avoid sending outbound tunnel traffic on the wrong interface, define a static route to bind traffic to<br> <strong class='sbody-strong'>NetB</strong> to the appropriate external interface: <br> <ol class='sbody-num_list'><li>In the Routing and Remote Access MMC, expand your server tree, expand the <strong class='uiterm'>IP Routing</strong> subtree, right-click<br><strong class='uiterm'>Static Routes</strong>, and then click <strong class='uiterm'>New Static Route</strong>.</li><li>In the <strong class='uiterm'>Interface</strong> box, click<br><strong class='uiterm'><strong class='sbody-strong'>WIN2003extIP</strong></strong> (if this is the interface that you want to always use for outbound tunnel traffic).</li><li>Type the <strong class='uiterm'>Destination network</strong> and <strong class='uiterm'>Network mask</strong> for <strong class='sbody-strong'>NetB</strong>. </li><li>In the <strong class='uiterm'>Gateway</strong> box, type<br><span class='sbody-userinput'><strong class='sbody-strong'>3rdextip</strong></span>.</li><li>Keep the <strong class='uiterm'>Metric</strong> value set to its default (<strong class='uiterm'>1</strong>), and then click <strong class='uiterm'>OK</strong>.<br><br><span class='text-base'>Note</span> To address the issue of receiving inbound tunnel traffic on the wrong interface, do not advertise the interface&#39;s IP address by using a routing protocol. Also, configure a filter in the Routing and Remote Access service to drop packets to <strong class='sbody-strong'>NetA</strong> or<br><strong class='sbody-strong'>WIN2003extIP</strong> as indicated in the &quot;<a managed-link="" href='#256' target="" bookmark-id='256'>Configure Routing and Remote Access Filtering</a>&quot; section of this article.</li></ol><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='26'></a><h3 class='sbody-h3'> Test Your IPSec Tunnel</h3> You can initiate the tunnel by pinging from a computer on<br> <strong class='sbody-strong'>NetA</strong> to a computer on<br> <strong class='sbody-strong'>NetB</strong> (or from <strong class='sbody-strong'>NetB</strong> to<br> <strong class='sbody-strong'>NetA</strong>). If you created the filters correctly and assigned the correct policy, the two gateways establish an IPSec tunnel so they can send the ICMP traffic from the <span class='text-base'>ping</span> command in encrypted format. Even if the <span class='text-base'>ping</span> command works, verify that the ICMP traffic was sent in encrypted format from gateway to gateway. You can use the following tools to do this.<br><br><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='266'></a><h3 class='sbody-h3'>Enable Auditing for Logon Events and Object Access</h3> This logs events in the security log. This tells you if IKE security association negotiation was tried and if it was successful or not. <br> <ol class='sbody-num_list'><li>Using the Group Policy MMC snap-in, expand <strong class='uiterm'>Local Computer Policy</strong>, expand <strong class='uiterm'>Computer Configuration</strong>, expand <strong class='uiterm'>Windows Settings</strong>, expand <strong class='uiterm'>Security Settings</strong>, expand <strong class='uiterm'>Local Policies</strong>, and then click<br><strong class='uiterm'>Audit Policy</strong>.</li><li>Enable <strong class='uiterm'>Success</strong> and <strong class='uiterm'>Failure</strong> auditing for <strong class='uiterm'>Audit logon events</strong> and <strong class='uiterm'>Audit object access</strong>. <br><br><span class='text-base'>Note</span> If the Windows Server 2003 gateway is a member of a domain and if you are using a domain policy for auditing, the domain policy overwrites your local policy. In this case, modify the domain policy.</li></ol><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='27'></a><h3 class='sbody-h3'>IP Security Monitor</h3> The IP Security Monitor console shows IPSec statistics and active security associations (SA). After you try to establish the tunnel by using the<br> <span class='text-base'>ping</span> command, you can see if an SA was created (if the tunnel creation is successful, an SA is displayed). If the <span class='text-base'>ping</span> command is successful but there is no SA, the ICMP traffic was not protected by IPSec. If you see a &quot;soft association&quot; that did not previously exist, then IPSec agreed to allow this traffic to go &quot;on the clear&quot; (without encryption).<span> For additional information about &quot;Soft Associations&quot;, click the following article number to view the article in the Microsoft Knowledge Base: <div class='indent'><a id='kb-link-2' href='/EN-US/help/234580'>234580 </a> &quot;Soft Associations&quot; Between IPSec-Enabled and Non-IPSec-Enabled Computers</div></span><br><br><span class='text-base'>Note</span> In Microsoft Windows XP and the Windows Server 2003 family, IP Security Monitor is implemented as a Microsoft Management Console (MMC) console. To add the IP Security Monitor snap-in, follow these steps: <br> <ol class='sbody-num_list'><li>Click <strong class='uiterm'>Start</strong>, click <strong class='uiterm'>Run</strong>, type <strong class='uiterm'>MMC</strong>, and then click <strong class='uiterm'>OK</strong>.</li><li>Click <strong class='uiterm'>File</strong>, click <strong class='uiterm'>Add/Remove Snap-in</strong>, and then click <strong class='uiterm'>Add</strong>.</li><li>Click <strong class='uiterm'>IP Security Monitor</strong>, and then click<br><strong class='uiterm'>Add</strong>.</li><li>Click <strong class='uiterm'>Close</strong>, and then click<br><strong class='uiterm'>OK</strong>.</li></ol><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='28'></a><h3 class='sbody-h3'>Network Monitor</h3> You can use Network Monitor to capture traffic going through the<br> <strong class='sbody-strong'>WIN2003extIP</strong> interface while you try to ping the computer. If you can see ICMP packets in the capture file that have source and destination IP addresses that correspond to the IP addresses of the computer that you are pinging from and the computer you are trying to ping, then IPSec is not protecting the traffic. If you do not see this ICMP traffic but do see ISAKMP and ESP packets instead, IPSec is protecting the traffic. If you are using only the Authentication Header (AH) IPSec protocol, you will see the ISAKMP traffic followed by the ICMP packets. ISAKMP packets are the actual IKE negotiation occurring, and ESP packets are the payload data encrypted by the IPSec protocol.<br><br> To install Network Monitor, follow these steps: <br> <ol class='sbody-num_list'><li>Click <strong class='uiterm'>Start</strong>, click <strong class='uiterm'>Control Panel</strong>, click <strong class='uiterm'>Add or Remove Programs</strong>, and then click<br><strong class='uiterm'>Add/Remove Windows Components</strong>.</li><li>In the Windows Components wizard, click <strong class='uiterm'>Management and Monitoring Tools</strong>, and then click <strong class='uiterm'>Details</strong>.</li><li>In <strong class='uiterm'>Subcomponents of Management and Monitoring Tools</strong>, click to select the <strong class='uiterm'>Network Monitor Tools</strong>check box, and then click <strong class='uiterm'>OK</strong>.</li><li>If you are prompted for additional files, insert the installation CD for your operating system, or type a path of the location of the files on the network.</li></ol><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='288'></a><h3 class='sbody-h3'>Actual Test</h3><ol class='sbody-num_list'><li>Before you try to <span class='text-base'>ping</span> from a computer on one subnet to the other (<strong class='sbody-strong'>NetA</strong> or <strong class='sbody-strong'>NetB</strong>), type <span class='sbody-userinput'>ipconfig</span> at a command prompt. The network interfaces that are initialized in the TCP/IP stack are displayed.</li><li>Start the IP Security Monitor tool.</li><li>Start Network Monitor, and then on the<br><strong class='uiterm'>Capture</strong> menu, click <strong class='uiterm'>Networks</strong>. Click the<br><span class='sbody-userinput'><strong class='sbody-strong'>WIN2003extIP</strong></span> interface, and then click<br><strong class='uiterm'>OK</strong>.</li><li>Try to <span class='text-base'>ping</span> the computer. The first ICMP echo packets may time out while the IPSec tunnel is being built. If the <span class='text-base'>ping</span> is not successful, check the security and system logs. </li><li>If the <span class='text-base'>ping</span> is successful, stop the Network Monitor capture and see if the ICMP traffic went &quot;on the clear&quot; or if you just see the ISAKMP and IPSec protocol packets. Check IP Security Monitor to see if an SA was created using the <strong class='sbody-strong'>NetA</strong> to <strong class='sbody-strong'>NetB</strong>filter you created. Also check the security log. You should see Event ID 541 (IKE security association established).</li><li>Type <span class='sbody-userinput'>ipconfig</span> at a command prompt again to verify that there is no additional TCP/IP interface while the tunnel is in use. This behavior occurs because IPSec is protecting the traffic that is going through the physical interface (<strong class='sbody-strong'>WIN2003extIP</strong>). <br><br> If the remote gateway is also a Windows Server 2003 node, remember that: <br><ul class='sbody-free_list'><li>The default gateway for clients in<br> <strong class='sbody-strong'>NetA</strong> is <strong class='sbody-strong'>WIN2003extIP</strong>. The default gateway for clients in <strong class='sbody-strong'>NetB</strong> is<br> <strong class='sbody-strong'>3rdIntIP</strong>.</li><li>An IPSec tunnel does not change the way traffic is routed in the Windows Server 2003 gateway. (This gateway can route packets because routing is enabled in Routing and Remote Access. The actual LAN or WAN interface metrics are still used.)</li></ul></li></ol><a managed-link="" href='#99' target="" bookmark-id='99'>back to the top</a><a class='bookmark' id='29'></a></div><div> For more information about the Routing and Remote Access service, see Windows Server 2003 online Help.<br><br>To view the Windows Server 2003 Resource Kit and other technical documentation, visit the following Microsoft Web site:<div class='indent'><a id='kb-link-3' href='http://www.microsoft.com/windowsserver2003/default.mspx' target='_self'>http://www.microsoft.com/windowsserver2003/default.mspx</a></div>For IETF standards information, visit the following sites:<ul class='sbody-free_list'><li>IPSec<br><a id='kb-link-4' href='http://www.ietf.org/rfc/rfc2401.txt' target='_self'>http://www.ietf.org/rfc/rfc2401.txt</a></li><li> L2TP<br><a id='kb-link-5' href='http://www.ietf.org/html.charters/pppext-charter.html' target='_self'>http://www.ietf.org/html.charters/pppext-charter.html</a><br><a id='kb-link-6' href='ftp://ftp.isi.edu/in-notes/rfc2661.txt' target='_self'>ftp://ftp.isi.edu/in-notes/rfc2661.txt</a><br><a id='kb-link-7' href='http://www.ietf.org/html.charters/l2tpext-charter.html' target='_self'>http://www.ietf.org/html.charters/l2tpext-charter.html</a></li></ul><span> Microsoft provides third-party contact information to help you find technical support. This contact information may change without notice. Microsoft does not guarantee the accuracy of this third-party contact information. <br> </span></div><div class='kb-notice-section section'> Author: romanoj<br> Writer: Darryl Gittins V-DGit<br><br> Tech Reviewer: V-SHTOWN<br> Editor: v-jeffbo<br></div>