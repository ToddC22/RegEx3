<header><h1>How to use Memory Pool Monitor (Poolmon.exe) to troubleshoot kernel mode memory leaks</h1></header><div class='kb-summary-section section'> This article describes how to use the Memory Pool Monitor utility, Poolmon.exe, as a troubleshooting tool to monitor memory tags. <br><br>Poolmon displays data that the operating system collects about memory allocations from the system paged and nonpaged kernel pools and about the memory pools used for Terminal Services sessions. The data is grouped by pool allocation tag. This information can be used by Microsoft Technical Support to find kernel mode memory leaks. <br><br>A memory leak is caused by an application or by a process that allocates memory for use but that does not free the memory when the application or process finishes. Therefore, available memory is completely used over time. Frequently, this condition causes the system to stop functioning correctly. <br><br>In this case,   the following events may be logged in the System log: </div><div class='kb-moreinformation-section section'> The first section that follows describes how to enable tag mode for using Poolmon. The second section describes how to gather the information for troubleshooting by using Poolmon. <h3 class='sbody-h3'>Enabling Tag Mode</h3>Before running PoolMon, you must enable pool tagging and then restart your computer. The pool tagging feature collects and calculates statistics about pool memory sorted by the tag value of the memory allocation.<br><br><span class='text-base'>Note</span> It is not necessary to enable pool tagging in Windows Server 2003 as it is enabled by default.<br><br>To enable pool tagging on a Windows NT 4.0-based, Windows 2000-based, or Windows XP-based computer, use one of the following methods:<h4 class='sbody-h4'>Method 1: Edit the Registry</h4> To change the registry value that enables tag mode for Poolmon.exe, follow these steps.<br><br><span><span class='text-base'>Important</span> This section, method, or task contains steps that tell you how to modify the registry. However, serious problems might occur if you modify the registry incorrectly. Therefore, make sure that you follow these steps carefully. For added protection, back up the registry before you modify it. Then, you can restore the registry if a problem occurs. For more information about how to back up and restore the registry, click the following article number to view the article in the Microsoft Knowledge Base: <div class='indent'><a id='kb-link-1' href='/en-us/help/322756'>322756 </a> How to back up and restore the registry in Windows</div></span><ol class='sbody-num_list'><li>Run Registry Editor.</li><li>Locate the following key in the registry:<div class='indent'><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager</strong></div></li><li>Write down the value of <span class='text-base'>GlobalFlag</span>, or save the <strong class='sbody-strong'>Session Manager</strong> key.</li><li>Double-click the <strong class='uiterm'>GlobalFlag</strong> value in the right pane.</li><li>Change the value to <span class='sbody-userinput'>0x00000400</span>hexadecimal. <br><br><span class='text-base'>Note</span> When you add the global flag value 0x00000400, it only shows up as being 0x400 after it is added. It is important to add all of the leading zeros or some of the Poolmon information will not display on the output screen.</li><li>Restart the computer.</li></ol><span class='text-base'>Note</span> When you are finished debugging, change the GlobalFlag value back to the original value that you were instructed to write down in step 3. <h4 class='sbody-h4'>Method 2: Use the Gflags.exe Utility</h4>You can also use the Global Flags Editor (Gflags.exe) utility to enable pool tagging. Gflags.exe is available in the Windows NT 4.0 Resource Kit and in the \Support\Tools folder of Windows 2000, Windows XP, and Windows Server 2003 CD-ROMs. <br><br><span class='text-base'>Note</span> Because pool tagging is permanently enabled in Windows Server 2003, the <strong class='uiterm'>Enable Pool Tagging</strong> check box in the <strong class='uiterm'>Global Flags</strong> dialog box is dimmed and commands to enable or disable pool tagging fail. <br><br> To make the change by using Gflags.exe, follow these steps: <br> <ol class='sbody-num_list'><li>Click <strong class='uiterm'>Start</strong>, click <strong class='uiterm'>Run</strong>, type <span class='sbody-userinput'>gflags.exe</span>, and then click<br><strong class='uiterm'>OK</strong>.</li><li>Select <strong class='uiterm'>Enable Pool Tagging</strong>.</li><li>Click <strong class='uiterm'>Apply</strong>, and then click<br><strong class='uiterm'>OK</strong>.</li><li>Restart the computer.</li></ol><span class='text-base'>Note</span> When you are finished debugging, repeat the above steps to disable pool tagging. <br> </div><div class='kb-moreinformation-section section'>Pool tagging may result in a significant decrease in performance, particularily on multi-processor systems, in Windows NT 4.0, Windows 2000, and Windows XP. Pool tagging was rewritten in Windows Server 2003 to address this issue and was therefore enabled by default.</div><div class='kb-moreinformation-section section'><h3 class='sbody-h3'>Using Poolmon to Collect Information</h3>PoolMon displays pool tag information within a command window. Use the arrow keys or the PAGE UP and PAGE DOWN keys to display all the tag information returned by the tool.<br><br>Poolmon.exe is available in the Windows NT 4.0 Resource Kit and in the \Support\Tools folder of Windows 2000, Windows XP, and Windows Server 2003 CD-ROMs. <br><br>Use the following steps to copy and store the tag information. Repeat these steps for two hours at 15 minute intervals. Append each update to the end of the Notepad file. <br> <ol class='sbody-num_list'><li>Click <strong class='uiterm'>Start</strong>, point to<br><strong class='uiterm'>Settings</strong>, click <strong class='uiterm'>Control Panel</strong>, and then double-click <strong class='uiterm'>Console</strong>.<br><br><span class='text-base'>Note</span> For Windows 2000 you must perform the following steps: <br><ol class='sbody-alpha_list'><li>Click <strong class='uiterm'>Start</strong>, click<br> <strong class='uiterm'>Run</strong>, type <span class='sbody-userinput'>cmd</span>, and then click<br> <strong class='uiterm'>OK</strong>.<br></li><li>Right-click the title bar, and then click<br> <strong class='uiterm'>Properties</strong>.</li></ol></li><li>Click the <strong class='uiterm'>Options</strong> tab, click<br><strong class='uiterm'>QuickEdit Mode</strong>, and then click <strong class='uiterm'>Insert Mode</strong>.</li><li>Click the <strong class='uiterm'>Layout</strong> tab, change the<br><strong class='uiterm'>Screen Buffer Size</strong> value to <span class='sbody-userinput'>99</span>, and then click <strong class='uiterm'>OK</strong>.</li><li>Click <strong class='uiterm'>Start</strong>, point to<br><strong class='uiterm'>Programs</strong>, and then click <strong class='uiterm'>Command Prompt</strong>.</li><li>Locate Poolmon.exe in the Support\Debug\<strong class='sbody-strong'>platform</strong> folder on the Windows NT 4.0 CD. Change to the drive and folder where Poolmon.exe is located. On the Windows 2000 CD Poolmon.exe is in the Support.CAB file. Support.CAB is located under the \Support\Tools folder.</li><li>Type <span class='sbody-userinput'>Poolmon.exe</span>.</li><li>Press P until Poolmon displays the second column &quot;type&quot; and shows the value <span class='text-base'>paged</span>.</li><li>Press B to sort the columns from largest to smallest.</li><li>Select the whole screen contents, and then press ENTER.</li><li>Click <strong class='uiterm'>Start</strong>, point to<br><strong class='uiterm'>Programs</strong>, point to <strong class='uiterm'>Accessories</strong>, and then click <strong class='uiterm'>Notepad</strong>.</li><li>On the <strong class='uiterm'>Edit</strong> menu, click<br><strong class='uiterm'>Paste</strong>.</li><li>Repeat step 7 to look for the value <span class='text-base'>nonpaged</span>.</li><li>Repeat steps 8 - 11 to paste.</li></ol>Poolmon.exe also has a few command keys that sort the output for you. Press the letter indicated below to perform the operation. It takes a few seconds for each command to work. Here is a list of a few of the commands: <div class='indent'>P - Sorts tag list by Paged, Non-Paged, or mixed. Note that P cycles through each one.<br>B - Sorts tags by max byte usage.<br>M - Sorts tags by max byte allocation.<br>T - Sort tags alphabetically by tag name.<br>E - Display Paged, Non-paged total across bottom. Cycles through.<br>A - Sorts tags by allocation size.<br>F - Sorts tags by &quot;frees&quot;.<br>S - Sorts tags by the differences of allocs and frees.<br>E - Display Paged, Non-paged total across bottom. Cycles through.<br>Q - Quit.<br></div><span>For more information, click the following article number to view the article in the Microsoft Knowledge Base:<br><br><div class='indent'><a id='kb-link-2' href='/en-us/help/298102'>298102 </a> How to find pool tags that are used by third-party drivers<br><br></div></span></div><div class='kb-securedata-section section'><span>For more information about how to use Poolmon and to find kernel memory leaks, click the following article number to view the article in the Microsoft Knowledge Base:<br><br><div class='indent'><a id='kb-link-3' href='/en-us/help/115280'>115280 </a> Finding Windows NT Kernel Mode Memory Leaks<br><br></div></span></div><div class='kb-securedata-section section'>debugref allocs frees krnl paged nonp nonpaged non-paged pages gflags gflags.exe pool byte monitor</div><div class='kb-textlegacy-section section'>Author: stevewes (1997-11-30T02:30:00) Edit Reviewer: kimberwe (1998-05-14T08:19:00) Tech Reviewer: cgilbert (1998-02-16T14:05:00)<br> </div>