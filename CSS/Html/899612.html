<header><h1>How to set up computer quotas and queue quotas in Microsoft Message Queuing</h1></header><div class='kb-notice-section section'><div internal-content-body=""><div class="internal-content"><div class="bold internal-content-body-title spacer-12-bottom">Microsoft Internal Support Information</div><div class="row"><div class="col-xs-24 internal-content-body-content"><p>BUG #: <a href='http://bugcheck/bugs/ContentMaintenance/38330.asp' title='Link only available for Microsoft corporate network users' target='_blank'>38330 (Content Maintenance)</a></p></div></div></div></div></div><div class='kb-notice-section section'><span><span class='text-base'>Important</span> This article contains information about how to modify the registry. Make sure to back up the registry before you modify it. Make sure that you know how to restore the registry if a problem occurs. For more information about how to back up, restore, and modify the registry, click the following article number to view the article in the Microsoft Knowledge Base:<div class='indent'><a id='kb-link-1' href='/en-us/help/256986'>256986 </a> Description of the Microsoft Windows registry</div></span></div><div class='kb-summary-section section'>This article discusses how to set up computer quotas and queue quotas that limit the amount of  RAM that is available to Microsoft Message Queuing (also known as MSMQ) 3.0 and to Microsoft Message Queuing 2.0, and to individual queues.</div><div class='kb-moreinformation-section section'>The Message Queuing resource  is not designed to be used as a database or as long-term RAM. If too many messages accumulate in individual queues in the Message Queuing resource, the volume of message may have an adverse effect on system performance. However, because the primary function of the Message Queuing resource is to provide asynchronous messaging, the Message Queuing resource can hold messages until the appropriate applications or clients can receive the messages.<br><br>The Message Queuing resource stores messages in memory-mapped files. The memory-mapped files are mapped to the amount of RAM that is available to the Message Queuing resource. On a Microsoft Windows 2000 Advance Server-based computer, the default amount of RAM that is available to the Message Queuing resource is 2 gigabytes (GB). After the components of the Message Queuing resource are loaded onto the computer, the amount of RAM that is available to the Message Queuing resource is reduced to approximately 1.6 GB.<br><br>If you enable the <span class='text-base'>3GB</span> switch in the Boot.ini file, the amount of RAM that is available to the Message Queuing resource increases to 3 GB. After the components of the Message Queuing resource are loaded onto the computer, the amount of RAM that is available to the Message Queuing resource is reduced to 2.7 GB.<br><br><span class='text-base'>Note</span> The limitation on the amount of RAM that is available to the Message Queuing resource does not apply to Message Queuing 3.0.<br><br>The Message Queuing resource uses approximately 70-80 bytes of RAM for every message. This is not a concern in Microsoft Message Queuing 1.0 or in Microsoft Message Queuing 2.0, where the volume of messages typically reaches a maximum size of between 1.6 GB and 1.8 GB before exhausting the available RAM. However, Message Queuing 3.0 running on a Microsoft Windows XP-based computer or on a Microsoft Windows Server 2003-based computer can accumulate enough messages for the RAM to be consumed by the Message Queuing Data Access (Mqac.sys) driver. When this problem occurs, system performance is affected.<br><br>Although this problem is rare, it may occur for one of the following reasons:<ul class='sbody-free_list'><li>The computer or application that is reading from the Message Queuing resource has stopped.</li><li>The Message Queuing resource is not configured correctly.</li></ul>For these reasons, we recommend the use of quotas.<h3 class='sbody-h3'>Computer quotas and queue quotas</h3>The Message Queuing resource uses the following two types of quotas:<ul class='sbody-free_list'><li>Computer quotas</li><li>Queue quotas</li></ul>Computer quotas limit the number of messages that are stored in destination queues, outgoing queues, and queue journals.<br><br>Queue quotas limit the number of bytes that are available for all messages that are stored in a particular queue.<br><br>To set up computer quotas for the Message Queuing resource or queue quotas for the Message Queuing resource, use one of the following methods.<h4 class='sbody-h4'>Method 1: Set up a computer quota on a computer that has the Message Queuing resource installed in Domain Mode and that has Active Directory integrated</h4>To set up a computer quota on a computer that has the Message Queuing resource installed in Domain Mode and that has Active Directory integrated, follow these steps:<ol class='sbody-num_list'><li>Click <strong class='uiterm'>Start</strong>, point to <strong class='uiterm'>Administrative Tools</strong>, and then click <strong class='uiterm'>Computer Management</strong>.</li><li>Click <strong class='uiterm'>Services and Applications</strong>.</li><li>Right-click <strong class='uiterm'>Message Queuing</strong>, and then click <strong class='uiterm'>Properties</strong>.</li><li>Click to select the <strong class='uiterm'>Limit message storage to (KB)</strong> check box.</li><li>In the <strong class='uiterm'>Amount of space</strong> box, enter the amount of kilobytes that you want to enable the Message Queuing resource to retain.</li><li>Press <strong class='uiterm'>OK</strong> to accept the changes. After you do this, the <strong class='uiterm'>Properties</strong> dialog box will automatically close.</li></ol><h4 class='sbody-h4'>Method 2: Remotely set up a computer quota by using the <strong class='uiterm'>Active Directory Users and Computers</strong> tool on a computer that has the Message Queuing resource installed in Domain Mode</h4>To remotely set up a computer quota by using the <strong class='uiterm'>Active Directory Users and Computers</strong> tool on a computer that has the Message Queuing resource installed in Domain Mode, follow these steps:<br><br><span class='text-base'>Note</span> You must be logged onto a computer that is currently running the Message Queuing resource and that has the Active Directory management tools installed.<ol class='sbody-num_list'><li>Open <strong class='uiterm'>Active Directory Users and Computers</strong>, and then click the <strong class='uiterm'>Computers</strong> folder that contains the computer that you are trying to manage.</li><li>On the shortcut menu, click <strong class='uiterm'>View</strong>, and then click <strong class='uiterm'>Users, Groups, and Computers as containers</strong>.</li><li>Open <strong class='uiterm'>Active Directory Users and Computers</strong> again. On the <strong class='uiterm'>View</strong> menu, click <strong class='uiterm'>Advanced Features</strong>.</li><li>Locate and then expand the name of the computer that you want to manage.</li><li>The Message Queuing resource object should display an envelope icon.<br><div class='indent'><span class='text-base'>Note</span> If the envelope icon that is displayed is a default Windows icon, the Message Queuing resource  is probably not installed on the computer that you are trying to access by using Active Directory.</div></li><li>Right-click <strong class='uiterm'>Message Queuing</strong>, and then click <strong class='uiterm'>Properties</strong>.</li><li>Click to select the <strong class='uiterm'>Limit message storage to (KB)</strong> check box.</li><li>In the <strong class='uiterm'>Amount of space</strong> box, enter the limit of kilobytes that you want to enable the Message Queuing resource to retain.</li><li>Press <strong class='uiterm'>OK</strong> to accept the changes. After you do this, the <strong class='uiterm'>Properties</strong> dialog box will automatically close.</li></ol><h4 class='sbody-h4'>Method 3: Set up a computer quota on a computer that has the Message Queuing resource installed in Workgroup mode and that is not integrated with Active Directory</h4>To set up a computer quota on a computer that has the Message Queuing resource installed in Workgroup mode and that is not integrated with Active Directory, follow these steps:<br><br><span><span class='text-base'>Warning</span> Serious problems might occur if you modify the registry incorrectly by using Registry Editor or by using another method. These problems might require that you reinstall your operating system. Microsoft cannot guarantee that these problems can be solved. Modify the registry at your own risk.</span><ol class='sbody-num_list'><li>Click <strong class='uiterm'>Start</strong>, click <strong class='uiterm'>Run</strong>, type <span class='sbody-userinput'>regedit</span>, and then click <strong class='uiterm'>OK</strong>. <br></li><li>Locate and then click the following key in the registry:<br><div class='indent'><span class='text-base'><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\MSMQ\Parameters\MachineCache\MachineQuota</strong></span></div></li><li>On the <strong class='uiterm'>Edit</strong> menu, click <strong class='uiterm'>Modify</strong>.</li><li>Type <span class='sbody-userinput'>amount of space</span>, and then press ENTER. You must specify the amount of space in kilobytes.<br><br><span class='text-base'>Note</span> You must restart the Message Queuing resource for these changes to take effect.</li></ol><h4 class='sbody-h4'>Method 4: Set up a queue quota</h4>To set up a queue quota, follow these steps:<ol class='sbody-num_list'><li>Click <strong class='uiterm'>Start</strong>, point to <strong class='uiterm'>Administrative Tools</strong>, and then click <strong class='uiterm'>Computer Management</strong>.</li><li>Click <strong class='uiterm'>Services and Applications</strong>.</li><li>Click <strong class='uiterm'>Message Queuing</strong>.</li><li>Click to select <strong class='uiterm'>Public</strong> if you want to set a quota on a public queue. Click to select <strong class='uiterm'>Private</strong> if you want to set a quota on a private queue.<br><br><span class='text-base'>Note</span> The next four steps are the same whether you are setting a quota on a public queue or on a private queue.</li><li>Right-click <strong class='uiterm'>Message Queuing</strong>, and then click <strong class='uiterm'>Properties</strong>.</li><li>Click to select the <strong class='uiterm'>Limit message storage to (KB)</strong> check box.</li><li>In the <strong class='uiterm'>Amount of space</strong> box, enter the limit of kilobytes that you want to enable the Message Queuing resource to retain.</li><li>Press <strong class='uiterm'>OK</strong> to accept the changes. After you do this, the <strong class='uiterm'>Properties</strong> dialog box will automatically close.</li><li>Repeat steps 1 through 8 for all queues, such as dead letter queues and journal queues, on which you want to set up a quota.</li></ol><span class='text-base'>Notes</span><ul class='sbody-free_list'><li>You can also set up queue quotas on public queues by using the <strong class='uiterm'>Active Directory Users and Computers</strong> tool. Use this tool  similarly to how you used the tool in method 2 to set up a computer quota on a computer that has the Message Queuing resource installed in Domain Mode.</li><li>Setting up quotas is a best practice that may help you maintain system performance and prevent the loss of data.</li></ul></div><div class='kb-references-section section'>For more information about computer quotas and queue quotas, visit the following Microsoft Web site:<div class='indent'><a id='kb-link-2' href='http://technet2.microsoft.com/windowsserver/en/library/bfa9b0e0-f79f-4b41-b13c-c02521e0316b1033.mspx' target='_self'>http://technet2.microsoft.com/windowsserver/en/library/bfa9b0e0-f79f-4b41-b13c-c02521e0316b1033.mspx</a></div></div><div class='kb-securedata-section section'> Content Maintenance 38330</div><div class='kb-securedata-section section'>Author: rstoker<br>Writer: v-sabhup<br>Tech Reviewer: nicoleh<br>Editor: v-cdemaa</div>