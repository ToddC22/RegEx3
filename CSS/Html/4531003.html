<header><h1>(draft) Troubleshooting Intune Win32 App deployment</h1></header><span asset="4476087" contenteditable="false" unselectable="on" props="{&#34;size&#34;:&#34;full&#34;}">[Asset 4476087]</span><ul><li><strong>Content Idea (CI): </strong><a managed-link="" href="https://aka.ms/CIEdit?id=110558" target="" data-content-type="" data-content-id="" bookmark-id="">110558</a></li></ul><p><strong>Support Topic: </strong><ul><li>Azure\Microsoft Intune\Manage Apps</li></ul></p><div><div>The purpose of this article is to assist with troubleshooting the installation of apps packaged with the&nbsp;<a href="https://go.microsoft.com/fwlink/?linkid=2065730">Microsoft Win32 Content Prep Tool</a>&nbsp;and uploaded to intune as .intunewin files as documented at&nbsp;<a href="https://docs.microsoft.com/en-us/intune/apps/apps-win32-app-management">https://docs.microsoft.com/en-us/intune/apps/apps-win32-app-management</a></div><div><br></div><div>For troubleshooting client-side events, you can refer to the below 3 logs located at&nbsp;<span style="box-sizing:border-box;text-align:left;">C:\ProgramData\Microsoft\IntuneManagementExtension\Logs</span></div><div><ul><li>IntuneManagementExtension.log : Tracks the Intune Management extension component events</li><li>AgentExecuter : Track any PowerShell execution events</li><li>ClientHealth.log :&nbsp; Track client-health related events</li></ul><div><span style="text-align:left;display:inline !important;"><span>You view the logs&nbsp;</span>using CMTrace.exe. CMTrace.exe</span><span style="box-sizing:border-box;text-align:left;">&nbsp;</span><span style="box-sizing:border-box;text-align:left;">can be downloaded from</span><span style="box-sizing:border-box;text-align:left;">&nbsp;</span><a href="https://docs.microsoft.com/sccm/core/support/tools" style="box-sizing:border-box;text-decoration:underline;cursor:pointer;text-align:left;">Configuration Manager Client Tools</a><br></div></div><div><br></div><div>There are several phases to consider when troubleshooting</div><div><ul><li>Detection Rules Evaluation</li><li>Check Applicability</li><li>Content Download</li><li>Application Installation</li><li>Detection after Installation</li></ul><h3>Prerequisites</h3></div><div><span style="font-weight:inherit;">First step is to check that the prerequisites have been met:</span><br></div><div><ul><li>Windows 10 version 1607 or later (Enterprise, Pro, and Education versions)</li><li>Windows 10 client needs to be:</li><ul><li>Devices must be joined to Azure AD and auto-enrolled. The Intune management extension supports Azure AD joined and hybrid domain joined</li><li>Group policy enrolled devices with Hybrid Domain Join are also supported</li><ul><li>For the group policy enrolled scenario - The end user uses the local user account to AAD join their Windows 10 device. The user must log onto the device using their AAD user account and enroll into Intune. Intune will install the Intune Management extension on the device if a PowerShell script or a Win32 app is targeted to the user or device.</li></ul></ul></ul><h3>Detection Rules Evaluation</h3><div><span style="font-weight:inherit;">Next step is to confirm that the Intune Management Extension (IME) got installed and that the application has been evaluated by the client</span><br></div></div><div><ol><li>Check Kusto and confirm if the pre-requisites are met<br><span style="color:blue;">DeviceManagementProvider</span>
| <span style="color:red;">where</span> <span style="color:mediumvioletred;">env_time</span> &gt;= <span style="color:blue;">ago</span>(2d)
| <span style="color:red;">where</span> <span style="color:mediumvioletred;">SourceNamespace</span> == <span style="color:firebrick;">&quot;IntunePE&quot;</span>
| <span style="color:red;">where</span> <span style="color:mediumvioletred;">deviceId</span> == <span style="color:firebrick;">&quot;&lt;Intune Device ID&gt;&quot;</span>
| <span style="color:red;">where</span> <span style="color:mediumvioletred;">message</span> <span style="color:blue;">contains</span> <span style="color:firebrick;">&quot;sidecar&quot;</span>
| <span style="color:red;">project</span> <span style="color:mediumvioletred;">env_time</span>, <span style="color:mediumvioletred;">userId</span>, <span style="color:mediumvioletred;">deviceId</span>, <span style="color:mediumvioletred;">message</span>, <span style="color:mediumvioletred;">EventMessage</span>           
| <span style="color:red;">take</span> 200</li><ol style="list-style:lower-alpha;"><li>If you see the message&nbsp;<i>SideCarAppInstallPrerequisite.IsSatisfied():
Prerequisite is not satisfied </i>then follow the SDK article for troubleshooting IME agent installation -&nbsp;<a href="https://internal.support.services.microsoft.com/en-us/help/4507701">4507701</a></li><li>for S Mode devices you should see the following line (if not then make sure the device is running 18363 build of windows)<br>SideCarAppInstallPrerequisite got device SMode: True<br>Changing Enforcement state to succeeded as FastAppInstallStatus flighting is turned on<br></li><ol style="list-style:lower-roman;"><li>Entry if the device is not 18363<br>Sidecar
app cannot be installed on a SMode device yet. The device SMode: True<br><br></li></ol></ol><li>&nbsp;Examine the IntuneManagementExtension.log</li><ol style="list-style:lower-alpha;"><li>Check that the user profile was successfully detected (like this example)<br><i>User profile successfully loaded, the user name is AzureAD\IWUser0</i></li><li><i>Check that ExecManager has identified the app and begun the initial detection phase</i><br><br>[Win32App] ExecManager: processing targeted app (name='Notepad plus plus'', id='d2ac4437-c101-428d-9023-2082f95c8b9a') with intent=3 for user session 2<br>[Win32App] ProcessAppWithDependencies starts for d2ac4437-c101-428d-9023-2082f95c8b9a with name Notepad plus plus<br>[Win32App] ===Step=== Start to Present app d2ac4437-c101-428d-9023-2082f95c8b9a]<br><div style="">[[Win32App] ===Step=== Detection rules<br></div>&lt;![LOG[[Win32App] ProcessDetectionRules starts<br></li><li>If the app is not installed yet then it is normal for this detection phase to fail<br><br><i><span>[Win32App] detectionManager SideCarFileDetectionManager got applicationDetectedByCurrentRule: False as system<br></span><span>[Win32App] Completed detectionManager SideCarFileDetectionManager, applicationDetectedByCurrentRule: False</span></i><br></li></ol></ol><h3>Check Applicability</h3></div><div>Once the app “Detection rule” evaluation completes, then the next step is “Check Applicability“. These checks are performed against the rules configured when the app was uploaded<br></div><div><br><span><i>&lt;![LOG[[Win32App] ===Step=== Check applicability]LOG]!&gt;&lt;time=&quot;15:19:04.3383300&quot; date=&quot;11-15-2019&quot; component=&quot;IntuneManagementExtension&quot; context=&quot;&quot; type=&quot;1&quot; thread=&quot;5&quot; file=&quot;&quot;&gt;<br></i></span><div><i>&lt;![LOG[[Win32App] applicationRequirementMetadata RequiredOSArchitecture: 2, client Is64BitOperatingSystem: True, applicability: Applicable.]LOG]!&gt;&lt;time=&quot;15:19:04.3383300&quot; date=&quot;11-15-2019&quot; component=&quot;IntuneManagementExtension&quot; context=&quot;&quot; type=&quot;1&quot; thread=&quot;5&quot; file=&quot;&quot;&gt;<br></i></div><div><i>&lt;![LOG[[Win32App] applicationRequirementMetadata expected version: 10.0.14393, client version: 10.0.19018, applicability: Applicable.]LOG]!&gt;&lt;time=&quot;15:19:04.3539566&quot; date=&quot;11-15-2019&quot; component=&quot;IntuneManagementExtension&quot; context=&quot;&quot; type=&quot;1&quot; thread=&quot;5&quot; file=&quot;&quot;&gt;<br></i></div><div><i>&lt;![LOG[[Win32App] applicationRequirementMetadata.RequiredFreespace is , skip check.]LOG]!&gt;&lt;time=&quot;15:19:04.3539566&quot; date=&quot;11-15-2019&quot; component=&quot;IntuneManagementExtension&quot; context=&quot;&quot; type=&quot;1&quot; thread=&quot;5&quot; file=&quot;&quot;&gt;<br></i></div><div><i>&lt;![LOG[[Win32App] applicationRequirementMetadata.RequiredMemory is , skip check.]LOG]!&gt;&lt;time=&quot;15:19:04.3695808&quot; date=&quot;11-15-2019&quot; component=&quot;IntuneManagementExtension&quot; context=&quot;&quot; type=&quot;1&quot; thread=&quot;5&quot; file=&quot;&quot;&gt;<br></i></div><div><i>&lt;![LOG[[Win32App] applicationRequirementMetadata.RequiredCPUSpeed is , skip check.]LOG]!&gt;&lt;time=&quot;15:19:04.3695808&quot; date=&quot;11-15-2019&quot; component=&quot;IntuneManagementExtension&quot; context=&quot;&quot; type=&quot;1&quot; thread=&quot;5&quot; file=&quot;&quot;&gt;<br></i></div><span><i>&lt;![LOG[[Win32App] applicationRequirementMetadata.MinimumNumberOfProcessors is , skip check.]LOG]!&gt;&lt;time=&quot;15:19:04.3695808&quot; date=&quot;11-15-2019&quot; component=&quot;IntuneManagementExtension&quot; context=&quot;&quot; type=&quot;1&quot; thread=&quot;5&quot; file=&quot;&quot;&gt;</i></span></div><h3><span><i>Content download</i></span></h3><div><span style="font-weight:inherit;">You can expect to see that the Package Content is missing in the cache, hence content starts to download to the path </span><i style="font-weight:inherit;">C:\Program Files (x86)\Microsoft Intune Management Extension\Content\Incoming</i><span style="font-weight:inherit;">.</span><br></div><div><span><i><span style="color:rgb(34, 34, 34);font-family:Verdana, Geneva, sans-serif;font-size:15px;font-style:normal;display:inline !important;"><br></span></i></span></div><div><span><i>[Win32App] ===Step=== Download]LOG]!<br><div style="">&lt;![LOG[[Win32App] Downloading app on session 2. App: d2ac4437-c101-428d-9023-2082f95c8b9a]LOG]!<br></div>&lt;![LOG[Get content info from Intune<br></i></span></div><div><span><i>[Win32App] Content cache miss for app id d2ac4437-c101-428d-9023-2082f95c8b9a, start downloading<br></i></span></div><div><span><i><span>[Win32App DO] start creating a new download job</span></i><br></span></div><div><span><i><span><br></span></i></span></div><div><div style="box-sizing:border-box;">The Intune CDN URL used to download the file is listed. If you suspect any download issue due to network proxy. You can copy the URL and paste download in your browser to troubleshoot.<br style="box-sizing:border-box;"></div><div style="box-sizing:border-box;"><br style="box-sizing:border-box;"></div><div style="box-sizing:border-box;"><i style="box-sizing:border-box;"><span style="box-sizing:border-box;">&lt;![LOG[Get content info from service,ret = {</span><span style="box-sizing:border-box;">&nbsp;&quot;odata.metadata&quot;:&quot;https://fef.msua02.manage.microsoft.com/SideCar/StatelessSideCarGatewayService/$metadata#SideCarGatewaySessions/</span></i></div><br></div><div><b>Content is download initially to folder “Incoming”</b></div><div><span style="font-weight:inherit;">The encrypted file downloads first to folder “Incoming”.&nbsp;This is a temporary download folder for further processing. The extension of the file will be in bin format.</span><br></div><div><br></div><div><i style="box-sizing:border-box;"><span style="box-sizing:border-box;">&lt;![LOG[[Win32App DO] dest path = C:\Program Files (x86)\Microsoft Intune Management Extension\Content\Incoming\d2ac4437-c101-428d-9023-2082f95c8b9a_1.bin]LOG]</span></i><br></div><div><br></div><div><b>“Incoming” folder to “Staging folder”</b></div><div>The download file is verified and decrypted and then moves from “Incoming” folder to “Staging folder”. In Staging Folder, the downloaded file will be in Zip format.</div><div><br></div><div><span><i>&lt;![LOG[[Win32App] Starts verifying encrypted hash]<br></i></span><div><i>&lt;![LOG[[Win32App] hmac validation is pass.]<br></i></div><div><i>&lt;![LOG[[Win32App] file hash validation pass, starts decrypting]<br></i></div><div><i>&lt;![LOG[[Win32App] Decryption is done successfully.]<br></i></div><div><i>&lt;![LOG[[Win32App] DO mode, content is decrypted.]<br></i></div><span><i>&lt;![LOG[[Win32App DO] DO download and decryption is successfully done</i></span><br></div><div><span><i>&lt;![LOG[[Win32App] Start unzipping.]<br></i><div style=""><i>&lt;![LOG[[Win32App] Unzipping file on session 2 from C:\Program Files (x86)\Microsoft Intune Management Extension\Content\Staging\<br></i></div><i>&lt;![LOG[Cleaning up staging content C:\Program Files (x86)\Microsoft Intune Management Extension\Content\Staging</i><br></span></div><div><br></div><h3>Application Installation</h3><div>This stage is the installation stage. So you can jump to this stage if you have no issues with content download etc<br></div><div><span style="color:rgb(34, 34, 34);font-family:Verdana, Geneva, sans-serif;font-size:15px;display:inline !important;"><br></span></div><div><span><i>&lt;![LOG[[Win32App] ===Step=== Execute retry 0]LOG]!&gt;<br></i></span><div><i>&lt;![LOG[npp.7.8.1.Installer.x64.exe /S]LOG]!&gt;<br></i></div><div><i>&lt;![LOG[[Win32App] SetCurrentDirectory: C:\WINDOWS\IMECache\d2ac4437-c101-428d-9023-2082f95c8b9a_1]LOG]!&gt;<br></i></div><span><i>&lt;![LOG[[Win32App] Launch Win32AppInstaller in machine session</i></span><br></div><div><ol><li>Identify that the installation was started and gather the AppID. The app should have an entry similar to the following:<br>[Win32App] ExecManager: processing targeted app (name='Notepad Plus Plus', id='7710fc3e-fbba-4793-b8b7-b7ebf9026cb9')&nbsp;</li><ol style="list-style:lower-alpha;"><ol style="list-style:lower-roman;"><li>For S Mode devices, if you see the following line, then the customer needs to deploy a supplemental S mode policy, see&nbsp;<a href="https://internal.support.services.microsoft.com/en-US/help/4077898">https://internal.support.services.microsoft.com/en-US/help/4077898</a>&nbsp;for an example of how to create this policy<br><br>[Win32App] AppPolicy 7710fc3e-fbba-4793-b8b7-b7ebf9026cb9 Execution failed for unlock Win10 S policy error, Zero valid Unlock Win 10 S policies found<br><br></li></ol><li>Trigger the device to attempt re-installation</li><ol style="list-style:lower-roman;"><li style="margin-bottom:0.1em;margin-top:8px;">Delete these two registry keys, using the AppID GUID from the log in step 1:<ol style="margin:0.3em 0px 0px 3.2em;"><li style="margin-bottom:0.1em;margin-top:8px;">HKLM\SOFTWARE\Microsoft\IntuneManagementExtension\Apps\&lt;AppID&gt;</li><li style="margin-bottom:0.1em;margin-top:8px;">HKLM\SOFTWARE\Microsoft\IntuneManagementExtension\Win32Apps\&lt;GUID specific to tenant&gt;\&lt;AppID&gt;</li></ol></li><li style="margin-bottom:0.1em;margin-top:8px;">Restart the Microsoft Intune Management Extension service.</li></ol></ol><li style="margin-bottom:0.1em;margin-top:8px;">If the EXE/MSI fails at this stage you will see lines similar to the following<br><br><i><span>&lt;![LOG[[Win32App] lastWin32Error 4551 after CreateProcess]LOG]!&gt;<br></span><span>&lt;![LOG[[Win32App] lastHResult -2147020345 after CreateProcess]LOG]</span></i><br></li><ol style="list-style:lower-alpha;"><li style="margin-bottom:0.1em;margin-top:8px;">In this case the last HResult shows an error code returned by Windows</li></ol><li style="box-sizing:border-box;margin-bottom:0.1em;margin-top:8px;">You can also check for the debug log at&nbsp;<span style="box-sizing:border-box;">%systemroot%\system32\config\systemprofile\AppData\Local\mdm</span></li><ol style="list-style:lower-alpha;"><li style="box-sizing:border-box;margin-bottom:0.1em;margin-top:8px;"><span style="box-sizing:border-box;">The format will be {&lt;AppID GUID&gt;}.log. In some cases, modifications to the MSI installer will cause the log not to be created. In these cases, the easiest way to generate an MSI log is to append /L*V &lt;logfilename&gt; to the app configuration in the Intune console. This will enable verbose logging to the log file specified (make sure the folder path exists first).</span></li><li style="box-sizing:border-box;margin-bottom:0.1em;margin-top:8px;">Interpreting MSI logs<span style="box-sizing:border-box;">&nbsp;</span></li><ol style="box-sizing:border-box;padding-left:40px;list-style:lower-alpha;"><li style="box-sizing:border-box;margin-bottom:0.1em;margin-top:8px;">In general, most MSI installations can be narrowed down by searching the log for the first occurrence of<span style="box-sizing:border-box;">&nbsp;</span><span style="box-sizing:border-box;">Return value 3</span><span style="box-sizing:border-box;">. This error indicates a fatal error occurred that prevented the installer from working correctly. Examine the lines immediately above this entry to determine what the installer was doing at this point. See this blog post for more information:</span><span style="box-sizing:border-box;">&nbsp;</span><a href="https://blogs.technet.microsoft.com/richard_macdonald/2007/04/02/how-to-interpret-windows-installer-logs/" style="box-sizing:border-box;text-decoration:underline;cursor:pointer;">https://blogs.technet.microsoft.com/richard_macdonald/2007/04/02/how-to-interpret-windows-installer-logs/</a></li></ol></ol></ol></div><h3>Detection Rules after Application Installation</h3><div>Post application installation, the Intune client evaluates application detection rules as defined when uploading the package</div><div><br><ol><li style="margin-bottom:0.1em;margin-top:8px;"><span style="font-weight:inherit;">If installation fails, then check the IntuneManagementExtension.log for the following line:</span><br></li><li style="margin-bottom:0.1em;margin-top:8px;">[Win32App] Completed detectionManager SideCarFileDetectionManager, applicationDetectedByCurrentRule: False<br></li><ol style="list-style:lower-alpha;"><li style="margin-bottom:0.1em;margin-top:8px;">If Detection shows as False, then either the package did not install or the detection rule is not configured correctly</li><ol style="list-style:lower-roman;"><li style="margin-bottom:0.1em;margin-top:8px;">If you see the following line then most likely the package is not configured to install silently<br><br>[Win32App] Installation is timeout<br></li><li style="margin-bottom:0.1em;margin-top:8px;">In that case, the customer will need to contact the application vendor to determine the correct installation parameters to use for a silent install (or have them provide an example how to deploy via GPO or SCCM)</li></ol><li style="margin-bottom:0.1em;margin-top:8px;">A successful detection rule by Intune will show:<br><br>[Win32App] Completed detectionManager SideCarFileDetectionManager, applicationDetectedByCurrentRule: True<br></li><ol style="list-style:lower-roman;"><li style="margin-bottom:0.1em;margin-top:8px;">If the installation shows as success but the app is not installed correctly then the detection rule may not be sufficient enough to spot problems (for instance they only specified a folder exists)</li></ol></ol></ol><h3><span style="font-weight:inherit;">Use Process Monitor</span></h3><span style="font-weight:inherit;">Process Monitor (also known as ProcMon) is a debugging tool that will allow you to see the process execution flow of the MSI installer. A full explanation is outside the scope of this document - see</span><span style="font-weight:inherit;">&nbsp;</span><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon" style="font-weight:inherit;">https://docs.microsoft.com/en-us/sysinternals/downloads/procmon</a><span style="font-weight:inherit;">&nbsp;</span><span style="font-weight:inherit;">for more information. It is recommended to gather a ProcMon dump before engaging escalation resources.</span><br></div></div><div>(This section intentionally left blank)</div>