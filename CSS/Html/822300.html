<header><h1>FRS Encounters &quot;ERROR_SHARING_VIOLATION&quot; Errors When It Tries to Replicate Data That Is Still in Use</h1></header><div class='kb-symptoms-section section'>On Distributed File System (DFS) replica members or on domain controllers that are hosting a SYSVOL replica set, you may find an event that is similar to the following in the File Replication service (FRS) area of Event Viewer:<div class='indent'><br></div></div><div class='kb-cause-section section'>This issue may occur for either of the following reasons: <br> <ul class='sbody-free_list'><li>FRS cannot install a file at the destination location because it encountered a sharing violation.</li><li>FRS cannot generate the staging file to be replicated because FRS encountered a sharing violation.</li></ul> A sharing violation can occur if other sources have open handles to the file to be replicated. Typically, programs that can instigate sharing violations are: <br> <ul class='sbody-free_list'><li>Antivirus programs</li><li>Disk optimization tools</li><li> File system policies that repeatedly apply access control list (ACL) changes</li><li>A user profile or personal data that is constantly in use that is placed on the replica set</li><li>Any other type of data that is held open for long periods by an end user, a program, or a process</li></ul></div><div class='kb-resolution-section section'>To resolve this issue, use one of the following methods.<h3 class='sbody-h3'>Method 1: Use the Install Override Feature</h3>You can use the Install Override feature in Windows Server 2003 to rename the locked file. This allows FRS to replicate the file. <br> <span> For additional information about how to turn on this feature and use it, click the following article number to view the article in the Microsoft Knowledge Base: <div class='indent'><a id='kb-link-1' href='/EN-US/help/816493'>816493 </a> How   to Configure the File Replication Service to Allow Fewer Sharing Violations   That Block Replication <br></div></span><h3 class='sbody-h3'>Method 2: Identify the Locked Files and Release the Handles</h3>If you are not using Windows Server 2003 or if you do not want to turn on the Install Override feature, the only way to prevent the issue from occurring is to release the handles of the locked files. However, because the 13573 event is only reported for the number of times per hour that is specified in the Max Sharing Violation Event setting, files in the same situation may not have been reported yet. Therefore, to release the handles of all locked files, you must first identify the complete set of open files.<br><br> To track the problem in Windows 2000, download and install the fix that is documented in the following Microsoft Knowledge Base article:<span><div class='indent'><a id='kb-link-2' href='/en-us/help/815473'>815473 </a> File Replication Service Does Not Log Errors on Sharing Violations<br><br></div></span>With this hotfix, you can set the options to control the logging of event 13573. This hotfix does not contain the &quot;Install Override Feature&quot; that Windows Server 2003 has.<br><br> To identify the complete set of files in the INSTALL_RETRY state, run the <span class='text-base'>ntfrsutl.exe inlog</span> command, and then look for all file entries with a state that is marked IBCO_INSTALL_RETRY. To find out the full path of the file that is being held, follow these steps: <br> <ol class='sbody-num_list'><li>Find out the file GUID from either the description of the event ID or from the inlog data that is retrieved. The inlog data will look similar to the following example:<div class='indent'>Table Type : Inbound Log Table for DOMAIN SYSTEM VOLUME (SYSVOL SHARE) (1)<br>Flags : 010000c6 Flags [VVAct Content Retry InstallInc CmpresStage ]<br>IFlags : 00000001 Flags [IFlagVVRetireExec ]<br>State : 0000000d CO STATE: IBCO_INSTALL_RETRY<br>FileGuid : 36a42f7e-b3a9-494c-ae0cef2929771d6e<br>EventTime : Thu May 29, 2003 19:13:40<br>FileName : <strong class='sbody-strong'>Filename</strong>.txt</div><br></li><li>Convert the file GUID to a full path by using available tools or by parsing data from the IDTable entries. You can extract this data by using the <span class='text-base'>ntfrsutl idtable</span> command. </li></ol><h3 class='sbody-h3'>Find the Path of a File That Is Being Held Open</h3>To find the path of a file that is being held open, follow these steps: <br> <ol class='sbody-num_list'><li>Obtain FRSDiag.exe, and then run it. To obtain FRSDiag.exe, visit the following Microsoft Web site:<div class='indent'><a id='kb-link-3' href='http://www.microsoft.com/download/details.aspx?familyid=43cb658e-8553-4de7-811a-562563eb5ebf&displaylang=en' target='_self'>http://www.microsoft.com/download/details.aspx?FamilyId=43CB658E-8553-4DE7-811A-562563EB5EBF&displaylang=en</a></div></li><li>Type the name of the target server that contains the error, or click <strong class='uiterm'>Browse</strong>, and then locate the server.</li><li>On the <strong class='uiterm'>Selections</strong> menu, click<br><strong class='uiterm'>Uncheck All</strong>.</li><li>Click to select the <strong class='uiterm'>IDTable Parser</strong> check box.</li><li>Click <strong class='uiterm'>Go</strong>.<br><br> A file that is named FRSDiag.txt under the %USERPROFILE%\Desktop\Logs folder is created.</li><li>Look up the file GUID and the file&#39;s date in FRSDiag.txt. </li></ol></div><div class='kb-resolution-section section'>The following is an alternative method for finding the path of a file that is being held open. <br> <ol class='sbody-num_list'><li>Obtain Guid2f.cmd from \\luizm-wrk\Guid2f.</li><li>Run the <span class='text-base'>guid2f <strong class='sbody-strong'>FileGuid</strong></span> command, where <strong class='sbody-strong'>FileGuid</strong> is the GUID of the file that you are investigating. For example:<div class='indent'><span class='text-base'>guid2f 36a42f7e-b3a9-494c-ae0cef2929771d6e</span></div><br><br> This command returns the file’s path.</li></ol></div><div>After you determine which file is being held open, you can use Process Explorer from Sysinternals to find out which process has the file locked. To download Process Explorer, visit the following Sysinternals Web site:<div class='indent'><a id='kb-link-4' href='http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx' target='_self'>http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx</a></div>To use Process Explorer, follow these steps: <br> <ol class='sbody-num_list'><li>Start Process Explorer, and then wait until all the process information is loaded.</li><li>On the <strong class='uiterm'>Find</strong> menu, click<br><strong class='uiterm'>Find Handle or DLL</strong>.</li><li> Type the path of the file (for example, type<br><span class='sbody-userinput'>scripts\filename.txt</span>), and then click<br><strong class='uiterm'>Search</strong>.</li><li>After the process is found, double-click it, and then verify that this is the name of the file that is being held open.</li><li>End the process if you want to.</li></ol><span> Microsoft provides third-party contact information to help you find technical support. This contact information may change without notice. Microsoft does not guarantee the accuracy of this third-party contact information. <br> </span><br><br><span> The third-party products that are discussed in this article are manufactured by companies that are independent of Microsoft. Microsoft makes no warranty, implied or otherwise, regarding the performance or reliability of these products. <br> </span><br><br> If you determine that keeping this file open is the expected behavior for your environment, either disable logging of this event, or increase or decrease the number of reported events per hour. To do this, follow these steps to edit the designated registry subkeys.<br><br><span><span class='text-base'>Important</span> This section, method, or task contains steps that tell you how to modify the registry. However, serious problems might occur if you modify the registry incorrectly. Therefore, make sure that you follow these steps carefully. For added protection, back up the registry before you modify it. Then, you can restore the registry if a problem occurs. For more information about how to back up and restore the registry, click the following article number to view the article in the Microsoft Knowledge Base: <div class='indent'><a id='kb-link-5' href='/en-us/help/322756'>322756 </a> How to back up and restore the registry in Windows</div></span><ol class='sbody-num_list'><li>Start Registry Editor.</li><li>Locate and then modify the following subkey:<div class='indent'><div class='indent'><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NtFrs\Parameters</strong></div><br> Value Name: Enable Sharing Violation Logging<br> Value Type: DWORD<br> Value Range: 0 or 1<br> Default value: 0<br> Description: Toggles sharing violation logging on or off.</div></li><li>Locate and then modify the following subkey:<div class='indent'><div class='indent'><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NtFrs\Parameters</strong></div><br> Value Name: Max Sharing Violation Event<br> Value Type: DWORD<br> Value Range: 1 to 2000<br> Default value: 10<br> Description: Determines the maximum number of reported sharing violation events for each time period.</div></li><li>Locate and then modify the following subkey:<div class='indent'><div class='indent'><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NtFrs\Parameters</strong></div><br> Value Name: Sharing Violation Retry Count<br> Value Type: DWORD<br> Value Range: 1 to 2000<br> Default value: 10<br> Description: Determines the frequency of sharing violation events for each change order. For example, for a value of 10, report 1 of every 10 sharing violations that are encountered by the change order.</div></li></ol></div><div class='kb-resolution-section section'>The following sharing violation logging strategy is implemented. Constant SV_REPORT_TIME_RANGE is used to divide the time into discrete &quot;logging cycles.&quot; During each logging cycle, the total number of logged events is tracked. When the number of logged sharing violation events during a logging cycle reaches a certain limit (this number is specified in the Max Sharing Violation Event registry value), logging of sharing violation events is stopped, and logging does not restart until the next logging cycle. For each change order, the number of logged sharing violations that are encountered by the change order is tracked. When this number reaches a limit that is specified in the Sharing Violation Retry Count registry key value, a sharing violation event per change order is logged. If the current logging cycle still has room for reporting, the sharing violation is logged, even though the change order has not been retried the number of times that is specified in the Sharing Violation Retry Count registry key value. This is done to give the user as much information as possible, without over-reporting, about all the files that are stuck in this mode.</div><div class='kb-references-section section'><span> For additional information, click the following article numbers to view the articles in the Microsoft Knowledge Base: <div class='indent'><a id='kb-link-6' href='/EN-US/help/284947'>284947 </a> Antivirus Programs May Modify Security Descriptors and Cause Excessive Replication of FRS Data in Sysvol and DFS</div></span><span><div class='indent'><a id='kb-link-7' href='/en-us/help/279156'>279156 </a> The Effects of Setting the File System Policy on a Disk Drive or Folder Replicated by the File Replication Service</div></span><span><div class='indent'><a id='kb-link-8' href='/en-us/help/815263'>815263 </a> Antivirus, Backup, and Disk Optimization Programs That Are Compatible with the File Replication Service</div></span></div><div class='kb-securedata-section section'>SHARING_VIOLATION STATUS_SHARING_VIOLATION Sharing Violation</div>