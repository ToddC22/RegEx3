<header><h1>INFO: Working with the FILETIME Structure</h1></header><div class='kb-summary-section section'>A file time represents the specific date and time at which a given file was created, last accessed, or last written to. A file time is stored in a FILETIME structure. This structure is used with various Win32 API calls.<br></div><div class='kb-moreinformation-section section'>The FILETIME structure represents the number of 100-nanosecond intervals since January 1, 1601. The structure consists of two 32-bit values that combine to form a single 64-bit value.<br><div class='sbody-code'><pre><code>   typedef struct _FILETIME {<br>     DWORD dwLowDateTime;<br>     DWORD dwHighDateTime;<br>   } FILETIME;<br></code></pre></div>Note that the FILETIME structure is based on 100-nanosecond intervals. It is helpful to define the following symbols when working with file times. For example:<br><br><div class='sbody-code'><pre><code>   #define _SECOND ((int64) 10000000)<br>   #define _MINUTE (60 * _SECOND)<br>   #define _HOUR   (60 * _MINUTE)<br>   #define _DAY    (24 * _HOUR)<br></code></pre></div><h3 class='sbody-h3'>Performing Arithmetics with File Times</h3>It is often necessary to perform a simple arithmetic on file times. For example, you might need to know when a file is 30 days old. To perform an arithmetic on a file time, you need to convert the FILETIME to a quadword (a 64-bit integer), perform the arithmetic, and then convert the result back to a FILETIME.<br><br><br>Assuming ft is a FILETIME structure containing the creation time of a file, the following sample code adds 30 days to the time:<br><div class='sbody-code'><pre><code>   ULONGLONG qwResult;<br><br>   // Copy the time into a quadword.<br>   qwResult = (((ULONGLONG) ft.dwHighDateTime) &lt;&lt; 32) + ft.dwLowDateTime;<br><br>   // Add 30 days.<br>   qwResult += 30 * _DAY;<br><br>   // Copy the result back into the FILETIME structure.<br>   ft.dwLowDateTime  = (DWORD) (qwResult &amp; 0xFFFFFFFF );<br>   ft.dwHighDateTime = (DWORD) (qwResult &gt;&gt; 32 );<br></code></pre></div><h3 class='sbody-h3'>Setting File Times</h3>You can set the file times for a file by using the SetFileTime() function.<br><div class='sbody-code'><pre><code>   BOOL SetFileTime(<br>     HANDLE hFile,                     // Handle to the file.<br>     CONST FILETIME *lpCreationTime,   // Time the file was created.<br>     CONST FILETIME *lpLastAccessTime, // Time the file was last accessed.<br>     CONST FILETIME *lpLastWriteTime   // Time the file was last<br>                                       // written to.<br>   );<br></code></pre></div>This function lets you modify creation, last access, and last write times without changing the content of the file. To use this function, you must have a handle to the open file. This file handle can be obtained from a call to CreateFile() or OpenFile(). The file must be opened with GENERIC_WRITE access. After the file times have been set, you should release the file handle through a call to CloseHandle().<br><br><br>Assuming szFilename is a valid filename and ft is a FILETIME structure, the following sample code sets the creation date for the file to the time contained in ft:<br><br><div class='sbody-code'><pre><code>   BOOL bResult;<br>   HANDLE hFile = CreateFile( szFilename,<br>      GENERIC_WRITE, // The file must be opened with write access.<br>      FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, 0, NULL );<br><br>   if (hFile != INVALID_HANDLE_VALUE) {<br>      bResult = SetFileTime( hFile, &amp;ft, NULL, NULL );<br>      CloseHandle(hFile);<br>   }<br></code></pre></div><h3 class='sbody-h3'>Displaying File Times</h3>The file time is based on coordinated universal time (UTC). UTC-based time is loosely defined as the current date and time of day in Greenwich, England. You will most likely want to display the file time with respect to the local time (that is, the date and time of day for your time zone). To do this, you can use FileTimeToLocalFileTime() as follows:<br><br><div class='sbody-code'><pre><code>   BOOL FileTimeToLocalFileTime(<br>     CONST FILETIME *lpFileTime,  // Pointer to UTC file time to convert.<br>     LPFILETIME lpLocalFileTime   // Pointer to converted file time.<br>   );</code></pre></div>Note that this function uses the current settings for the time zone and daylight saving time. Therefore, if it is daylight saving time, this function will take daylight saving time into account, even if the time you are converting is in standard time.<br><br><br>To display the file time in a meaningful way, you first need to convert it to a system time using FileTimeToSystemTime() as follows:<br><br><div class='sbody-code'><pre><code>   BOOL FileTimeToSystemTime(<br>     CONST FILETIME *lpFileTime, // Pointer to file time to convert.<br>     LPSYSTEMTIME lpSystemTime   // Pointer to structure to receive<br>   );                            // system time.<br></code></pre></div>The SYSTEMTIME structure represents a date and time using individual members for the month, day, year, weekday, hour, minute, second, and millisecond.<br><br><br>It is also preferable to display the date and time in a format consistent with the current locale selected for the system. You can do this by using GetDateFormat() and GetTimeFormat() as follows:<br><br><div class='sbody-code'><pre><code>   int GetDateFormat(<br>     LCID Locale,              // Locale for which date is to be formatted.<br>     DWORD dwFlags,            // Flags specifying function options.<br>     CONST SYSTEMTIME *lpDate, // Date to be formatted.<br>     LPCTSTR lpFormat,         // Date format string.<br>     LPTSTR lpDateStr,         // Buffer for storing formatted string.<br>     int cchDate               // Size of buffer.<br>   );<br><br>   int GetTimeFormat(<br>     LCID Locale,              // Locale for which time is to be formatted.<br>     DWORD dwFlags,            // Flags specifying function options.<br>     CONST SYSTEMTIME *lpTime, // Time to be formatted.<br>     LPCTSTR lpFormat,         // Time format string.<br>     LPTSTR lpTimeStr,         // Buffer for storing formatted string.<br>     int cchTime               // Size of buffer.<br>   );<br></code></pre></div>By passing LOCALE_USER_DEFAULT as the first parameter to these functions, you tell them to format the passed date/time according to the default format for the current locale. In this case, you can pass NULL for the lpFormat parameters.<br><br><br>Assuming ft is a FILETIME structure containing a UTC value, the following sample code prints the date stored in ft:<br><br><div class='sbody-code'><pre><code>   SYSTEMTIME st;<br>   char szLocalDate[255], szLocalTime[255];<br><br>   FileTimeToLocalFileTime( &amp;ft, &amp;ft );<br>   FileTimeToSystemTime( &amp;ft, &amp;st );<br>   GetDateFormat( LOCALE_USER_DEFAULT, DATE_LONGDATE, &amp;st, NULL,<br>     szLocalDate, 255 );<br>   GetTimeFormat( LOCALE_USER_DEFAULT, 0, &amp;st, NULL, szLocalTime, 255 );<br>   printf( &quot;%s %s\n&quot;, szLocalDate, szLocalTime );<br></code></pre></div></div><div class='kb-textlegacy-section section'>DOC INFO: DOC ID:26194 26194 KernelBaseWin2000 JAN-10-2000 kbsweptWINXP_SDK v-kargif Dec-23-2001 Author: jruss (1998-06-30T18:30:00) Edit Reviewer: kategl (1998-07-01T16:14:00) Tech Reviewer: jclark (1998-07-01T16:14:00)<br></div>