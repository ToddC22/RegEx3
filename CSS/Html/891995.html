<header><h1>How to poll for object attribute changes in Active Directory on Windows 2000 and Windows Server 2003</h1></header><div class='kb-notice-section section'>Template: zGeneric Info Article</div><div class='kb-notice-section section'><div internal-content-body=""><div class="internal-content"><div class="bold internal-content-body-title spacer-12-bottom">Microsoft Internal Support Information</div><div class="row"><div class="col-xs-24 internal-content-body-content"><p>BUG #: <a href='http://bugcheck/bugs/ContentMaintenance/32024.asp' title='Link only available for Microsoft corporate network users' target='_blank'>32024 (Content Maintenance)</a></p></div></div></div></div></div><div class='kb-summary-section section'><div class='indent'><span class='sbody-italic'>There are two methods that you can use to develop programs that poll   the Active Directory  Directory service for object attribute  changes. This  article  describes  these  two methods.</span></div></div><div class='kb-summary-section section'>Some database monitoring programs are designed to maintain consistency between object data that is stored in the Active Directory directory service and object data that is stored in another database. The other database can be another Active Directory database, a Microsoft SQL Server database, or some other directory service database. The database monitoring program must track changes to Active Directory object data, such as updates or deletions, and replicate those changes back to the other database.<br> <br><br>Database monitoring programs can track changes in Active Directory with either of the following techniques:<br> <ul class='sbody-free_list'><li>Change notification registration</li><li>Polling</li></ul>This article describes the two methods that are available for polling Active Directory. This article does not describe how to use change notification registration for polling Active Directory changes.</div><div class='kb-moreinformation-section section'>You can use the following two polling methods to monitor changes in Active Directory:<br> <ul class='sbody-free_list'><li>Use the Active Directory directory synchronization (DirSync) control.</li><li>Use Update Sequence Number (USN) queries that use the uSNChanged attribute.</li></ul><h3 class='sbody-h3'>Method 1: The DirSync control</h3> The DirSync control is a Lightweight Directory Access Protocol (LDAP) server extension that enables a program to search an Active Directory partition for objects that have changed. When a program performs a DirSync search, the program creates a cookie that identifies the directory state at the time of an earlier DirSync query. With the first search, the program creates an empty cookie and Active Directory returns all objects that satisfy the query. Active Directory also returns an updated cookie that can be passed to the next search to obtain changes that are made since the first search. This process is repeated for each search. <h4 class='sbody-h4'>DirSync control behavior and limitations</h4> The DirSync control searches are performed against the whole Active Directory partition or naming context. By default, Active Directory domain controllers host the following three partitions: <br> <ul class='sbody-free_list'><li>Domain container</li><li>Configuration container</li><li>Schema container</li></ul>A DirSync control search returns all the changes that are made to an Active Directory object regardless of the permissions that are set on the object. Additionally, a DirSync control search that is run with the appropriate permissions returns deleted objects. Deleted objects are also known as tombstones. <br><br>Although the DirSync control is powerful and efficient, it has two limitations. The first limitation is that the control must run by using a user account that has the Replicating Directory Changes permission on the domain naming context. By default, the Administrator user account has this permission. However, we do not recommend that you use the Administrator account to run your DirSync control program. Instead, we recommend that the Replicating Directory Changes permission be granted to a typical user account or group. Therefore, you can configure permissions that are specific and limited to the DirSync control program. <br><br>To grant the Replicating Directory Changes permission, you must modify the permissions on the directory partition object. <br> <span> For additional information about how to grant the Replicating Directory Changes permission, click the following article number to view the article in the Microsoft Knowledge Base: <div class='indent'><a id='kb-link-1' href='/en-us/help/303972'>303972 </a> How to Grant the &quot;Replicating Directory Changes&quot; Permission for the Microsoft Metadirectory Services ADMA Service Account<br><br></div></span>The second DirSync control limitation is that the DirSync control search cannot be confined to a specific area of Active Directory. Because all changes made to an Active Directory partition are returned from a DirSync control search, access to object data that is not wanted may occur. <h4 class='sbody-h4'>Microsoft Windows 2000 and the DirSync control</h4> Microsoft Windows 2000 Active Directory supports only one mode when you use the DirSync control. This mode is named Per Partition and has the following characteristics: <br> <ul class='sbody-free_list'><li>All changes to Active Directory objects are returned regardless of the permissions on those objects.</li><li>Deletions are returned as tombstone objects. This makes it possible for programs to track deletions.</li><li>Only the Replicating Directory Changes permission on the Active Directory partition is required.</li></ul><h4 class='sbody-h4'>Microsoft Windows Server 2003 and the DirSync control</h4> By default, Microsoft Windows Server 2003 Active Directory supports Per Partition mode. Additionally, Windows Server 2003 supports another mode that is named Per Object mode. <br><br>You can specify Per Object mode when you develop a program by using a flag that is passed in to the LDAP search function. If your program specifies the Per Object mode, the Replicating Directory Changes permission is not required. <br><br><span class='text-base'>Note</span> An Active Directory administrator cannot specify whether a program can use Per Partition mode or Per Object mode. The mode is determined by the LDAP search function that is coded in the program. <h3 class='sbody-h3'>Method 2: USN queries using the uSNChanged attribute</h3> When a domain controller modifies an object, it increments the highestCommittedUSN attribute value. When the increment occurs, the domain controller also sets the uSNChanged attribute for that object to the new value. In this process, each change to an object in Active Directory is stamped with a unique and monotonic value. Therefore, a program can obtain the most recent changes to an object on a domain controller by finding the object that has the largest uSNChanged attribute value. Similarly, the second largest uSNChanged attribute value corresponds to the second most recently changed object, and this process is repeated. <h4 class='sbody-h4'>Monitoring USN changes behavior</h4> The uSNChanged attribute is not replicated. Therefore, when you read a uSNChanged attribute for an object on two different domain controllers, the uSNChanged attribute typically returns values that are different.<br> <br><br>To maintain consistency by using the uSNChanged attribute, a program must first perform a full synchronization with Active Directory, and then determine the highest uSNChanged attribute value for the objects that are returned. When the program polls for changes, it can search Active Directory for all objects whose uSNChanged attribute value is larger than the value that was read earlier. <h4 class='sbody-h4'>Monitoring USN changes benefits and permissions</h4> There are two benefits with using the uSNChanged attribute to poll for Active Directory object changes. The first benefit is that an uSNChanged attribute value search can be confined to a specific area of Active Directory. For example, unlike the DirSync control, object change searches can be limited to a specific subtree in the directory. <br><br>The second benefit is that you do not have to configure special user account permissions or group permissions for the program. The program only requires List and Read permissions for every container and leaf object in the subtree that is searched. <br><br><span class='text-base'>Note</span> If you use the DirSync control method, you must configure the user account or group that has Read Property and List permissions on the Deleted Objects container to return Active Directory objects that have been deleted. <br><br>If your program does not have permissions to access an object, object data is not returned by the program. Additionally, the uSNChanged attribute is stored by using a per-object method, instead of a per-attribute method. Because of this, all attributes that are associated with the object are returned instead of only modified attributes. <br><br>Whether you use the DirSync control method or the USN change method, programs that search Active Directory only return the objects and attributes where they have the appropriate permissions. For example, objects that are in the Deleted Objects container, may not be returned in the search. For example, a tombstones is an object that might be in the Deleted Objects container. By default, the Deleted Objects container can only be accessed by the System and Administrator accounts. <h3 class='sbody-h3'>Object deletion detection</h3> To detect object deletions, a program must either perform a periodic full synchronization of Active Directory, or it must separately search the Deleted Objects container and remove from its own database the objects that have been deleted in Active Directory. <br><br>For more information about tracking changes in Active Directory, visit the following Microsoft Web site:<div class='indent'><a id='kb-link-2' href='http://msdn2.microsoft.com/en-us/library/ms677974.aspx' target='_self'>http://msdn2.microsoft.com/en-us/library/ms677974.aspx</a></div> For more information about polling for changes using the DirSync control, visit the following Microsoft Web site: <div class='indent'><a id='kb-link-3' href='http://msdn2.microsoft.com/en-us/library/ms677626.aspx' target='_self'>http://msdn2.microsoft.com/en-us/library/ms677626.aspx</a></div> For more information about polling for changes using the uSNChanged attribute, visit the following Microsoft Web site: <div class='indent'><a id='kb-link-4' href='http://msdn2.microsoft.com/en-us/library/ms677627.aspx' target='_self'>http://msdn2.microsoft.com/en-us/library/ms677627.aspx</a></div> For more information about polling Active Directory for changes, view the help information that is included with the <span class='sbody-italic'>Microsoft Platform Software Development Kit (SDK)</span>. </div><div class='kb-securedata-section section'>Content Maintenance: 32024 </div><div class='kb-securedata-section section'>Author: jonsteph<br>Writer: v-matp<br>Tech Reviewer: v-dahedm<br> Editor: v-cgold</div>