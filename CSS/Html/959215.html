<header><h1>AD LDS service start fails with error &quot;setup could not start the service...&quot; + error code 8007041d</h1></header><div class='kb-idea-section section'><span class='text-base'>Source: </span>Microsoft Support</div><div class='kb-idea-section section'>RAPID PUBLISHING ARTICLES PROVIDE INFORMATION DIRECTLY FROM WITHIN THE MICROSOFT SUPPORT ORGANIZATION.  THE INFORMATION CONTAINED HEREIN IS CREATED IN RESPONSE TO EMERGING OR UNIQUE TOPICS, OR IS INTENDED SUPPLEMENT OTHER KNOWLEDGE BASE INFORMATION.</div><div class='kb-symptoms-section section'>&#160;<br><h3 class='sbody-h3'>Windows Server 2008 R2</h3>After you start AD LDS service for a particular instance, you may receive the following warning message in the event logs. If your AD LDS instance uses UDP for communication, this issue will block LDAP traffic over UDP on the port that is listed in the event message. However, unlike in Windows Server 2008, this issue will not prevent the service from starting, and LDAP traffic over TCP will still flow through this port.<h3 class='sbody-h3'>Windows Server 2008</h3>After you successfully install AD LDS, you may be unable to start the service, and an error message may be displayed.  You may also receive following error message in the event logs: </div><div class='kb-cause-section section'>After security update 951746 is installed on Windows Server 2008 R2-based and Windows Server 2008-based computers, this issue occurs because the DNS server’s method of port allocation changes, and this change could prevent AD LDS from obtaining the port that it requires to function correctly. <br><br><br>By default, after security update 951746 is installed, the DNS server randomly allocates 2,500 UDP ports in the ephemeral port range. A conflict may occur if one of these randomly allocated ports is a port that an AD LDS instance has to use. <br><br><br>Because these ports are randomly allocated, these failures can be intermittent and are likely to occur in the following scenarios:<ul class='sbody-free_list'><li><span class='text-base'>Windows Server 2008 and Windows Server 2008 R2</span>: The AD LDS service is stopped during the installation of a DNS server that has  security update 951746 installed or during the installation of the update itself, and then a restart of the AD LDS service is tried. As long as the AD LDS service is in a stopped state, the DNS service can randomly allocate ports that the instances are using. </li><li><span class='text-base'>Windows Server 2008 and Windows Server 2008 R2</span>: AD LDS and DNS server that has security update 951746 installed are running on a server that is restarted. As the system restarts, the DNS service will start before AD LDS instance services, and the DNS service might allocate ports that AD LDS instances are using.</li><li><span class='text-base'>Windows Server 2008 only</span>: An AD LDS instance is installed after security update 951746 is installed, and the AD LDS instance tries to use a port that was randomly allocated by DNS. The service startup fails and logs an error message in the event logs.<br><br><br>Unlike Windows Server 2008, in Windows Server 2008 R2, if the port that was selected for a new AD LDS instance is not available for use (And this includes the case in which DNS allocates the port), AD LDS setup prevents the user from using the port and blocks the user from proceeding with installation. In this scenario, the user receives the following error message:<div class='sbody-error'>The LDAP port you have chosen is in use. Type the number of an unused LDAP port.</div></li></ul> <br>For Windows Server 2008 and Windows Server 2008 R2, if DNS service is installed after an AD LDS instance was installed, and the AD LDS service is running, DNS will not grab ports that are currently being used. <br><br></div><div class='kb-workaround-section section'>To work around this issue for Windows Server 2008 R2 and for Windows Server 2008, follow these steps: <br><ol class='sbody-num_list'><li>Find the LDAP and SSL ports that are being used by the AD LDS instances. Because, the port failures can affect all AD LDS instances intermittently, we recommend that users reserve all ports that are used by every AD LDS instance, not just those instances that are currently experiencing a failure, to avoid future failures. To do this, follow these steps: <ol class='sbody-alpha_list'><li>Open a command prompt, type the following command, and then press ENTER: <div class='indent'><span class='text-base'>dsdbutil</span></div></li><li>At the dsdbutil prompt, type the following command,  and then press ENTER:<div class='indent'><span class='text-base'>list instances</span></div><span class='text-base'>Note</span>: The <span class='text-base'>list instances</span> command will display the values of the LDAP and SSL ports that are used by the instances that are installed on the computer. <br></li></ol></li><li>Reserve the two UDP ports that you noted in step 1. <br><br><br><br><span>For more information about how to reserve ephemeral ports, click the following article number to view the article in the Microsoft Knowledge Base:<br><br><div class='indent'><a id='kb-link-1' href='/en-us/help/812873'>812873 </a> How to reserve a range of ephemeral ports on a computer that is running Windows Server 2003 or Windows 2000 Server<br><br></div></span></li><li>After you reserve the ports, restart the computer. </li></ol>This procedure will prevent the DNS server from taking ports that are needed for the AD LDS instances to function and will avoid any port conflicts between the two ports. </div><div class='kb-moreinformation-section section'><br><br>Microsoft has confirmed that this is a problem in the Active Directory Lightweight Directory Services. <br><br><br><br><span>For more information, click the following article number to view the article in the Microsoft Knowledge Base:<br><br><div class='indent'><a id='kb-link-2' href='/en-us/help/956188'>956188 </a> You experience issues with UDP-dependent network services after you install DNS Server service security update 953230 (MS08-037)<br><br></div></span>If the Active Directory domain controller role is not installed on a computer, ADAM setup will auto-fill the LDAP and SSL port fields by using the values 389 and 636, respectively. If the Active Directory domain controller role <span class='text-base'>is</span> installed, ADAM auto fills the LDAP and SSL port fields by using 50000 for LDAP and with 50001 for SSL. Because the MS08-037 version of DNS server grabs 2,500 ports in the high-port range and typically starts before the AD LDS service starts, in Windows Server 2008, that AD LDS installation will not prevent you from using these ports, and the AD LDS service start fails.<br><br>In Windows Server 2008 R2, AD LDS installation will recognize ports that are unavailable (And this includes those ports that DNS allocates), and the AD LDS installation will auto fill appropriate ports that are currently not being used. The AD LDS installation will not let you choose a port that is taken by another service for an AD LDS instance.<br><br>Multiple instances of AD LDS (ADAM) can be installed on one computer. Therefore, if you have more than 2 AD LDS instances on your computer, you will be covering more ports than the defaults (389, 636 and 50000, 50001). <br></div><div class='kb-symptoms-section section'><br><br>Repro Steps<br><br><br>=============================<br><br><br>1.&#160;&#160;&#160;&#160;&#160;&#160; Install a W2K3 or W2K8 server with with the DNS Server role<br><br><br>2.&#160;&#160;&#160;&#160;&#160;&#160; Insall the 951746 version of the DNS Server spoofing fix<br><br><br>3.&#160;&#160;&#160;&#160;&#160;&#160; Install AD LDS and assign a port <br><br><br>But when ADAM needs to use a port in the ephemeral range because it can’t use those default ports, that’s when the problem arises.&#160; <br><br><br>Author: Amruta Ghate <br><br><br>Latest version of the Doc available @ &quot;\\lcpesdom\Public\arrenc\DocReviews\_FY2009\2009.09.08 - AD LDS service start failure with MS08-037 DNS Server QFE installed\ADAM service startup failure with MS08-037 DNS Server .docx&quot;<br><br><br>Waiting on Dev team to provide event ID which will be added to the doc @ the URL above once provided.<br></div><div class='kb-securedata-section section'>DOC INFO:<br> <br><span class='text-base'>Knowledge Expert: v-bobbid (2008-10-23T20:55:28.073)</span><br><span class='text-base'>Created By: v-bobbid</span><br><span class='text-base'>Last Author: v-bobbid</span><br><span class='text-base'>Last Modified By: v-bobbid</span></div><div class='kb-idea-section section'>MICROSOFT AND/OR ITS SUPPLIERS MAKE NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY, RELIABILITY OR ACCURACY OF THE INFORMATION CONTAINED IN THE DOCUMENTS AND RELATED GRAPHICS PUBLISHED ON THIS WEBSITE (THE “MATERIALS”) FOR ANY PURPOSE. THE MATERIALS MAY INCLUDE TECHNICAL INACCURACIES OR TYPOGRAPHICAL ERRORS AND MAY BE REVISED AT ANY TIME WITHOUT NOTICE.<br><br><br>TO THE MAXIMUM EXTENT PERMITTED BY APPLICABLE LAW, MICROSOFT AND/OR ITS SUPPLIERS DISCLAIM AND EXCLUDE ALL REPRESENTATIONS, WARRANTIES, AND CONDITIONS WHETHER EXPRESS, IMPLIED OR STATUTORY, INCLUDING BUT NOT LIMITED TO REPRESENTATIONS, WARRANTIES, OR CONDITIONS OF TITLE, NON INFRINGEMENT, SATISFACTORY CONDITION OR QUALITY, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE, WITH RESPECT TO THE MATERIALS.</div>