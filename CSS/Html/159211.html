<header><h1>Diagnoses and treatment of black hole routers</h1></header><div class='kb-notice-section section'><span><div class='kb-notice-section section'>For a Microsoft  Windows XP version of this article, see <a id='kb-link-1' href='/en-us/help/314825'>314825 </a>.<br><br></div></span></div><div class='kb-securedata-section section'><span class='text-base'>Important</span> The list(s) in this article were modified during migration to KMS. To see the original version of the list, please refer to the TextLegacy section at the bottom of this article.</div><div class='kb-summary-section section'>On a TCP/IP wide area network (WAN), communication over some routes may fail if intermediate network segments have packet sizes smaller than the communicating hosts, and routers do not send appropriate ICMP responses to this condition. Alternatively, the firewall on the path may drop such responses. A router that causes this condition is sometimes known as a &quot;black hole&quot; router. The Ping utility, a standard utility installed with the Microsoft Windows TCP/IP protocol, can be used to find black hole routers. Some recommendations are provided to work around or fix problems with black hole routers. </div><div> When a network router receives a packet larger than the Maximum Transfer Unit (MTU) of the next network segment, and that packet&#39;s IP layer &quot;don&#39;t fragment&quot; bit is flagged, the router should send an ICMP destination unreachable message back to the sending host. When this does not happen, packets can be dropped, causing a variety of errors that will vary with the application that is communicating over the failed link. These errors will not occur when an application connects to a computer on a local subnet. The problem may seem intermittent, but on closer examination, it can be duplicated, such as in having a client read a large file from a remote host. <br><br> The Ping utility can be used to find black hole routers by using the -f (do not fragment) and the -l (buffer size) parameters. Setting the -f parameter will cause the Ping utility to send an ICMP echo packet with the IP &quot;do not fragment&quot; bit set. The -l parameter sets the buffer, or payload, size of the ICMP Echo packet. The largest buffer that can be sent unfragmented equals the MTU minus the IP and ICMP headers (MTU-28) of the smallest MTU along a route. For example, because Ethernet has an MTU of 1500 bytes, under the best circumstances, Ping could echo an unfragmented packet with an ICMP buffer of 1472 bytes. The syntax for Ping in this case would be: <br><br><span class='sbody-userinput'>  Ping &lt;computer name or IP address&gt; -f -l 1472 </span><br><br> This should work on all local IP addresses. If the MTU of all segments of a routed connection are 1500 or larger, the packet should be returned as well. If there are intermediate segments with smaller MTUs, and routers return the appropriate ICMP Destination Unreachable packet, the utility should display &quot;Packet needs to be fragmented but DF set&quot;. If there are segments along the route with smaller MTUs, and the appropriate ICMP packet is not returned, the Ping utility should display &quot;Request timed out.&quot; The default MTUs of common network media are described in Knowledge Base article<br> <a id='kb-link-2' href='/EN-US/help/314496'>314496 </a>. <br><br> By changing the -l parameter on successive Pings, the largest unfragmented packet that will travel a specific route can be found. The smallest MTU in general use is 576 bytes, so you should be able to safely start with an ICMP buffer of 548, then work up from there. For example, if <span class='sbody-userinput'>Ping &lt;host name or address&gt; -f -l 972</span> returns packets and <span class='sbody-userinput'>Ping &lt;host name or address&gt; -f -l 973</span> fails, the largest MTU that can be used over that route is 1000 (972+28). <br><br> To fix or work around black hole routers, there are four possible solutions: <br> <ol class='sbody-num_list'><li>Enable PMTU Black Hole Detection on Windows hosts that will be communicating over a wide area connection, as documented in Microsoft Knowledge Base article<br><a id='kb-link-3' href='/EN-US/help/136970'>136970 </a>. In this case, Windows NT 3.51 Service Pack 2 or later or Windows NT 4.0 should be used. </li><li>Configure intermediate routers to send ICMP type 3 code 4 (destination unreachable don&#39;t fragment (DF) bit sent and fragmentation required) messages. This may require upgrading router software or firmware, router configuration or router replacement. <br></li><li>Disable PMTU discovery on Windows hosts that communicate over troublesome routes. This will configure the default MTU to 576 bytes. This could cause significant degradation in network performance. <br></li><li>Set the MTU of the host interface to be the largest the black hole router can handle. This guarantees the largest possible packet size will be sent over that connection, but will cause local traffic, and traffic over routed connections without problems, to use smaller packets than they would otherwise. This workaround assumes that you have determined the MTU and the state of all possible links that could be used by the host in question.<br></li></ol><span> For more information, click the following article numbers to view the articles in the Microsoft Knowledge Base: <div class='indent'><a id='kb-link-4' href='/en-us/help/120642'>120642 </a> TCP/IP and NBT configuration parameters for Windows 2000 or for Windows NT<br><br></div></span><span><div class='indent'><a id='kb-link-5' href='/en-us/help/128797'>128797 </a> Unable to transfer files across DEC 250 and DEC 500 routers<br><br></div></span><span><div class='indent'><a id='kb-link-6' href='/en-us/help/136970'>136970 </a> PMTU black hole detection algorithm change for Windows NT 3.51<br><br></div></span><span><div class='indent'><a id='kb-link-7' href='/en-us/help/138575'>138575 </a> Communication fails through Ethernet segment between FDDI rings<br><br></div></span><span><div class='indent'><a id='kb-link-8' href='/en-us/help/314496'>314496 </a> The default MTU sizes for different network topologies<br><br></div></span></div><div class='kb-securedata-section section'><span> For more information, click the following article number to view the article in the Microsoft Knowledge Base: <div class='indent'><a id='kb-link-10' href='/en-us/help/128429'>128429 </a> Data transfer terminates due to mismatched MTU sizes<br><br></div></span></div><div class='kb-securedata-section section'> Note that this article is referred to by the Exchange article &quot;Exchange Setup Stops During Replication with a Server,&quot; 159288. If you modify or delete this article, please make corresponding changes in that article. </div><div class='kb-moreinformation-section section'> For more information, see Internet RFC 1191 and RFC 1435. To do this, visit the following Web site:<div class='indent'><a id='kb-link-11' href='http://www.faqs.org/rfcs/' target='_self'>http://www.faqs.org/rfcs/</a></div>See also chapter 6, &quot;TCP/IP Implementation Details,&quot; in the Windows NT Server Resource Kit. To do this, visit the following Microsoft Web site:<div class='indent'><a id='kb-link-12' href='http://www.microsoft.com/resources/documentation/windowsnt/4/server/reskit/en-us/net/sur_tcp2.mspx' target='_self'>http://www.microsoft.com/resources/documentation/windowsnt/4/server/reskit/en-us/net/sur_tcp2.mspx</a></div></div><div class='kb-securedata-section section'>prodnt blackhole</div><div class='kb-textlegacy-section section'>DOC INFO: <br> <ol class='sbody-num_list'><li>Enable PMTU Black Hole Detection on Windows hosts that will be communicating over a wide area connection, as documented in Knowledge Base article<br><a id='kb-link-13' href='/EN-US/help/136970'>136970 </a>. In this case, Windows NT 3.51 Service Pack 2 or later or Windows NT 4.0 should be used. If pressed for a specific recommendation, this solution is probably the best workaround if the customer&#39;s routers cannot be configured correctly, or if a temporary solution is needed until the problem routers are fixed. </li><li>Configure intermediate routers to send ICMP type 3 code 4 (destination unreachable don&#39;t fragment (DF) bit sent and fragmentation required) messages. This may require upgrading router software or firmware, router configuration or router replacement. <br> This solution, though ideal, can put us in the position of providing third-party router configuration advice. It is best to provide references to appropriate RFCs and Knowledge Base articles, then let the network administrator pass them on to the router administrators. </li><li>Disable PMTU discovery on Windows hosts that communicate over troublesome routes. This will configure the default MTU to 576 bytes. This could cause significant degradation in network performance. <br> This is the most reliable course, though the network performance degradation for both local and remote connections may be unacceptable to the user. If reliability is more important than performance, this is a safe course. This may also be the best solution if Windows NT 4.0 or Windows NT 3.51 with SP2 or later is not installed. </li><li>Set the MTU of the host interface to be the largest the black hole router can handle. This guarantees the largest possible packet size will be sent over that connection, but will cause local traffic, and traffic over routed connections without problems, to use smaller packets than they would otherwise. This workaround assumes that you have determined the MTU and the state of all possible links that could be used by the host in question. This is commonly associated with Event ID 3013 on Windows server trying to open a domain list using User Manager for Domains. The error message would read as follows: &quot;The redirector has timed out to &lt;servername&gt;.&quot; The list never appears because of improper MTU settings on one or both of the router interfaces. <br><br> This should not be recommended as a first solution, but could be used in cases where performance connecting to both local and remote hosts can be monitored. It also requires that one knows whether there are secondary routes, or routes to other subnets, having smaller MTUs with the same problem. </li></ol> kbWinNETSearch; kbWinNETServSearch; kbWinNETAdvServSearch; kbWinNETDataServSearch Author: markll (1996-11-11T00:00:00) Edit Reviewer: cathyan (1996-12-16T00:00:00) Tech Reviewer: mnibler (1996-11-11T00:00:00)<br> </div>