<header><h1>How to create offline L2TP/IPSec Certificates</h1></header><div class='kb-notice-section section'>Jesper Hanno MVP</div><div class='kb-notice-section section'><div class='kb-disclaimer-msi'>MICROSOFT CORPORATION AND/OR ITS RESPECTIVE SUPPLIERS MAKE NO REPRESENTATIONS ABOUT THE SUITABILITY, RELIABILITY, OR ACCURACY OF THE INFORMATION AND RELATED GRAPHICS CONTAINED HEREIN. ALL SUCH INFORMATION AND RELATED GRAPHICS ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND. MICROSOFT AND/OR ITS RESPECTIVE SUPPLIERS HEREBY DISCLAIM ALL WARRANTIES AND CONDITIONS WITH REGARD TO THIS INFORMATION AND RELATED GRAPHICS, INCLUDING ALL IMPLIED WARRANTIES AND CONDITIONS OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, WORKMANLIKE EFFORT, TITLE AND NON-INFRINGEMENT.  YOU SPECIFICALLY AGREE THAT IN NO EVENT SHALL MICROSOFT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY DIRECT, INDIRECT, PUNITIVE, INCIDENTAL, SPECIAL, CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER INCLUDING, WITHOUT LIMITATION, DAMAGES FOR LOSS OF USE, DATA OR PROFITS, ARISING OUT OF OR IN ANY WAY CONNECTED WITH THE USE OF OR INABILITY TO USE THE INFORMATION AND RELATED GRAPHICS CONTAINED HEREIN, WHETHER BASED ON CONTRACT, TORT, NEGLIGENCE, STRICT LIABILITY OR OTHERWISE, EVEN IF MICROSOFT OR ANY OF ITS SUPPLIERS HAS BEEN ADVISED OF THE POSSIBILITY OF DAMAGES.</div></div><div class='kb-symptoms-section section'>When non domain member clients wants to establish a VPN connection to ISA Server 2004 using L2TP/IPSec you need to request an IPSec certificate on behalf on the client. This article describes how to install, configure an enterprise certificate service and how to create a certificate request to non domain members. Please note that you need a Microsoft Windows Server 2003 Enterprise edition to create the L2TP/IPSec template.</div><div class='kb-cause-section section'>You need to create a custom template to issue certificates offline to a non domain member</div><div class='kb-resolution-section section'>In This Task<br>&#160;<br>Summary<br>How to Install the Certificate Services<br>How to create a custom MMC<br>How to create a custom L2TP/IPSec (Offline request) template<br>How to issue a custom L2TP/IPSec (Offline request) template<br>How to request a L2TP/IPsec Certificate to ISA Server 2004<br>How to export a PFX certificate to ISA Server 2004<br>How to import the certificates to ISA Server 2004<br>How to request a L2TP/IPSec Certificate to the Offline Client<br>How to export a PFX certificate to the Offline Client<br>How to import the certificates to the Offline Client<br>Additional Information<br>&#160;<br>&#160;<br><strong class='sbody-strong'>Summary</strong><br>&#160;<br>When non domain member clients wants to establish a VPN connection to ISA Server 2004 using L2TP/IPSec you need to request an IPSec certificate on behalf on the client. This article describes how to install, configure an enterprise certificate service and how to create a certificate request to non domain members. Please note that you need a Microsoft Windows Server 2003 Enterprise edition to create the L2TP/IPSec template.<br>&#160;<br>&#160;<br>&#160;<br><strong class='sbody-strong'>How to Install the Certificate Services</strong><br>&#160;<br>The first step is to install the Certificate Services and Internet Information Services (IIS).<br>&#160;<br>On the Server you wish to install Certificate Services and Internet Information Services<br>Click <strong class='sbody-strong'>Start</strong>, click <strong class='sbody-strong'>Control Panel</strong>, click <strong class='sbody-strong'>Add/Remove Programs</strong>, click <strong class='sbody-strong'>Add/Remove Windows Components</strong><br>Select <strong class='sbody-strong'>Application Server</strong>, click <strong class='sbody-strong'>Details</strong><br>Select <strong class='sbody-strong'>Internet Information Services (IIS)</strong>, click <strong class='sbody-strong'>Details</strong><br>Scroll down and put a check mark in <strong class='sbody-strong'>World Wide Web Service</strong>, click <strong class='sbody-strong'>Ok</strong><br>Put a check mark in <strong class='sbody-strong'>Certificate Services</strong>, click <strong class='sbody-strong'>Yes</strong> to the warning about machine name<br>Click <strong class='sbody-strong'>Next</strong><br>On the <strong class='sbody-strong'>CA Type</strong> page, leave the default settings (Enterprise root CA), click <strong class='sbody-strong'>Next</strong><br>On the <strong class='sbody-strong'>CA Identifying Information</strong> page, provide the root CA with a name such as <strong class='sbody-strong'>Company Name Enterprise Root CA</strong>, you might change the Validity period to 10 or 20 years, click <strong class='sbody-strong'>Next</strong><br>On the <strong class='sbody-strong'>Certificate Database Settings</strong> page, click <strong class='sbody-strong'>Next</strong><br>Click <strong class='sbody-strong'>Yes</strong> to the warning about Active Server Page (ASPs) must be enabled in the Internet Information Services (IIS)…<br>Click <strong class='sbody-strong'>Finish</strong> to Completing the Windows Components Wizard<br>&#160;<br>&#160;<br><strong class='sbody-strong'>How to create a custom MMC</strong><br>&#160;<br>In order to manage the certificate templates and export certificates you need to create a custom Microsoft Management Console (MMC).<br>&#160;<br>On the Certificate Server<br>Click <strong class='sbody-strong'>Start</strong>, click <strong class='sbody-strong'>Run</strong>, type <strong class='sbody-strong'>MMC</strong>, and then press <strong class='sbody-strong'>Enter</strong><br>Click <strong class='sbody-strong'>File</strong>, and then click <strong class='sbody-strong'>Add/Remove Snap in</strong><br>Click <strong class='sbody-strong'>Add</strong>, and then select <strong class='sbody-strong'>Certificates</strong> from the list and click <strong class='sbody-strong'>Add</strong>, select <strong class='sbody-strong'>Computer account</strong>, click <strong class='sbody-strong'>Next</strong>, select <strong class='sbody-strong'>Local computer</strong>, click <strong class='sbody-strong'>Finish</strong><br>Select <strong class='sbody-strong'>Certificate Templates</strong> from the list and click <strong class='sbody-strong'>Add</strong><br>Select <strong class='sbody-strong'>Certification Authority</strong> from the list and click <strong class='sbody-strong'>Add</strong>, select <strong class='sbody-strong'>Local computer</strong><br>Click <strong class='sbody-strong'>Close</strong>, click <strong class='sbody-strong'>Ok</strong><br>&#160;<br>&#160;<br><strong class='sbody-strong'>How to create a custom L2TP/IPSec (Offline request) template</strong><br>&#160;<br>On&#160; then Certificate Server&#160;<br>Click <strong class='sbody-strong'>Certificate Templates</strong><br>Right click<strong class='sbody-strong'></strong>on the <strong class='sbody-strong'>IPSec (Offline Request)</strong>, select <strong class='sbody-strong'>Duplicate Template</strong><br>On the General page type <strong class='sbody-strong'>L2TP/IPSec (Offline request)</strong> in the Template display name&#160;<br>You might change the <strong class='sbody-strong'>Validity period</strong><br>Select <strong class='sbody-strong'>Request Handling</strong> page, set a checkmark in <strong class='sbody-strong'>Allow private key to be exported</strong><br>Click <strong class='sbody-strong'>CSPs…</strong>, and select <strong class='sbody-strong'>Requests can use any CSP available on the subject’s computer</strong>, click <strong class='sbody-strong'>Ok</strong><br>Click <strong class='sbody-strong'>Ok</strong><br><strong class='sbody-strong'></strong>&#160;<br><strong class='sbody-strong'>How to issue the custom L2TP/IPSec (Offline request) template</strong><br><strong class='sbody-strong'></strong>&#160;<br>On the Certificate Server&#160;<br>Expand <strong class='sbody-strong'>Certification Authority (Local)</strong><br>Expand <strong class='sbody-strong'>&lt;Enterprise Root CA Name&gt;</strong><br>Right click <strong class='sbody-strong'>Certificate Templates</strong>, select <strong class='sbody-strong'>New</strong>, click <strong class='sbody-strong'>Certificate Template to Issue</strong><br>On the Enable Certificate Templates page select <strong class='sbody-strong'>L2TP/IPSec (Offline request)</strong> on the list and click <strong class='sbody-strong'>Ok</strong><br><strong class='sbody-strong'></strong>&#160;<br><strong class='sbody-strong'></strong>&#160;<br><strong class='sbody-strong'>How to request a L2TP/IPsec Certificate to ISA Server 2004</strong><br>&#160;<br>On the Certificate Server<br>Open Internet Explorer and browse to <br>Select <strong class='sbody-strong'>Request a certificate</strong><br>Select <strong class='sbody-strong'>Advanced certificate request</strong><br>Select <strong class='sbody-strong'>Create and submit a request to this CA</strong><br>In the Certificate Template, select <strong class='sbody-strong'>L2TP/IPSec (Offline request)</strong><br>In the Identifying Information For Offline Template, type the Fully Qualified Domain Name (FQDN) for the ISA Server 2004 in the <strong class='sbody-strong'>Name</strong> field e.g. <em class='sbody-em'>ISASrv.Domain.Local</em><br>Put a checkmark in <strong class='sbody-strong'>Store certificate in the local computer certificate store</strong><br>Click <strong class='sbody-strong'>Submit</strong><br>Click <strong class='sbody-strong'>Yes</strong> to the Potential Scripting Violation box<br>Click <strong class='sbody-strong'>Install this certificate</strong><br>Click <strong class='sbody-strong'>Yes</strong> to the Potential Scripting Violation box<br>&#160;<br>&#160;<br>&#160;<br><strong class='sbody-strong'>How to export a PFX certificate to ISA Server 2004</strong><br>&#160;<br>&#160;<br>On the Certificate Server<br>In the Custom Microsoft Management Console, expand <strong class='sbody-strong'>Certificates (Local Computer)</strong><br>Expand <strong class='sbody-strong'>Personal</strong><br>Expand <strong class='sbody-strong'>Certificates</strong><br>Right click on the certificate you just created, select <strong class='sbody-strong'>All Tasks</strong>, select <strong class='sbody-strong'>Export</strong><br>On the Welcome to the Certificate Export Wizard page, click <strong class='sbody-strong'>Next</strong><br>On the Export Private Key page, select <strong class='sbody-strong'>Yes, export the private key</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Export file format page, leave the default and click <strong class='sbody-strong'>Next</strong><br>On the Password page, type a Password for the certificate, click <strong class='sbody-strong'>Next</strong><br>On the File to Export page, type a name for the certificate e.g. <strong class='sbody-strong'>c:\L2TP Certificate for ISASRV.Domain.Local</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Completing the Certificate Export Wizard page, click <strong class='sbody-strong'>Finish</strong><br>Click <strong class='sbody-strong'>Ok</strong><br>&#160;<br>&#160;<br>&#160;<br><strong class='sbody-strong'>How to import the certificates to ISA Server 2004</strong><br>&#160;<br>First you need to import the certificate for the ISA Server 2004, and then import the Root Certificate for the new Enterprise Certificate Services.<br>&#160;<br>To import the ISA Server 2004 certificate<br>&#160;<br>Copy the <strong class='sbody-strong'>c:\&lt;name of the certificate server name of the enterprise root ca.crt</strong> from the Certificate Server to the ISA Server 2004 computer<br>Copy the <strong class='sbody-strong'>c:\L2TP Certificate for ISASRV.Domain.Local.pfx</strong> from the Certificate Server to the ISA Server 2004 computer<br>On the ISA Server 2004<br>Create a custom MMC for the <strong class='sbody-strong'>Certificates</strong><br>Click <strong class='sbody-strong'>Start</strong>, click <strong class='sbody-strong'>Run</strong>, type <strong class='sbody-strong'>MMC</strong>, and then press <strong class='sbody-strong'>Enter</strong><br>Click <strong class='sbody-strong'>File</strong>, and then click <strong class='sbody-strong'>Add/Remove Snap in</strong><br>Click <strong class='sbody-strong'>Add</strong>, and then select <strong class='sbody-strong'>Certificates</strong> from the list and click <strong class='sbody-strong'>Add</strong>, select <strong class='sbody-strong'>Computer account</strong>, click <strong class='sbody-strong'>Next</strong>, select <strong class='sbody-strong'>Local computer</strong>, click <strong class='sbody-strong'>Finish</strong><br>Click <strong class='sbody-strong'>Close</strong>, click <strong class='sbody-strong'>Ok</strong><br>Expand <strong class='sbody-strong'>Certificates</strong><br>Right click <strong class='sbody-strong'>Personal</strong>, select <strong class='sbody-strong'>All Tasks</strong>, select <strong class='sbody-strong'>Import</strong><br>On the Welcome to the Certificate Import Wizard page, click <strong class='sbody-strong'>Next</strong><br>On the File to Import page, type <strong class='sbody-strong'>c:\L2TP Certificate for ISASRV.Domain.Local.pfx</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Password page, type the Password for the certificate, click <strong class='sbody-strong'>Next</strong><br>On the Certificate Store page, select <strong class='sbody-strong'>Place all certificates in the following store</strong>, and select <strong class='sbody-strong'>Personal</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Completing the Certificate Import Wizard page, click <strong class='sbody-strong'>Finish</strong><br>Click <strong class='sbody-strong'>Ok</strong><br>&#160;<br>&#160;<br>To import the Root Certificate<br>&#160;<br>In the Custom Management Console on the ISA Server 2004<br>Expand <strong class='sbody-strong'>Trusted Root Certification Authorities</strong><br>Right click <strong class='sbody-strong'>Certificates</strong>, select <strong class='sbody-strong'>All Tasks</strong>, select <strong class='sbody-strong'>Import</strong><br>On the Welcome to the Certificate Import Wizard page, click <strong class='sbody-strong'>Next</strong><br>On the File to Import page, type <strong class='sbody-strong'>c:\&lt;name of the certificate server name of the enterprise root ca.crt</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Certificate Store page, select <strong class='sbody-strong'>Place all certificates in the following store</strong>, and select <strong class='sbody-strong'>Trusted Root Certification Authorities</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Completing the Certificate Import Wizard page, click <strong class='sbody-strong'>Finish</strong><br>Click <strong class='sbody-strong'>Ok</strong><br>&#160;<br>Restart the ISA Server 2004 computer to allow the IPSec policies to take effect, after the restart check for eventID 4295 and 4294 in the system event log.<br>&#160;<br>&#160;<br>&#160;<br><strong class='sbody-strong'>How to request a L2TP/IPSec Certificate to the Offline Client</strong><br><strong class='sbody-strong'></strong>&#160;<br><strong class='sbody-strong'></strong>&#160;<br>On the Certificate Server<br>Open Internet Explorer and browse to <br>Select <strong class='sbody-strong'>Request a certificate</strong><br>Select <strong class='sbody-strong'>Advanced certificate request</strong><br>Select <strong class='sbody-strong'>Create and submit a request to this CA</strong><br>In the Certificate Template, select <strong class='sbody-strong'>L2TP/IPSec (Offline request)</strong><br>In the Identifying Information For Offline Template, type the Fully Qualified Domain Name (FQDN) for the non domain member computer in the <strong class='sbody-strong'>Name</strong> field e.g. <em class='sbody-em'>Remote.Client.Local</em><br>Put a checkmark in <strong class='sbody-strong'>Store certificate in the local computer certificate store</strong><br>Click <strong class='sbody-strong'>Submit</strong><br>Click <strong class='sbody-strong'>Yes</strong> to the Potential Scripting Violation box<br>Click <strong class='sbody-strong'>Install this certificate</strong><br>Click <strong class='sbody-strong'>Yes</strong> to the Potential Scripting Violation box<br>&#160;<br><strong class='sbody-strong'>How to export a PFX certificate to the Offline Client</strong><br>&#160;<br>On the Certificate Server<br>In the Custom Microsoft Management Console, expand <strong class='sbody-strong'>Certificates (Local Computer)</strong><br>Expand <strong class='sbody-strong'>Personal</strong><br>Expand <strong class='sbody-strong'>Certificates</strong><br>Right click on the certificate for the non domain computer, select <strong class='sbody-strong'>All Tasks</strong>, select <strong class='sbody-strong'>Export</strong><br>On the Welcome to the Certificate Export Wizard page, click <strong class='sbody-strong'>Next</strong><br>On the Export Private Key page, select <strong class='sbody-strong'>Yes, export the private key</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Export file format page, leave the default and click <strong class='sbody-strong'>Next</strong><br>On the Password page, type a Password for the certificate, click <strong class='sbody-strong'>Next</strong><br>On the File to Export page, type a name for the certificate e.g. <strong class='sbody-strong'>c:\L2TP Certificate for Remote.Client.Local</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Completing the Certificate Export Wizard page, click <strong class='sbody-strong'>Finish</strong><br>Click <strong class='sbody-strong'>Ok</strong><br>&#160;<br><strong class='sbody-strong'></strong>&#160;<br><strong class='sbody-strong'></strong>&#160;<br><strong class='sbody-strong'>How to import the certificates to the Offline Client</strong><br>&#160;<br>First you need to import the certificate for the <strong class='sbody-strong'>Remote.Client.Local</strong> computer, and then import the Root Certificate for the new Enterprise Certificate Services.<br>&#160;<br>To import the Remote.Client.Local certificate<br>&#160;<br>Copy the <strong class='sbody-strong'>c:\&lt;name of the certificate server name of the enterprise root ca.crt</strong> from the Certificate Server to the ISA Server 2004 computer<br>Copy the <strong class='sbody-strong'>c:\L2TP Certificate for Remote.Client.Local.pfx</strong> from the Certificate Server to the non domain member computer<br>On the non domain member computer<br>Create a custom MMC for the <strong class='sbody-strong'>Certificates</strong><br>Click <strong class='sbody-strong'>Start</strong>, click <strong class='sbody-strong'>Run</strong>, type <strong class='sbody-strong'>MMC</strong>, and then press <strong class='sbody-strong'>Enter</strong><br>Click <strong class='sbody-strong'>File</strong>, and then click <strong class='sbody-strong'>Add/Remove Snap in</strong><br>Click <strong class='sbody-strong'>Add</strong>, and then select <strong class='sbody-strong'>Certificates</strong> from the list and click <strong class='sbody-strong'>Add</strong>, select <strong class='sbody-strong'>Computer account</strong>, click <strong class='sbody-strong'>Next</strong>, select <strong class='sbody-strong'>Local computer</strong>, click <strong class='sbody-strong'>Finish</strong><br>Click <strong class='sbody-strong'>Close</strong>, click <strong class='sbody-strong'>Ok</strong><br>Expand <strong class='sbody-strong'>Certificates</strong><br>Right click <strong class='sbody-strong'>Personal</strong>, select <strong class='sbody-strong'>All Tasks</strong>, select <strong class='sbody-strong'>Import</strong><br>On the Welcome to the Certificate Import Wizard page, click <strong class='sbody-strong'>Next</strong><br>On the File to Import page, type <strong class='sbody-strong'>c:\L2TP Certificate for Remote.Client.Local.pfx</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Password page, type the Password for the certificate, click <strong class='sbody-strong'>Next</strong><br>On the Certificate Store page, select <strong class='sbody-strong'>Place all certificates in the following store</strong>, and select <strong class='sbody-strong'>Personal</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Completing the Certificate Import Wizard page, click <strong class='sbody-strong'>Finish</strong><br>Click <strong class='sbody-strong'>Ok</strong><br>&#160;<br>&#160;<br>To import the Root Certificate<br>&#160;<br>In the Custom Management Console on the ISA Server 2004<br>Expand <strong class='sbody-strong'>Trusted Root Certification Authorities</strong><br>Right click <strong class='sbody-strong'>Certificates</strong>, select <strong class='sbody-strong'>All Tasks</strong>, select <strong class='sbody-strong'>Import</strong><br>On the Welcome to the Certificate Import Wizard page, click <strong class='sbody-strong'>Next</strong><br>On the File to Import page, type <strong class='sbody-strong'>c:\&lt;name of the certificate server name of the enterprise root ca.crt</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Certificate Store page, select <strong class='sbody-strong'>Place all certificates in the following store</strong>, and select <strong class='sbody-strong'>Trusted Root Certification Authorities</strong>, click <strong class='sbody-strong'>Next</strong><br>On the Completing the Certificate Import Wizard page, click <strong class='sbody-strong'>Finish</strong><br>Click <strong class='sbody-strong'>Ok</strong><br></div><div class='kb-moreinformation-section section'>After this step by step guide is completed you can create at new connection from a remote non domain member to the ISA Server 2004. Remember to configure ISA Server 2004 to accept inbound VPN connections and create a Firewall rule to allow traffic from VPN Clients network to the internal network. On the Client side remember to set the VPN type to L2TP IPSec VPN. To automate the client configuration use Connection Manager Administrative kit (CMAK).<br></div>