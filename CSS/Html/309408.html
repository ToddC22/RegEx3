<header><h1>How to troubleshoot the Data Protection API (DPAPI)</h1></header><div class='kb-summary-section section'>The Data Protection API (DPAPI) helps to protect data in Windows 2000 and later operating systems. DPAPI is used to help protect private keys, stored credentials (in Windows XP and later), and other confidential information that the operating system or a program wants to keep confidential. <br><br>DPAPI is not responsible for storing the confidential information it protects. It is only responsible for encrypting and decrypting data for programs  that call it, such as  Windows Credential manager,  the  Private Key storage mechanism, or any third-party programs  that call the <span class='text-base'>CryptProtectData()</span> function and the <span class='text-base'>CryptUnprotectData()</span> function in Windows 2000, Windows XP, or later. <br><br><span class='text-base'>Note</span> This functionality is different from  the functionality that is offered by the Windows protected store (P-store) in Windows NT 4.0. P-store is responsible for protecting and storing confidential information.  DPAPI offers no storage capabilities.<br>This article describes how DPAPI help protect data at a basic level. It also includes  information that is related to troubleshooting loss of access to DPAPI protected data in different scenarios. <br><br>For more information about  how DPAPI works, visit the following Microsoft Web site: <div class='indent'><a id='kb-link-1' href='http://msdn2.microsoft.com/en-us/library/ms995355.aspx' target='_self'>http://msdn2.microsoft.com/en-us/library/ms995355.aspx</a></div>This article includes the following topics:<a class='bookmark' id='toc'></a><ul class='sbody-free_list'><li><a managed-link="" href='#1' target="" bookmark-id='1'>What DPAPI Can Protect</a><ul class='sbody-free_list'><li><a managed-link="" href='#2' target="" bookmark-id='2'>Example: Certificates and Private Keys</a></li></ul></li><li><a managed-link="" href='#3' target="" bookmark-id='3'>How DPAPI Works</a></li><li><a managed-link="" href='#4' target="" bookmark-id='4'>DPAPI Environmental Considerations</a><ul class='sbody-free_list'><li><a managed-link="" href='#5' target="" bookmark-id='5'>DPAPI and Mandatory Profiles</a></li><li><a managed-link="" href='#6' target="" bookmark-id='6'>DPAPI and Roaming Profiles</a></li><li><a managed-link="" href='#7' target="" bookmark-id='7'>DPAPI and Password Changes</a></li></ul></li><li><a managed-link="" href='#8' target="" bookmark-id='8'>Known Issues</a><ul class='sbody-free_list'><li><a managed-link="" href='#9' target="" bookmark-id='9'>You Cannot Access DPAPI Confidential Information with Roaming Profiles in a Windows NT 4.0 Domain</a></li><li><a managed-link="" href='#10' target="" bookmark-id='10'>You Cannot Access DPAPI Confidential Information After Reinstalling Windows</a></li><li><a managed-link="" href='#11' target="" bookmark-id='11'>You Cannot Add or Access DPAPI Confidential Information with Mandatory Profiles</a></li><li><a managed-link="" href='#12' target="" bookmark-id='12'>You Cannot Access DPAPI Confidential Information After Joining or Disjoining a Domain</a></li></ul></li><li><a managed-link="" href='#13' target="" bookmark-id='13'>Guidelines and Best Practices</a></li></ul></div><div><span class='text-base'>Important</span> To   troubleshoot the loss of DPAPI data, you must gather the following information:<ul class='sbody-free_list'><li>How does   DPAPI work in your particular security environment including the local workstation version?</li><li>Is the workstation is joined to a domain?</li><li>Is   the  user is a member of the domain?</li><li>What is the   operating system version that is hosting the domain?</li></ul> <br>Many problems with DPAPI  occur when  DPAPI is used in a Windows NT 4.0 domain.  See the &quot;Known Issues&quot; section later in this article  for more information. <br><br>DPAPI is used primarily by the security features of the operating system to help protect data on the user&#39;s behalf. Additionally, any third-party program can use DPAPI to help securely protect user data. <h3 class='sbody-h3'><a class='bookmark' id='1'></a>What DPAPI Can Protect</h3>DPAPI helps protect the following  items:<ul class='sbody-free_list'><li>Web page credentials (for example,  passwords)</li><li>File share credentials</li><li>Private keys associated with Encrypting File System (EFS),  S/MIME,  and other certificates</li><li>Program data that is protected using the <span class='text-base'>CryptProtectData()</span> function</li></ul><h4 class='sbody-h4'><a class='bookmark' id='2'></a>Example: Certificates and Private Keys</h4>This section describes the  difference between personal data and confidential information that DPAPI helps protect. The following list describes the  placement of data during an import operation of a certificate and it describes the private key that is associated with that certificate to the user&#39;s personal store: <ul class='sbody-free_list'><li>The certificate is encoded as a binary large object  and stored as a binary value in the following file location:<br><div class='indent'>%Userprofile%\Application Data\Microsoft\SystemCertificates\My\Certificates<br></div></li><li>Note that the location of the registry key is in the local user&#39;s profile. This placement makes sure  that only the logon user has access to their own certificates in typical  circumstances. </li><li>Certificates are not protected by DPAPI by any default Windows mechanisms. An Access Control List (ACL) is used to define who may load the user&#39;s hive and who may read the certificates that are stored in the hive.</li><li>The private key that is associated with the certificate is encrypted by DPAPI and saved (in an encrypted form) in a key container as an individual file in the user&#39;s profile in the following folders:<ul class='sbody-free_list'><li>For RSA Keys:<div class='indent'>%Userprofile%\Application Data\Microsoft\Crypto\RSA\<strong class='sbody-strong'>User SID</strong></div></li><li>For DSA Keys:<div class='indent'>%Userprofile%\Application Data\Microsoft\Crypto\DSA\<strong class='sbody-strong'>User SID</strong></div></li></ul></li></ul><a managed-link="" href='#toc' target="" bookmark-id='toc'>back to the top</a><h3 class='sbody-h3'><a class='bookmark' id='3'></a>How DPAPI Works</h3><span class='text-base'>Note</span> The terms and concepts that are described in this section  have been simplified for the purposes of clarity in the context of this article. Some level of detail has been omitted. For example, this article discusses  a value  that is derived from  the user&#39;s password, but it does not describe the details of the algorithm that is used to derive the value.  For a detailed description of how DPAPI works, view the  Windows Data Protection white paper.  To view this white paper, visit the following Microsoft Web site: <div class='indent'><a id='kb-link-2' href='http://msdn2.microsoft.com/en-us/library/ms995355.aspx' target='_self'>http://msdn2.microsoft.com/en-us/library/ms995355.aspx</a></div>DPAPI is a  function  that is used by programs  and various operating system components to help protect data for a user. The operation of  DPAPI is not visible to the user. DPAPI helps protect data in the security context of the user who runs the program. <br><br>DPAPI helps protect confidential information  by using value data derived from a pseudo-random 512-bit number named a master key. Windows Server 2003 domain controllers use a 2048-bit RSA key, but only when the domain is running in domain functional level 2 or Windows Server 2003 mode.    Each user account has one or more randomly generated master keys. The number of master keys depends on the age of the user&#39;s profile. Master keys are renewed at regular intervals. By default, this value is every 90 days.<br><br>Because master keys contain the data that is required  to decrypt all  the user&#39;s confidential information, the master keys must be protected. They are protected using a value that is derived from  the user&#39;s password. The password is a unique value that only a user knows.  Because the master key is actually encrypted using a value that is derived from the user&#39;s password, this value is used interchangeably with the user&#39;s password in the descriptions presented in this article. <br><br><a managed-link="" href='#toc' target="" bookmark-id='toc'>back to the top</a><h3 class='sbody-h3'><a class='bookmark' id='4'></a>DPAPI Environmental Considerations</h3>This section describes the  environmental configurations that  affect the behavior of DPAPI protection. <h4 class='sbody-h4'><a class='bookmark' id='5'></a>DPAPI and Mandatory Profiles</h4>Mandatory profiles are read-only profiles. No updates that are made to the local copy of a mandatory profile are saved.   For example, key generation is blocked in a mandatory profile. DPAPI stores the master key in the local copy of a profile and regularly creates new master keys and updates the encryption on the protected confidential information with the new master key. <br><br>Because  these two conditions are incompatible, programs that depend on DPAPI to help protect confidential information do not work correctly with mandatory profiles. Programs  that help protect confidential information with DPAPI that do not work correctly with mandatory profiles include EFS (private keys), Certificates with Private Keys (private keys), and Stored Credentials in Windows XP and later (credentials).  Configurations that  use  these data types or programs are  not supported.<br><br><a managed-link="" href='#toc' target="" bookmark-id='toc'>back to the top</a><h4 class='sbody-h4'><a class='bookmark' id='6'></a>DPAPI and Roaming Profiles</h4>DPAPI  works as expected with roaming profiles for users and computers  that are joined to an Active Directory directory service domain. DPAPI data that is stored in the profile acts exactly like any other setting or file that is stored in a roaming profile. Confidential information that the DPAPI helps protect are  uploaded to the central profile location during the logoff process and are downloaded from the central profile location when a user logs on. <br><br>For DPAPI to work correctly when it uses roaming profiles, the domain user must only be logged on to a single computer in the domain.  If the user wants to log on to a different computer that is in the domain, the user must log off the first computer before the user logs on to the second computer.  If the user is logged on to multiple computers at the same time,  it is likely that DPAPI will not be able to decrypt existing encrypted data correctly.<br><br>DPAPI on one computer can decrypt the master key (and the data) on another computer.  This functionality  is provided by the user&#39;s consistent password that is stored and verified by the domain controller. If an unexpected interruption of the typical process occurs, DPAPI can use the process described in the &quot;Password Reset&quot; section later in this article. <br><br><br><br><br>There is a current limitation with roaming profiles between Windows XP-based or Windows Server 2003-based computers and Windows 2000-based computers.  If keys are generated or imported on a Windows XP-based or Windows Server 2003-based computer  and then stored in a roaming profile, DPAPI cannot  decrypt these keys on a Windows 2000-based computer if you are  logged on with a roaming user profile. However, a  Windows XP-based or Windows Server 2003-based computer  can decrypt keys that are generated on a Windows 2000-based computer. <br><br><a managed-link="" href='#toc' target="" bookmark-id='toc'>back to the top</a><h4 class='sbody-h4'><a class='bookmark' id='7'></a>DPAPI and Password Changes</h4>Users in an enhanced security environment are expected to change their passwords at regular intervals.  As a result,  DPAPI must be able to maintain the same level of access to the user&#39;s protected data after  password changes. The following methods are used to change user passwords  in a Windows environment:<h5 class='sbody-h5 text-subtitle'>Password Change</h5>In this method, there  is  continuity of access to the user&#39;s master keys during a password change. The DPAPI is invoked by the Winlogon component during password change operations in an Active Directory domain:<ul class='sbody-free_list'><li>DPAPI receives notification from Winlogon during a password change operation.</li><li>DPAPI decrypts all master keys that were encrypted with the user&#39;s old passwords.</li><li>DPAPI re-encrypts all master keys with the user&#39;s new password.</li></ul><h5 class='sbody-h5 text-subtitle'>Password Reset (Set)</h5> In this method, an administrator forcibly resets a user password. A password reset is more complex than a password change. Because  the administrator is not logged on as the user and does not have access to the user&#39;s old password, that old password cannot be used to decrypt the old master key and re-encrypt it with the new password. <br><br>In all cases of password resets, if  the user&#39;s password is changed back to the last password before it was reset, access is  restored  to master key and, as a result, access is restored to all  the confidential information it helps protect. This behavior occurs because master keys are never deleted, even when they cannot be decrypted. However, this may be an unreliable solution because you cannot expect the user to be able to always remember the old  password. For example, the user&#39;s password may have been reset because the user forgot this password. <br><br>The way that DPAPI solves the password reset issue depends on the security environment where the user is authenticated.<br><br><span class='text-base'>Password Reset: Domain Users in a Windows 2000 or Later Domain</span><br><br>When DPAPI is used in an Active Directory domain environment, two copies of the master key are created and updated whenever an operation is performed on the master key. The first copy is protected by the user password as described earlier in this article. The second copy is encrypted with a public key that is associated with the domain controllers in the domain. The private key that is associated with this public key is known to all of the Windows 2000 and later domain controllers.  Windows 2000 domain controllers use a symmetric key to encrypt and decrypt the second copy of the master key. <br><br>If the user password is reset and the original master key is rendered inaccessible to the user, the user&#39;s access to the master key is automatically restored using the backup master key in  the following process:<ul class='sbody-free_list'><li>The workstation sends the encrypted backup master key to a Windows 2000 or later domain controller over protected RPC.</li><li>The domain controller uses the private key to decrypt the user&#39;s master key.</li><li>The domain controller returns the unencrypted master key to the workstation.</li><li>The workstation re-encrypts the master key using the user&#39;s new password.</li></ul><span class='text-base'>Password Reset: Windows NT 4.0 Domain</span><br><br>Microsoft does not recommend the use of DPAPI-enabled features (for example, EFS or Private Key storage) for users who are in a Windows NT 4.0 domain. See the &quot;Known Issues&quot; section of this article for more information. <br><br>After a password reset, a Windows 2000-based  client computer restores the user&#39;s access to the DPAPI-protected confidential information automatically by using the backup master key in the same way it does if the user is in a workgroup. See the &quot;Password Reset: Windows 2000 Workstation in a Workgroup&quot; section in this article for more information about this procedure and for informational about security risks. <br><br>Windows XP in a Windows NT 4.0 domain does not keep a backup copy of the master key.  For more information, see the &quot;Known Issues&quot;  section in this article<br><br><span class='text-base'>Password Reset: Windows 2000 Workstation in a Workgroup</span><br><br>If you are using DPAPI on a stand-alone computer,  two copies of the master key are created and updated whenever an operation is performed on the master key. The first copy is protected by the user password as described earlier in this article. The second copy is encrypted with a confidential value known only to the local computer account.<br><br>After a user&#39;s password has been forcibly reset and the user logs on with the new password, Windows 2000 automatically decrypts the computer-encrypted copy of the master key and re-encrypts it with the value derived from the new user password. From the user&#39;s point of view, the user&#39;s access to the confidential information that is protected by DPAPI is completely uninterrupted.<br><br><span class='text-base'>Important</span> This behavior may affect security.   Microsoft does not recommend that you use DPAPI in a default configuration like this. Microsoft recommends that you use one of the following methods   for Windows 2000 stand-alone computers that contain sensitive data that may be physically compromised:<br><ul class='sbody-free_list'><li>Upgrade to Windows XP</li><li>Use SYSKEY  mode 2 or 3 on the Windows 2000-based  laptop</li><li><br><span>For additional information about  SYSKEY, click the following article number to view the article in the Microsoft Knowledge Base:<br><div class='indent'><a id='kb-link-3' href='/EN-US/help/143475'>143475 </a> Windows NT System Key Permits Strong Encryption of the SAM<br></div></span></li></ul><span class='text-base'>Password Reset: Windows XP Workstation in a Workgroup </span><br><br>By default, Window XP does not create backup copies of the master key.  It does so to help   prevent an offline attack of the master key cache. In Windows XP, you can  create a password reset disk so that the user may recover their password if they forget it.     If you are using Windows XP  Service Pack 1 (SP1) or later, you can configure the registry so that Windows   keeps a backup copy of the master key. <br><span>For additional information about effects of a forcible password change and possible recovery , click the following article number to view the article in the Microsoft Knowledge Base:<br><br><div class='indent'><a id='kb-link-4' href='/en-us/help/290260'>290260 </a> EFS, credentials, and private keys from certificates are unavailable after a password is reset<br><br></div></span><span class='text-base'>Password Reset Disks</span><br><br>Password reset disks are only available on Windows XP or later-based computers that are  joined to workgroups. The password recover disk permits the user to regain access to their account and all  the confidential information that is protected by DPAPI in the profile. <br><br><span>For additional information about the password reset disk, click the following article number to view the article in the Microsoft Knowledge Base:<br><br><div class='indent'><a id='kb-link-5' href='/en-us/help/321305'>321305 </a> How to log on to Windows XP if you forget your password or your password expires<br><br></div></span><a managed-link="" href='#toc' target="" bookmark-id='toc'>back to the top</a></div><div class='kb-securedata-section section'><h3 class='sbody-h3'>Password Reset Disk (PRD) Process</h3> When you use the password reset disk, the workstation performs the following procedure:<br><ul class='sbody-free_list'><li>The workstation generates a 2048-bit RSA public-private key pair. </li><li>It  encapsulates the public key in a self-signed certificate.</li><li>It  encrypts the user password with the public key and the user password is stored in the registry.</li><li>It  stores the encrypted copy of master key with the copy that is encrypted with the user&#39;s password.</li><li>It stores the private key on the password reset disk.</li><li>It stores the self-signed certificate in the following registry key of the local computer:<br><div class='indent'><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\Security\Recovery\\&lt;User SID&gt;</strong></div></li></ul>When the master key has  to be updated on the workstation, both copies of the key are   updated: the copy that is encrypted with the user&#39;s password and the copy that is encrypted with the public key of the password reset disk.   When the user password changes, the master keys are re-encrypted and the encrypted password, if it exists,  is also  updated. <br><br><span class='text-base'>Note</span> If you  create a new password reset disk,   the old key pair is replaced with a new pair.   As a result, the old password recovery disks are unusable. <br><br><br> In Windows XP, this behavior changed in response to customer requests.  Windows XP has  a more secure default setting than Windows 2000 and earlier. Customers wanted to prevent a scenario where the user has a strong password but the default Administrator account has either no password or a weak password.    This scenario may occur if the user  does not set a  password during installation and then forgets that they did not set a password.    If a password is not set, the system may be vulnerable to an attack. This behavior is why a  default EFS recovery agent is not available on stand-alone computers.<br></div><div class='kb-securedata-section section'><span class='text-base'>Note</span>  An issue has been reported that occurs when users  of Windows XP workstations who have accounts in a Windows NT 4.0 domain and whose machine accounts are in a trusted Windows 2000 domain change their Windows NT 4.0 domain passwords.  This issue is outlined in SOX030422700056.   In this case,  the workaround that is described  in Microsoft Knowledge Base article 331333 is  not as effective as the workaround that is described in the Microsoft Knowledge Base article 313595.</div><div class='kb-securedata-section section'><span class='text-base'>Note</span> A utility named Reccerts.exe is available through Microsoft PSS for Windows XP. You can use this utility   for cases where EFS data is unavailable after a re-installation of Windows XP or after a hardware failure where the EFS data and the encrypting user&#39;s profile is intact.   Reccerts.exe migrates certificates from the old user profile to the current user profile. You must know the  previous user password to use this utility. You can use this utility to recover all of the EFS files  that would be otherwise lost.</div><div class='kb-moreinformation-section section'><h3 class='sbody-h3'><a class='bookmark' id='8'></a>Known Issues</h3><h4 class='sbody-h4'><a class='bookmark' id='9'></a>You Cannot Access DPAPI Confidential Information in a Windows NT 4.0 Domain</h4><span class='text-base'>Important</span> Microsoft does not recommend that you use DPAPI in a Windows NT 4.0 domain environment. <br><br>In a Windows NT 4.0 domain,  Windows XP does not create a backup copy of the user&#39;s master key.  This is the  default behavior.  If you change or  reset the password, the user may be denied  access to the confidential information that is contained in their profile. Access is only restored when the user changes the password back to  the last known good password. <br><br>The most frequent causes of problems with DPAPI in a Windows NT 4.0 domain involve password resets or roaming profiles. Problems with roaming profiles occur  if the user has recently changed their password. Depending on various factors that may interrupt typical roaming user profile operations, the profile that  the user is logged on to may not have been updated with the new password (master key encryption). <br><br><br>To resolve this problem,  install a Windows 2000 or Windows Server 2003 domain controller in the user domain. DPAPI automatically finds this domain controller  to perform backup and restore operations using the domain controller&#39;s DPAPI public/private key pair.<br><br>If you are using Windows  SP1 and later, you can force DPAPI to make local backups of the master key while you are joined to a Windows NT4 domain. However, Microsoft does not recommend this procedure because it affects the security of the computer where  the change is applied.<br><br><span>For additional information, click the following article number to view the article in the Microsoft Knowledge Base:<br><br><div class='indent'><a id='kb-link-6' href='/en-us/help/331333'>331333  </a> User cannot gain access to EFS encrypted files after password change or when using a roaming profile<br><br></div></span><a managed-link="" href='#toc' target="" bookmark-id='toc'>back to the top</a><h4 class='sbody-h4'><a class='bookmark' id='10'></a>You Cannot Access DPAPI Confidential Information After Reinstalling Windows on a Stand-Alone Computer</h4>By design, you cannot access DPAPI confidential information after you install Windows on a stand-alone computer. The instance of the user that was present on the original copy of Windows is destroyed after you re-install the operating system without upgrading. Any new user that is created with the same name has  a different security principal in a different security database.  The new user does not have access to decrypt the DPAPI confidential information of the original user. The user cannot access their confidential information by using  the user master key. <br><br>The original copy of Windows helps protect its copy of the master key with confidential data that is known only to that copy of Windows. If you replace  the operating system,   this confidential data cannot be accessed . The user cannot  access their confidential information by using the backup master key. <br><br><a managed-link="" href='#toc' target="" bookmark-id='toc'>back to the top</a><h4 class='sbody-h4'><a class='bookmark' id='11'></a>You Cannot Add or Access DPAPI Confidential Information with Mandatory Profiles</h4>By design, Windows 2000 and Windows XP do not allow you to write to the local copy of a mandatory profile because the data is  saved after the initial session. As a result, DPAPI cannot store new master keys, update master keys on password change, or add protected data to a mandatory profile. <h4 class='sbody-h4'><a class='bookmark' id='12'></a>You Cannot Access DPAPI Confidential Information After Joining or Disjoining a Domain</h4>If you have joined a stand-alone computer to a domain and you have lost access to DPAPI data,  you can restore access by logging on as the local user. To log on as a local user on a domain-joined computer, click the local computer&#39;s name in the dropdown box in the <strong class='uiterm'>Logon</strong> dialog box, and then enter your local user name and password. <br><br>If you have disjoined a computer from a domain, you must rejoin the domain and then log on as the same domain user to regain access to your files. <br><br><a managed-link="" href='#toc' target="" bookmark-id='toc'>back to the top</a><h3 class='sbody-h3'><a class='bookmark' id='13'></a>Guidelines and Best Practices</h3><ul class='sbody-free_list'><li>Microsoft recommends that you use strong passwords. Use   the most difficult complex password you can reliably remember. <span class='text-base'>Note</span> Password filters are currently not supported by DPAPI.</li><li>Export and back up important certificates and private keys to a safe and secure location.<br></li></ul><a managed-link="" href='#toc' target="" bookmark-id='toc'>back to the top</a></div><div class='kb-securedata-section section'>rebuild</div><div class='kb-securedata-section section'>Author: MSIMOS (2001-10-04T12:49:00)<br><br>Co-Author and Tech Reviewer:  shawnrab<br>Contributions from David Cross (dcross), John Banes (jbanes), Tom Jones (tjones), Scott Sanders (scottsa), and Bruno Saille (brunosa)</div>