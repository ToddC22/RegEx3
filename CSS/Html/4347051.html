<header><h1>RDP: RDP fails, displays blackscreen or disconnects during Logon w/ Winlogon Event 4005: &quot;The Windows logon process has unexpectedly terminated.&quot;</h1></header><span asset="4476087" contenteditable="false" unselectable="on" props="{&#34;size&#34;:&#34;full&#34;}">[Asset 4476087]</span><ul><li><strong>Content Idea (CI): </strong><a managed-link="" href="https://aka.ms/CIEdit?id=87295" target="" data-content-type="" data-content-id="" bookmark-id="">87295</a></li></ul><li><strong>Product Group Bug(s): </strong>https://microsoft.visualstudio.com/OS/_workitems/edit/19625737</li><p><strong>Support Topic: </strong><ul><li>Windows Servers\Windows Server 2016\Windows Server 2016</li></ul></p><div><p dir="ltr">Abstract</p><blockquote dir="ltr"><p dir="ltr">If there is no Event 4005 Winlogon - &quot;The Windows logon process has unexpectedly terminated&quot; event in the event log, then this KB article does NOT apply to you.<br><br></p><div dir="ltr" style="margin-top:4px;margin-bottom:4px;"><span asset="4572265" contenteditable="false" unselectable="on" props="{&#34;size&#34;:&#34;full&#34;}">[Asset 4572265]</span><br></div></blockquote><p dir="ltr">Symptoms:</p><blockquote dir="ltr"><p dir="ltr">Customers frequently call in with the above symptoms.</p><ol dir="ltr"><li><div>Clients cannot connect to the Remote Desktop Server <br><br>OR&nbsp;</div></li><li><div>RDP unexpectedly disconnects before the logon can complete <br><br>OR</div></li><li><div>RDP to Black Screen<br><br>AND</div></li><li><div>Event 4005 Winlogon - &quot;The Windows logon process has unexpectedly terminated.&quot;<br><br></div></li><li><div>A reboot usually mitigates the issue for some time.</div></li></ol></blockquote></div><div><div>There are many different potential causes for this problem. This is usually a difficult type of problem and can require many engineer hours to resolve, if the problem ever gets resolved at all.</div><div><br></div><div>The first thing to realize is that Winlogon is NOT crashing. Neither is Winlogon encountering an unhandled exception. Winlogon gracefully handles the failure state and terminates itself because it cannot continue with the logon process. This means that there will not be a memory dump or Windows Error Reporting report generated, because Winlogon doesn't crash. Procdump configured as the AeDebug post-mortem debugger similarly will not help you, because Winlogon doesn't crash.</div></div><div><div>PG has confirmed that this is not going to be fixed in Windows Server 2012 R2 vide bug number:&nbsp;https://microsoft.visualstudio.com/OS/_workitems/edit/19625737</div><div><br></div><div>Please request the customer to move to Windows Server 2016.&nbsp;</div><div><br></div><div>Please follow the below workaround troubleshooting methodology if the customer wants to continue on Windows Server 2012 R2.&nbsp;</div><div><br></div><ol><li>Step 1: Use RDSTracing:&nbsp;<a href="http://toolbox/RDSTracingRDSTracing">http://toolbox/RDSTracing<br><br>RDSTracing</a> contains many useful ETW providers, such as Winlogon, TermSvcs, Csrss, etc. that will help you diagnose the problem.<br>Using the above tracing, you will likely output similar to this:<br><font face="Times New Roman" size="3"><br></font><font face="Times New Roman">
 </font><font face="Times New Roman">
  </font><font face="Times New Roman">
 </font><font face="Times New Roman"></font><table style="margin:auto auto auto 30.2pt;border:currentColor;border-collapse:collapse;"><tbody><tr><td width="1529" style="padding:0in 5.4pt;border:1pt solid windowtext;width:1147.1pt;"><font face="Times New Roman">
  </font><p style="margin:0in 0in 0pt;"><font face="Calibri">[core] Session_cxx401 CSession::CreatePrimaryTerminal() - Will call _WinStationWaitForConnect().<br>[core] Session_cxx409 CSession::CreatePrimaryTerminal() - _WinStationWaitForConnect failed: 31 .<br>[core] winlogon_cxx493 WinMain() - CreatePrimaryTerminal failed: 31<br>[core] winlogon_cxx1078 WinMain() - Going down...<br>[core] logoff_worker_cxx714 AsyncLogoffSupportUninit() - AsyncLogoffSupportUninit() returned.<br>[core] JobManager_cxx196 JobManagerUninitialize() - JobManagerUninitialize: Job manager is uninitialized successfully.<br>[core] winlogon_cxx1267 WinMain() - Notify: ThemesOnTerminateSession ...</font></p><font face="Times New Roman">
  </font></td></tr></tbody></table><font face="Times New Roman" size="3"></font><span style="text-align:left;color:rgb(0, 0, 0);text-transform:none;text-indent:0px;letter-spacing:normal;font-family:Segoe UI,SegoeUI,&quot;Helvetica Neue&quot;,Helvetica,Arial,sans-serif;font-size:15px;font-style:normal;font-variant:normal;font-weight:400;word-spacing:0px;display:inline !important;orphans:2;">You should also see output similar to this:<br><font face="Times New Roman" size="3"><br></font><font face="Times New Roman">
 </font><font face="Times New Roman">
  </font><font face="Times New Roman">
 </font><font face="Times New Roman"></font><table style="margin:auto auto auto 30.2pt;border:currentColor;border-collapse:collapse;"><tbody><tr><td width="1529" style="padding:0in 5.4pt;border:1pt solid windowtext;width:1147.1pt;"><font face="Times New Roman">
  </font><p style="margin:0in 0in 0pt;"><font face="Calibri">[Microsoft-Windows-TerminalServices-LocalSessionManager//]An error occurred when transitioning from CsrConnected in response to EvCsrInitialized. (ErrorCode 0xD0000001) <br>Microsoft-Windows-TerminalServices-&nbsp; Attempt to send connect (2) message to Windows video subsystem failed. The relevant status code was 0xD0000001.</font></p><font face="Times New Roman">
  </font></td></tr></tbody></table><font face="Times New Roman" size="3"></font><br>Another variant may have a signature like:<br><font face="Times New Roman" size="3"><br></font><font face="Times New Roman">
 </font><font face="Times New Roman">
  </font><font face="Times New Roman">
 </font><font face="Times New Roman"></font><table style="margin:auto auto auto 30.2pt;border:currentColor;border-collapse:collapse;"><tbody><tr><td width="1529" style="padding:0in 5.4pt;border:1pt solid windowtext;width:1147.1pt;"><font face="Times New Roman">
  </font><p style="margin:0in 0in 0pt;"><font face="Calibri">[Microsoft-Windows-TerminalServices-LocalSessionManager/Debug] Session 81 has started with Initial Command Process ID 54048 and Windows Subsystem Process ID 18636 <br>[Microsoft-Windows-TerminalServices-LocalSessionManager/Debug] Transitioned successfully from Initialized to Created in response to EvCreated. 81, 0, Initialized, 1<br>[Microsoft-Windows-TerminalServices-LocalSessionManager/Debug] Transitioned successfully from Created to CsrConnected in response to EvCsrConnected. 81, 1, Created, 8<br>[Microsoft-Windows-TerminalServices-LocalSessionManager/Operational] An <strong>error</strong> occurred when transitioning from CsrConnected in response to EvCsrInitialized. (ErrorCode <strong>0x80070057</strong>) 81, 8, CsrConnected<br>[Microsoft-Windows-TerminalServices-LocalSessionManager/Operational] Session 81 has been disconnected, reason code 12</font></p><font face="Times New Roman">
  </font></td></tr></tbody></table><font face="Times New Roman" size="3"></font><br>The above trace messages allows yu to perform some preliminary code review of WINLOGON:<br><font face="Times New Roman" size="3"><br></font><font face="Times New Roman">
 </font><font face="Times New Roman">
  </font><font face="Times New Roman">
 </font><font face="Times New Roman"></font><table style="margin:auto auto auto 30.2pt;border:currentColor;border-collapse:collapse;"><tbody><tr><td width="1529" style="padding:0in 5.4pt;border:1pt solid windowtext;width:1147.1pt;"><font face="Times New Roman">
  </font><p style="margin:0in 0in 0pt;"><font face="Calibri">DWORD<br>CSession::CreatePrimaryTerminal(<br>&nbsp;&nbsp;&nbsp; PLUID pLuidConnect,<br>&nbsp;&nbsp;&nbsp; BOOL SkipWaitingForLsm<br>&nbsp;&nbsp;&nbsp; )<br>{<br>&nbsp;&nbsp;&nbsp; DWORD dwRet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = ERROR_SUCCESS;<br>&nbsp;<br>&nbsp;&nbsp;&nbsp; __try<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Wait for TS to be ready to receive calls from winlogon &lt;&lt;&lt; <strong>this times out and causes Winlogon to exit prematurely</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //<br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!SkipWaitingForLsm)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DebugTrace(TRACE_LEVEL_INFORMATION, Session,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Will call _WinStationWaitForConnect().\n&quot;);</font></p><font face="Times New Roman">
  </font></td></tr></tbody></table><font face="Times New Roman" size="3"></font><br>Which leads us to:<br><font face="Times New Roman" size="3"><br></font><font face="Times New Roman">
 </font><font face="Times New Roman">
  </font><font face="Times New Roman">
 </font><font face="Times New Roman"></font><table style="margin:auto auto auto 30.2pt;border:currentColor;border-collapse:collapse;"><tbody><tr><td width="1529" style="padding:0in 5.4pt;border:1pt solid windowtext;width:1147.1pt;"><font face="Times New Roman">
  </font><p style="margin:0in 0in 0pt;"><font face="Calibri">&nbsp; hr = this-&gt;CommonData.ptrCsrPipe-&gt;SendConnectMsg( &amp;ConnectMsg, hUserToken, TokenPidOrigin, bForceUnloadRemoteGraphicDevice );<br>&nbsp;<br>#endif<br>&nbsp;<br>&nbsp;&nbsp;&nbsp; if ( HRESULT_FROM_WIN32( ERROR_GEN_FAILURE ) == hr )<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Show the new TS error message about Video Subsystem failure.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hr = HRESULT_FROM_WIN32( ERROR_TS_VIDEO_SUBSYSTEM_ERROR );<br>&nbsp;&nbsp;&nbsp; }<font face="Calibri"><br></font></font></p><font face="Times New Roman">
  </font></td></tr></tbody></table><font face="Times New Roman" size="3"></font><br>Another snippet: <br><font face="Times New Roman" size="3"><br></font><font face="Times New Roman">
 </font><font face="Times New Roman">
  </font><font face="Times New Roman">
 </font><font face="Times New Roman"></font><table style="margin:auto auto auto 30.2pt;border:currentColor;border-collapse:collapse;"><tbody><tr><td width="1529" style="padding:0in 5.4pt;border:1pt solid windowtext;width:1147.1pt;"><font face="Times New Roman">
  </font><p style="margin:0in 0in 0pt;"><font face="Calibri">&nbsp;&nbsp;&nbsp;&nbsp; if (Is_WinStationWaitForConnectPresent() &amp;&amp; !_WinStationWaitForConnect())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwRet = GetLastError();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DebugTrace(TRACE_LEVEL_ERROR, Session,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;_WinStationWaitForConnect failed: %ld .\n&quot;,&nbsp; &lt;&lt;&lt;&lt;&lt;&lt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwRet);<br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WLEventWrite(WLEvt_WaitForLSM_Stop);<br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ASSERT(ERROR_SUCCESS != dwRet);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __leave;</font></p><p style="margin:0in 0in 0pt;"><font face="Calibri">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></p><font face="Times New Roman">
  </font></td></tr></tbody></table><font face="Times New Roman" size="3"></font><br>The above demonstrates a couple of different scenarios where Winlogon is waiting for an object, and if after a short period of time that object is still not avaiable, Winlogon gives up and terminates itself. The logon is never completed</span></li><li><span style="text-align:left;color:rgb(0, 0, 0);text-transform:none;text-indent:0px;letter-spacing:normal;font-family:Segoe UI,SegoeUI,&quot;Helvetica Neue&quot;,Helvetica,Arial,sans-serif;font-size:15px;font-style:normal;font-variant:normal;font-weight:400;word-spacing:0px;display:inline !important;orphans:2;">Identify what WINLOGON is waiting for<br><br>Using the RDSTracing above you should be able to identify what Winlogon was waiting for. Now you have to figure out who is failing to free that resource such that Winlogon can never acquire it.<br><br>An iDNA trace of Winlogon.exe is probably NOT the best next step. Using the ETW tracing you already collected, along with a little bit of code review, you can already tell what's going on inside of Winlogon. An iDNA of Winlogon will likely not reveal anything new that you don't already know.<br><br>Same goes for TermSvcs, Csrss, etc. The tracing you've already collected probably makes iDNA traces of those same processes unnecessary.<br><br>However, a FULL memory dump from the server while it is in state may prove very beneficial.</span></li></ol><div><font color="#000000" face="Segoe UI, SegoeUI, Helvetica Neue, Helvetica, Arial, sans-serif"><span style="font-size:15px;"><br></span></font></div><div><font color="#000000" face="Segoe UI, SegoeUI, Helvetica Neue, Helvetica, Arial, sans-serif"><span style="font-size:15px;">Here is an example of one fix from&nbsp;Ramesh.Kumar@microsoft.com who was able to resolve case #</span></font><span style="font-family:Calibri, sans-serif;font-size:11pt;">218080918760439003</span><span style="font-size:15px;color:rgb(0, 0, 0);font-family:&quot;Segoe UI&quot;, SegoeUI, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;">:</span></div><div><font color="#000000" face="Segoe UI, SegoeUI, Helvetica Neue, Helvetica, Arial, sans-serif"><span style="font-size:15px;">&nbsp;</span></font></div><blockquote style="margin:0 0 0 40px;border:none;"><p>&quot;Along with Winlogon crash event I also saw another error in
LSM logs.</p><p>Attempt to send connect (2) message to Windows video
subsystem failed. The relevant status code was 0xD0000001.</p><p>&nbsp;</p><p>I see in your analysis::::::::HRESULT_FROM_WIN32(
ERROR_TS_VIDEO_SUBSYSTEM_ERROR );&nbsp;</p><p>&nbsp;</p><p>Connected to remote registry from a different system.</p><p>&nbsp;</p><p>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RDPUDD\</p><p>The “Device0” key completely missing.</p><p>Created the reg key and values in it.</p><p>&nbsp;</p><table style="border-collapse:collapse;border:none;">
 <tbody><tr>
  <td width="623" style="width:467.5pt;border:solid windowtext 1.0pt;padding:0in 5.4pt 0in 5.4pt;">
  <p>[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RDPUDD\Device0]</p>
  <p>&quot;InstalledDisplayDrivers&quot;=hex(7):52,00,44,00,50,00,55,00,44,00,44,00,00,00,00,00</p>
  <p>&quot;VgaCompatible&quot;=dword:00000000</p>
  <p>&quot;Device Description&quot;=&quot;RDPUDD Chained
  DD&quot;</p>
  </td>
 </tr></tbody></table><p>&nbsp;</p><p>Rebooted the server and this resolved the issue. If the
issue returns then I would go with registry auditing as next step.&quot;</p><p>Adding into above solution RDPUDD, in some cases the above registry location not corrupted then check the following : <span style="">Check if value exist
     under HKLM\System\CurrentControlSet\Control\Terminal Server\VIDEO\RDPUDD\\<span style="background:yellow;">Device\Video0</span> (you
     can compare with working server, and if not the same export from working
     to non-working), reboot and test.</span></p></blockquote><div style="margin-top:14px;margin-bottom:14px;"><p style="margin:0in 0in 0pt;font-family:&quot;Calibri&quot;,sans-serif;font-size:11pt;margin-left:.5in;"><b><span style="font-size:8.0pt;font-family:Consolas;">In process monitor you maybe able to capture, Seems this reg not exist :</span></b></p><p style="margin:0in 0in 0pt;font-family:&quot;Calibri&quot;,sans-serif;font-size:11pt;margin-left:.5in;"><span style="font-size:8.0pt;font-family:Consolas;">3:20:08.1003728 PM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
csrss.exe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 11724&nbsp;&nbsp;
RegQueryValue&nbsp;&nbsp; HKLM\System\CurrentControlSet\Control\Terminal
Server\VIDEO\RDPUDD\\Device\Video0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME NOT
FOUND&nbsp; Length: 512&nbsp;&nbsp;&nbsp;&nbsp; Read&nbsp;&nbsp;&nbsp;
2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2</span></p><br></div><p>------------------------</p><p><br></p><p>Here is a different resolution from a separate case with the same symptoms:</p><p><br></p><p>Deleted this registry key:&nbsp;</p><p><br></p><p><span style="font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;">HKLM\System\CurrentControlSet\Enum\TERMINPUT_BUS\</span><br></p><p><br></p><p>Triggers a rebuild of the key and subkeys. It is unknown how the registry key became corrupt in the first place.</p><p style="margin:0 0 0 40px;border:none;"><br></p><p><p><p><p><p><p><p><p><p><p><p><p></div><div><p>Related Support Cases</p><ul><li>There are dozes of cases like this. Please add yours to the list in high to low case # order</li><li>118080918760439</li><li>118070618530582</li><li>118022117685879</li><li>117121317317981</li><li>117071416038792 </li><li>117031315446379 </li><li>117010315126494</li><li>114073011661907 </li><li>112071014606846 </li><li>112063008759515 </li><li>112062948912888</li><li>119062423002444 <br></li></ul></div>