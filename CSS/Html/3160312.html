<header><h1>A computer that is running Windows 10 Version 1511 reverts to a previous date and time</h1></header><div class='kb-notice-section section'>Bug #: <a id='kb-link-1' href='https://vstf-us-wa-28.partners.extranet.microsoft.com:8443/tfs/contentidea/contentidea/_workitems/edit/46012' target='_self'>46012 (Content Idea)</a></div><div class='kb-symptoms-section section'>The system date and time setting on a computer that is running Windows 10 Version 1511 (build 10586.<strong class='sbody-strong'>xx</strong>) incorrectly reverts to a date and time that is at least one day in the past. This issue may occur in the following scenario:&#160;<br><br><ul class='sbody-free_list'><li>The computer is originally connected to the Internet.</li><li>The computer is turned off and restarted while it&#39;s connected to a closed private network.</li><li>The private network has no SSL servers (and, therefore, the client has no outbound SSL traffic).</li></ul>When this issue occurs, the computer system&#39;s date and time settings are reset to their previous values, even if this change overrides any changes that were made by an administrator. The Windows Time service that&#39;s&#160;running on the computer causes this behavior by using stale Secure Time Seeding information from the registry. In this scenario, the Windows Time service effectively stops using time that is obtained from any Network Time Protocol (NTP) server or the Active Directory hierarchy.&#160;<br><br>Additional symptoms include but are not limited to the following:<br><ul class='sbody-free_list'><li>Kernel-General event 1 in the system&#160;log&#160;indicates that the time setting has been reset to a past value.</li><li>Events that are recorded in the event log have invalid time stamps that are in the past.</li><li>Kerberos authentication fails.</li></ul></div><div class='kb-cause-section section'>This issue occurs because of a problem in the new Secure Time Seeding feature that is part of Windows Time service in Windows 10 Version 1511. This feature uses metadata from outgoing SSL connections from the computer to determine the approximate current time and date values, and it stores this data in the registry. When the computer restarts, the old registry data is not cleared or updated if, for any reason, no outgoing SSL traffic is present since the startup. This can cause the issue that&#39;s described in the &quot;Symptoms&quot; section.&#160;</div><div class='kb-workaround-section section'><span class='text-base'>Important</span>&#160;Follow the steps in this section carefully. Serious problems might occur if you modify the registry incorrectly. Before you modify it,&#160;<a id='kb-link-2' href='/en-us/help/322756'>back up the registry for restoration  </a> in case problems occur.<br><br>To work around this issue, try either Method 1 or Method 2, depending on your network environment.&#160;<br><br><span class='text-base'>Method 1: Clear the W32time registry values and force synchronize the time over NTP</span><br><br>You can clear the w32time registry state to force synchronize the time on the computer with the internal NTP/NT5DS server. To do this, run the following sequence of commands at an elevated command prompt:<br><br><div class='indent'><span class='text-base'><pre class='sbody-pre'>Net stop w32time<br><br>W32tm.exe /unregister<br><br>W32tm.exe /register<br><br>net start w32time<br><br>W32tm.exe /resync /force </pre></span></div><span class='text-base'>Method 2: Reconnect to the Internet</span><br><br>Reconnect the computer to the Internet. This issue is corrected after the computer has access to the SSL&#160;servers on the Internet and has outbound SSL traffic.<br><br><span class='text-base'>Optional Method 3: Disable Secure Time Seeding</span><br><br><span class='text-base'>Important</span>&#160;We recommend that you try Workarounds 1&#160;or 2 before you disable the Secure Time Seeding feature. Disabling the feature keeps it disabled even after you upgrade to a newer version of Windows in which the issue has been fixed.&#160;<br><br>To disable the Secure Time Seeding feature, set the UtilizeSslTimeData DWORD value to&#160;<strong class='uiterm'>0</strong> (zero):<br><br><div class='indent'><span class='text-base'>Registry subkey:</span><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\Config</strong><br><span class='text-base'><br>Value name:</span> UtilizeSslTimeData<br><span class='text-base'>Value data:</span> 0<br><span class='text-base'>Value type:</span> DWORD<br></div><br>To do this, run the following command at an elevated command prompt, and then restart the computer:<br><br><div class='indent'><span class='text-base'><pre class='sbody-pre'>reg add  HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\W32Time\Config /v UtilizeSslTimeData /t REG_DWORD /d 0 /f </pre></span></div>After the computer restarts, force synchronize the system time over NTP by running the following commands&#160;at an elevated command prompt:<br><br><div class='indent'><span class='text-base'><pre class='sbody-pre'>Net start w32time<br>W32tm.exe /resync /force </pre></span></div><span class='text-base'>Note</span> To re-enable the Secure Time Seeding feature, change the UtilizeSslTimeData value data to <strong class='uiterm'>1</strong>.&#160;To do this, run the following command at an elevated command prompt, and then restart the computer:<br><br><div class='indent'><span class='text-base'><pre class='sbody-pre'>reg add  HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\W32Time\Config /v UtilizeSslTimeData /t REG_DWORD /d 1 /f </pre></span></div></div><div class='kb-workaround-section section'>Track the status of bug <a id='kb-link-3' href='https://microsoft.visualstudio.com/defaultcollection/wssc/_workitems#_a=edit&id=6257513' target='_self'>6257513</a>.<br><br>Current status as of 2016.03.08 is that the problem is fixed in the Redstone 1 release of Windows 10. No backports have been requested due to a lack of volume and impact. <br><br>The fix FI’d to rs1_release on February 22, 2016. It should be available in rs1_release builds after that. If you have an enlistment, you can verify by using the following command (the particular file was modified in this change):<br><br><div class='indent'><span class='text-base'><pre class='sbody-pre'>sdv //depot/rs1_release/onecore/ds/security/services/w32time/lib/TimeHelperFunctions.cpp </pre></span></div><br><span class='text-base'>Note</span> The fix will be in the Server 2016 TP2 release and the next Windows 10 client public release.</div><div class='kb-moreinformation-section section'><h3 class='sbody-h3'>Support Agent information</h3><h4 class='sbody-h4'>Location of registry values</h4>The following values are added to the registry:<br><br><ul class='sbody-free_list'><li><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\w32time\Config</strong><br><br><div class='indent'><span class='text-base'>UseSslTimeData</span> - DWORD Type (nonzero value: Use the SSL time data. We do not want to ask users to turn off this feature. This is true even when you use this fix for transient issues because they will never turn it back on even if it would help them. Use this fix only as the last option.)</div></li><li><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\w32time\SecureTimeLimits</strong><br><br><div class='indent'><span class='text-base'>SecureTimeConfidence</span> - DWORD type (&gt;= 6 is high confidence and we want the ability to change this definition as required)<br><br><span class='text-base'>SecureTimeTickCount</span> - QWORD type (local computer tick count when the secure time was determined)<br><br><span class='text-base'>SecureTimeHigh/Estimated/Low</span> - QWORD type (high/estimated/low values of the determined &quot;secure time range&quot;)</div></li></ul><h4 class='sbody-h4'>Troubleshooting</h4>There are new debug flags to capture this feature. Run the following updated command at an administrative command prompt to gather data that includes the new feature:<br><br><div class='indent'><span class='text-base'><pre class='sbody-pre'>W32tm /debug /enable /file:c:\w32time.log /size:10000000 /entries:0-1100 </pre></span></div><br><span class='text-base'>Note</span> A restart is required for this command to take effect on the SSL data collection part. This generates two log files named c:\w32time.log*.<br><br><h4 class='sbody-h4'>Additional information</h4>We can&#39;t rely on NTP to provide us a reliable time value. This has been a single point of failure in the NTP server chain, and this is why we imposed limits on the changes that we accept over NTP. We cannot be sure whether the time we receive over NTP is always good. This new feature is the backup mechanism to prevent incorrect time changes on each computer that uses SSL-based time.<br><br>This feature is to securely determine the time to within &#177;15 hours accuracy of the actual time and use this information in combination with existing secured/unsecured NTP to sync time. The combined solution will help maintain time securely, accurately, and in a scalable manner on all connected Windows clients.<br><br>Windows Client is being designed to be increasingly a connected OS. As with existing versions of Windows, SSL/PKI is the primary choice for secure network communication over the Internet for OS components and for applications. There is an ongoing effort by OSG Security to improve the SSL performance in Windows by centralizing some SSL Certificate processing to reduce duplication in certificate validation and other related performance improvements.<br><br>SSL protocol uses server system time and various time stamps as part of its handshake. This time information in isolation is not very accurate for time synchronization purposes. However, the centralization of SSL processing gives us sufficient information from various SSL connections to enable us to securely compute an approximate secure time on the client that is good enough to be used for synchronization purposes.<br><br>Time information can be gleaned securely from SSL connections to Microsoft and non-Microsoft servers and can be used to boot-strap system time on the client to enable unsecure NTP to synchronize time more precisely.<br><br>Tablets and other newer Windows client devices depend completely on a rechargeable battery to power their system clocks. This includes when the device is turned off or hibernating. A battery drain causes the system clock to be reset to a random value in most cases.<br><br>Secure network protocols, such as SSL, depend on client system time. Several applications and scenarios break when the client system time is completely incorrect.<br><br>In the battery discharge scenario, we cannot correct synchronize clocks securely over the network if the system time is set to a random value. Fixing system time securely requires us to resolve a circular dependency between time and security.<br><br>Because Windows Client OS implicitly trusts Microsoft Product servers and to a degree trusts servers w/certs pinned to the Microsoft Root CA, the client could ignore time based restrictions on these connections to break the circular dependency between secure protocols and client system time.<br><br>Time information can be gleaned securely from SSL connections to Microsoft and non-Microsoft servers. This information can be used to bootstrap system time on the client.</div><div class='kb-moreinformation-section section'><h3 class='sbody-h3'>Steps to reproduce the issue</h3><ol class='sbody-num_list'><li>Start a computer that is running Windows 10 Version 1511 in an Active Directory domain on a public network that has access to SSL Time servers on the Internet. <br><br><span class='text-base'>Note</span> This causes Secure Time and high confidence values to be saved in the registry.</li><li>Shut down the computer so that Secure Time and high confidence are persisted in the registry.</li><li>Start the same Windows 10-based computer on a private network that has no network access to SSL Time Servers. <br><br><span class='text-base'>Note</span> This causes the SecureTimeAggregator.dll to never load.</li></ol>In this scenario, W32time starts and initially rejects the secure time value in the registry because of a large tick count, although the confidence value is high.<br><br>After some run time, the large tick count from the registry becomes valid. W32time considers the secure time from the registry to be valid and of high confidence.<br><br>If the current system clock is outside the secure time range by more than 15 hours, the system clock is set by W32time to an incorrect time in the <span class='text-base'>\SecureTimeLimits</span> registry setting value.</div><div class='kb-moreinformation-section section'><span class='text-base'>Related Bugs</span><br><div class='table-responsive'><table class='sbody-table table'><tr class='sbody-tr'><th class='sbody-th'>Bug #</th><th class='sbody-th'>Synopsis</th></tr><tr class='sbody-tr'><td class='sbody-td'>WSSC <a id='kb-link-4' href='https://microsoft.visualstudio.com/defaultcollection/wssc/_workitems#_a=edit&id=6257513' target='_self'>6257513</a>.</td><td class='sbody-td'>Marked for RS. The fix requires SecureTimeAggregator.dll to detect shutdown and clear the registry and also for W32time to bad secure time scenario (as detected in step 5 above) and clear the registry.</td></tr><tr class='sbody-tr'><td class='sbody-td'></td><td class='sbody-td'></td></tr></table></div><br><span class='text-base'>Related Content</span><br><div class='table-responsive'><table class='sbody-table table'><tr class='sbody-tr'><th class='sbody-th'>Resource</th><th class='sbody-th'>Synopsis</th></tr><tr class='sbody-tr'><td class='sbody-td'></td><td class='sbody-td'></td></tr><tr class='sbody-tr'><td class='sbody-td'></td><td class='sbody-td'></td></tr></table></div><br><span class='text-base'>Related Social Media Threads</span><br><div class='table-responsive'><table class='sbody-table table'><tr class='sbody-tr'><th class='sbody-th'>Resource</th><th class='sbody-th'>Synopsis</th></tr><tr class='sbody-tr'><td class='sbody-td'></td><td class='sbody-td'></td></tr><tr class='sbody-tr'><td class='sbody-td'></td><td class='sbody-td'></td></tr></table></div><br></div><div class='kb-securedata-section section'><span class='text-base'>KE: v-ych<br>Author: paulhut</span><br><span class='text-base'>Writer: v-thomr</span><br><span class='text-base'>Tech Reviewer: <span class='text-base'>paulhut; dongwang; menglin</span></span><br><span class='text-base'>Editor: v-jesits</span></div>