<header><h1>Debugging: Capturing a time travel debug (TTD) trace</h1></header><span asset="4476087" contenteditable="false" unselectable="on" props="{&#34;size&#34;:&#34;full&#34;}">[Asset 4476087]</span><ul><li><strong>Content Idea (CI): </strong><a managed-link="" href="https://aka.ms/CIEdit?id=82147" target="" data-content-type="" data-content-id="" bookmark-id="">82147</a></li></ul><div><div>This article covers how to capture a Time Travel Debug (TTD) trace of a process or service.<br></div><div><br>Notes:&nbsp;</div><ul><li>Process tracing is often not the right data to collect for a particular issue.&nbsp; If you are unsure, please discuss with your TL or an EE to avoid delays and overhead that can result from collecting data that cannot be used to progress your SR.</li><li>Always use the latest binaries from the share below.</li><li>TT<b>D</b> (Time Travel Debugging) is the current process tracing tool and should be used on all operating systems Win7 / Server 2008 R2 and newer.&nbsp;&nbsp;</li><li>TT<b>T</b> (Time Travel Tracing) or iDNA are legacy products.&nbsp; Do not use them.</li></ul></div><div><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><b>Use the latest version from&nbsp;<a href="file://dbg/privates/LKG/partner">\\dbg\privates\LKG\partner</a> and upload it to the customer workspace.</b></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><b><br></b></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;">Note:&nbsp;If it is difficult for the customer to use this tool due to company policy, etc, Windows 10 RS5 (client only) and newer have tttracer.exe included with the operating system. This inbox version is not the same as the distribution linked above and the instructions to use it will be somewhat different from the ones below.&nbsp; Please see this link for more information:&nbsp;&nbsp;<a href="https://osgwiki.com/wiki/TTD_Inbox_Recorder">https://osgwiki.com/wiki/TTD_Inbox_Recorder</a></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><br></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><span style="font-size:11pt;">Customer ready instructions:</span></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><br></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;">1) Download the file&nbsp;PartnerTTDRecorder_x86_x64.zip<span style="font-size:11pt;">&nbsp;from the workspace and extract it to c:\ttd.</span></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;">2) Disable Secure Boot (if enabled) - Secure Boot will block the TTD driver from loading.</p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;">3) Start an <span style="font-weight:bold;">administrative</span> command prompt.</p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;">4) Note t<span style="font-size:11pt;">his tool requires a EULA to be read and agreed to by you, the customer.&nbsp;&nbsp;</span><span style="font-size:11pt;">If you need to work around this for some scenario please ensure you read the EULA and agree to it, then you can set the following registry key as needed on other systems:</span></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><span style="font-size:11pt;"><br></span></p><blockquote style="margin:0 0 0 40px;border:none;"><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><span style="background-color:rgb(248, 249, 250);font-family:monospace, Courier;font-size:13.93px;">HKEY_USERS\.DEFAULT\Software\Microsoft\TTT</span></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><span style="background-color:rgb(248, 249, 250);font-family:monospace, Courier;font-size:13.93px;">&quot;EULASigned&quot;=dword:00000001</span></p></blockquote><p style="margin:0in;margin-left:.375in;font-family:Calibri;font-size:11.0pt;">&nbsp;</p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;">5) Trace Scenarios:</p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;">&nbsp;</p><ul style="margin-left:.375in;direction:ltr;unicode-bidi:embed;margin-top:0in;margin-bottom:0in;">
 <li style="margin-top:0;margin-bottom:0;vertical-align:middle;"><span style="font-family:Calibri;font-size:11.0pt;"><b>Scenario 1</b>: Trace a running process (attach):</span></li>
 <ul><li><span style="font-size:10pt;font-family:Consolas;">tttracer -attach &lt;PID&gt; -dumpfull</span></li>
 <ul><li><span style="font-family:Calibri;font-size:14.6667px;">NOTE: For processes with large caches of memory (e.g. lsass.exe on a DC), you can replace -dumpfull with -dumpmodules&nbsp;&nbsp;</span></li></ul><li><span style="font-family:Calibri;"><span style="font-size:11pt;">Wait for tracing window to appear:</span><span style="font-size:14.6667px;"><br><span asset="4574229" contenteditable="false" unselectable="on" props="{&#34;size&#34;:&#34;full&#34;}">[Asset 4574229]</span><br></span></span></li></ul></ul><blockquote style="margin:0 0 0 40px;border:none;"><blockquote style="margin:0 0 0 40px;border:none;"></blockquote></blockquote><blockquote style="margin:0 0 0 40px;border:none;"><blockquote style="margin:0 0 0 40px;border:none;"></blockquote></blockquote><blockquote style="margin:0 0 0 40px;border:none;"><blockquote style="margin:0 0 0 40px;border:none;"></blockquote></blockquote><blockquote style="margin:0 0 0 40px;border:none;"><blockquote style="margin:0 0 0 40px;border:none;"></blockquote></blockquote><blockquote style="margin:0 0 0 40px;border:none;"><blockquote style="margin:0 0 0 40px;border:none;"></blockquote></blockquote><blockquote style="margin:0 0 0 40px;border:none;"><blockquote style="margin:0 0 0 40px;border:none;"></blockquote></blockquote><blockquote style="margin:0 0 0 40px;border:none;"><blockquote style="margin:0 0 0 40px;border:none;"></blockquote></blockquote><ul style="margin-left:.375in;direction:ltr;unicode-bidi:embed;margin-top:0in;margin-bottom:0in;"><ul><li><span style="font-family:Calibri;font-size:11pt;">Repro issue</span></li><li><span style="font-family:Calibri;font-size:11pt;">To stop tracing, uncheck the &quot;Tracing On&quot; checkbox.</span><span style="font-family:Calibri;font-size:11pt;">&nbsp; </span><span style="font-family:Calibri;font-size:11pt;">Do </span><b style="font-family:Calibri;font-size:11pt;">NOT</b><span style="font-family:Calibri;font-size:11pt;"> click the &quot;Exit App&quot; button unless you want the application to terminate.</span></li></ul></ul><p style="margin:0in;margin-left:.75in;">&nbsp;</p><ul style="margin-left:.375in;direction:ltr;unicode-bidi:embed;margin-top:0in;margin-bottom:0in;"><li style="margin-top:0px;margin-bottom:0px;vertical-align:middle;"><span style="font-family:Calibri;font-size:11pt;"><b>Scenario 2</b>: Trace a process from launch but launched independently:</span></li><ul><li><span style="font-family:Consolas;font-size:10pt;">tttracer -onlaunch &lt;ProcessBinaryName.exe&gt; -out c:\ttd</span></li><li><span style="font-family:Calibri;font-size:11pt;">Leave command window running until after trace is complete.</span></li><li><span style="font-family:Calibri;font-size:11pt;">Start the process.&nbsp;&nbsp;TTD will attach and start tracing - you can verify by watching command window.</span></li><li><span style="font-family:Calibri;font-size:11pt;">Repro issue.</span></li><li><span style="font-family:Calibri;font-size:11pt;">Uncheck the &quot;Tracing On&quot; checkbox.&nbsp; Do not click &quot;Exit App&quot; unless you want the application to terminate.</span></li><li><span style="font-family:Calibri;font-size:11pt;">To stop the on-launch tracing use:</span></li><ul><li><span style="font-family:Consolas;font-size:10pt;">tttracer -delete &lt;ProcessBinaryName.exe&gt;</span></li><li><span style="font-family:Calibri;font-size:11pt;">Ignore the error displayed, it will correctly stop the process from being traced on future launches.<br><br></span></li></ul></ul>
 <li style="margin-top:0;margin-bottom:0;vertical-align:middle;"><span style="font-family:Calibri;font-size:11.0pt;"><b>Scenario 3</b>: Trace a service:</span></li>
 <ul><li><span style="font-family:Consolas;font-size:10pt;">tttracer -onlaunch &lt;servicename&gt; -out c:\ttd</span></li><li><span style="font-family:Calibri;font-size:11pt;">Leave command window running until after trace is complete.</span></li><li><span style="font-family:Calibri;font-size:11pt;">Restart service.</span><span style="font-family:Calibri;font-size:11pt;">&nbsp; </span><span style="font-family:Calibri;font-size:11pt;">Tttracer will attach and start tracing - you can verify by watching command window.</span></li><li><span style="font-family:Calibri;font-size:11pt;">Repro issue.</span></li><li><span style="font-family:Calibri;font-size:11pt;">Stop service.<br><br></span></li></ul><li><b style="box-sizing:border-box;font-family:Calibri;font-size:14.66px;font-weight:700;">Scenario 4</b><span style="display:inline !important;background-color:rgba(255, 255, 255, 1);font-family:Calibri;font-size:11pt;">: Trace a process started by TTD</span>:</li><ul><li><span style="font-family:Consolas;font-size:10pt;">tttracer </span><span style="font-family:Consolas;font-size:10pt;"> -out c:\ttd</span><span style="font-family:Consolas;font-size:10pt;"> -launch &lt;ProcessBinaryName.exe&gt; &lt;parameters&gt;</span></li><li><span style="font-family:Calibri;font-size:11pt;">Tttracer starts tracing - you can verify by watching command window.</span></li><li><span style="font-family:Calibri;font-size:11pt;">Repro issue.</span></li><li><span style="font-family:Calibri;font-size:11pt;">Uncheck the &quot;Tracing On&quot; checkbox.&nbsp; Do not click &quot;Exit App&quot; unless you want the application to terminate.</span></li></ul></ul><ul style="margin-left:.375in;direction:ltr;unicode-bidi:embed;margin-top:0in;margin-bottom:0in;"><ul style="margin-left:.375in;unicode-bidi:embed;margin-top:0in;margin-bottom:0in;">
 </ul>
 </ul><div><font face="Calibri"></font><br></div><p style="margin:0in;font-family:Calibri;font-size:11.0pt;">6) Zip the newly created .run and .out files and upload them to the workspace.</p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;">&nbsp;</p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><br></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><span style="font-weight:bold;text-decoration-line:underline;">Process specific tracing instructions:</span></p><p style="margin:0in;font-family:Calibri;font-size:11.0pt;"><div>wmiprvse.exe:</div><p><div><ul><li style="margin-bottom:0px;margin-top:0px;vertical-align:middle;"><span style="outline:none;font-family:Consolas;font-size:10pt;">net stop winmgmt</span></li><li style="margin-bottom:0px;margin-top:0px;vertical-align:middle;"><span style="outline:none;font-family:Calibri;font-size:11pt;">Verify all wmiprvse.exe processes are gone - if not, terminate them.</span></li><li style="margin-bottom:0px;margin-top:0px;vertical-align:middle;"><span style="outline:none;font-family:Consolas;font-size:10pt;">tttracer -onlaunch wmiprvse.exe -parent * -numVCpu 4 -out c:\ttd</span></li><li style="margin-bottom:0px;margin-top:0px;vertical-align:middle;"><span style="outline:none;font-family:Calibri;font-size:11pt;">Leave command window running until after trace is complete.</span></li><li style="margin-bottom:0px;margin-top:0px;vertical-align:middle;"><span style="outline:none;font-family:Consolas;font-size:10pt;">net start winmgmt</span></li><li style="margin-bottom:0px;margin-top:0px;vertical-align:middle;"><span style="outline:none;font-family:Calibri;font-size:11pt;">Tttracer will attach and start tracing - you can verify by watching command window.</span></li><li style="margin-bottom:0px;margin-top:0px;vertical-align:middle;"><span style="outline:none;font-family:Calibri;font-size:11pt;">Repro issue.</span></li><li style="margin-bottom:0px;margin-top:0px;vertical-align:middle;"><span style="outline:none;font-family:Calibri;font-size:11pt;">Ctrl-Break the tttracer.exe window to stop tracing new instances of wmiprvse.exe.</span></li><li style="margin-bottom:0px;margin-top:0px;vertical-align:middle;"><span style="outline:none;font-family:Calibri;font-size:11pt;">Uncheck the &quot;Tracing On&quot; checkbox(es).&nbsp; There may be more than one.</span><span style="outline:none;font-family:Calibri;font-size:11pt;">&nbsp;</span></li></ul><div><br></div><font face="Calibri"><p style="font-size:11pt;box-sizing:border-box;margin:0in;font-family:Calibri;">LogonUI.Exe:</p><ul style="font-size:14.6667px;"><li><div style="box-sizing:border-box;margin:0in;font-family:Calibri;font-size:11pt;">You cannot trace the initial instance of LogonUI after boot (with the /persistent option).</div></li><li><div style="box-sizing:border-box;margin:0in;font-family:Calibri;font-size:11pt;">You can use scenario 2 for LogonUI.</div></li><li><div style="box-sizing:border-box;margin:0in;font-family:Calibri;font-size:11pt;">As you logoff or logon, lock and unlock, there will be multiple instances of logonUI started. We recommend to write down the exact time the when the logonUI interaction has started and ended.</div></li></ul><div style="font-size:14.6667px;"><br></div><div style="font-size:14.6667px;">LSASS.Exe:</div><div style="font-size:14.6667px;"><ul><li><div style="box-sizing:border-box;font-size:11pt;margin-bottom:0in;margin-left:0in;margin-right:0in;margin-top:0in;">You need to set RunAsPPL=0 and reboot.</div></li><li><div style="box-sizing:border-box;font-size:11pt;margin-bottom:0in;margin-left:0in;margin-right:0in;margin-top:0in;">Be very cautious about machine impact when tracing domain controllers, here LSASS often is a very busy multi-threaded server application and generated huge traces.</div></li><li><div style="box-sizing:border-box;font-size:11pt;margin-bottom:0in;margin-left:0in;margin-right:0in;margin-top:0in;">Advanced scenarios like tracing until an exception happens may require the use of &quot;-ringmode&nbsp; mappedfile&quot;. Talk to a code EE for details.<br></div></li></ul><br></div><div style="font-size:14.6667px;"><br></div><p style="font-size:11pt;box-sizing:border-box;margin:0in;font-family:Calibri;">Other notes:</p><ol style="font-size:14.6667px;"><li><div style="box-sizing:border-box;margin:0in;font-family:Calibri;font-size:11pt;">TTD traces can get large quickly.<span style="box-sizing:border-box;">&nbsp;<span>&nbsp;</span></span>Please ensure you keep the repro as quick as possible.<br></div></li><li><div style="box-sizing:border-box;margin:0in;font-family:Calibri;font-size:11pt;">It is normal for tracing to slow down the target process while it is being traced.<br></div></li><li><div style="box-sizing:border-box;margin:0in;font-family:Calibri;font-size:11pt;">If you have issues tracing ensure the account is a member of the Administrators group AND has the Debug Programs privilege.<span style="box-sizing:border-box;">&nbsp;<span>&nbsp;</span></span>Antivirus has also been found to block tracing sometimes, so uninstalling AV temporarily can be tried as well.<br></div></li><li><div style="box-sizing:border-box;margin:0in;font-family:Calibri;font-size:11pt;">TTD was only designed to attach to/trace a process<span>&nbsp;</span><b style="box-sizing:border-box;">once<span>&nbsp;</span></b>during the process lifetime.<span style="box-sizing:border-box;">&nbsp;<span>&nbsp;</span></span>If you need to re-trace it, you may need to restart the process.&nbsp; Sometimes retracing the process works, sometimes it doesn't.<br></div></li><li><div style="box-sizing:border-box;margin:0in;font-family:Calibri;font-size:11pt;">In some cases you may need to run the trace in circular &quot;ring&quot; mode - in that case the command is tttracer -attach &lt;PID&gt; -ring -maxfile 2048.<br></div></li><li><div style="box-sizing:border-box;margin:0in;font-family:Calibri;font-size:11pt;">TTD tracing is a technology that is not 100% reliable and is still a work in progress.&nbsp; Because it hooks the process at a very low level, things may not always work out as expected.&nbsp; Sometimes the trace may fail to attach to the service or process, sometimes the process may terminate unexpectedly, etc.<br></div></li><li><div style="box-sizing:border-box;margin:0in;font-family:Calibri;font-size:11pt;">After the trace is completed, you should review that the run file was successfully created and the .out file indicates a successful capture.&nbsp; The .out file can be opened in any text editor. Also make sure the customer sends the OUT file as well.<br></div></li></ol><div><span style="font-size:14.6667px;"><br></span></div><div><span style="font-size:14.6667px;"><br></span></div><div><span style="font-size:14.6667px;"><br></span></div><div><span style="font-size:14.6667px;"><br></span></div><div><span style="font-size:14.6667px;"><b>Special Scenarios</b></span></div><div><span style="font-size:14.6667px;"><br></span></div><div><span style="font-size:14.6667px;">Collecting a TTD from a remote computer via PSEXEC</span></div><div><ol><li><div><span style="font-size:14.6667px;">Copy the TTD tools to a directory on the target machines drive (e.g. c:\TTD)</span></div></li><li><div><span style="font-size:14.6667px;">Open 2 command prompts (we will call them command prompt #1 and command prompt #2)</span></div></li><li><div><span style="font-size:14.6667px;">In both of the command prompts launch psexec <a>\\&lt;name</a>&nbsp;or ip address of target&gt; cmd</span></div></li><li><div><span style="font-size:14.6667px;">Run hostname to confirm you command prompt is running on the target machine (if not, back to step 3)</span></div></li><li><div><span style="font-size:14.6667px;">Change directories into the folder you created in step 1</span></div></li><li><div><span style="font-size:14.6667px;">Use tasklist to get the PID of the process you want to trace (tip: filter the output using findst. e.g. tasklist | findstr winlogon)</span></div></li><li><div><span style="font-size:14.6667px;">In command prompt </span><span style="font-size:14.6667px;">#1, start the tracing: tttracer -dumpfull -noui -attach &lt;pid from step 6&gt; -out c:\TTT\repro.run</span></div></li><li><div><span style="font-size:14.6667px;">Reproduce the issue</span></div></li><li><div><span style="font-size:14.6667px;">In command prompt #2, stop the tracing: tttracer -stop *</span></div></li><li><div><span style="font-size:14.6667px;">Collect the output files, e.g. repro.run and repro.out</span></div></li></ol><div><span style="font-size:14.6667px;"><b>Collecting a TTD during the setup, usually for mighost.exe</b></span></div><div><span style="font-size:14.6667px;">During the setup 3 operating systems are running: old OS, WinRE, new OS.</span></div><div><span style="font-size:14.6667px;"><br></span></div><div><span style="font-size:14.6667px;">To collect a TTD trace of mighost.exe when each time it runs edit this registry value:</span></div><div><span style="font-size:14.6667px;">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows
NT\CurrentVersion\Image File Execution
Options\mighost.exe\Debugger =&nbsp;C:\TTD\TTTracer.exe -out C:\TTD -timer 300 -dumpfull -launch<br></span></div><div><span style="font-size:14.6667px;"><br></span></div><div><span style="font-size:14.6667px;">However this will work only for the old OS and the new OS because they use the same registry.</span></div><div><span style="font-size:14.6667px;">It will not work for the WinRE phase because another registry is used.</span></div><div><span style="font-size:14.6667px;"><br></span></div><div><span style="font-size:14.6667px;">To modify the registry used by WinRE:</span></div><ol style="box-sizing:border-box;padding-left:40px;font-family:Calibri;font-size:14px;text-align:start;"><li style="box-sizing:border-box;"><div style="box-sizing:border-box;"><span style="box-sizing:border-box;font-size:14.6667px;">Copy the installation DVD to a folder in the local hard drive, such as C:\SETUP</span></div></li><li style="box-sizing:border-box;"><div style="box-sizing:border-box;"><span style="box-sizing:border-box;font-size:14.6667px;">Create two folders for mounting the images, such as C:\MNT and C:\MNTRE</span></div></li><li style="box-sizing:border-box;">Find the index of the image that you need:<br><p style="margin:0in;">dism /get-wiminfo
/wimfile:C:\setup\sources\install.wim</p><p style="margin:0in;">&nbsp;</p><p style="margin:0in;">Index : <span style="background-color:rgb(255, 255, 0);">5</span></p><p style="margin:0in;">Name : Windows 10
Pro</p><p style="margin:0in;">Description :
Windows 10 Pro</p><p style="margin:0in;">Size :
14,275,707,207 bytes</p></li><li style="box-sizing:border-box;"><div style="margin:0px 0in;">Mount the install image with the right index:<br>dism /mount-wim /wimfile:C:\setup\sources\install.wim <span style="background-color:rgb(255, 255, 0);">/index:5</span> /mountdir:C:\MNT<br></div></li><li style="box-sizing:border-box;"><div style="margin:0px 0in;">Find the index in the WinRE image:<br><span>dism /get-wiminfo /wimfile:C:\MNT\Windows\System32\Recovery\winre.wim<br></span><div><br></div><div>Index :<span style="background-color:rgb(255, 255, 0);"> 1</span><br></div><div>Name : Microsoft Windows Recovery Environment (x64)<br></div><div>Description : Microsoft Windows Recovery Environment (x64)<br></div><span>Size : 2,002,785,534 bytes</span><br></div></li><li style="box-sizing:border-box;"><div style="margin:0px 0in;"><span>Mount the WnRE image with the correct index:<br>dism /mount-wim /wimfile:C:\MNT\Windows\System32\Recovery\winre.wim </span><span style="background-color:rgb(255, 255, 0);">/index:1</span><span> /mountdir:C:\MNTRE<br></span></div></li><li style="box-sizing:border-box;"><div style="margin:0px 0in;"><span>From C::\MNTRE\ subfolder load the SOFTWARE hive and make the change above, then unload it</span></div></li><li style="box-sizing:border-box;"><div style="margin:0px 0in;"><span>Unmount and commit the WINRE image:<br>dism /unmount-wim /mountdir:c:\mntre /commit<br></span></div></li><li style="box-sizing:border-box;"><div style="margin:0px 0in;">Unmount and commit the INSTALL image:<br>dism /unmount-wim /mountdir:c:\mnt /commit<br></div></li><li style="box-sizing:border-box;"><div style="margin:0px 0in;">Run the setup from C:\SETUP</div></li></ol><div><span style="font-size:14.6667px;"><br></span></div><span style="font-size:14.6667px;"></span></div><div><span style="font-size:14.6667px;"></span></div></font></div></div>