<header><h1>Slow performance when you use a mapped drive to copy files to a remote server from a Windows Server 2003-based computer</h1></header><div class='kb-notice-section section'><div internal-content-body=""><div class="internal-content"><div class="bold internal-content-body-title spacer-12-bottom">Microsoft Internal Support Information</div><div class="row"><div class="col-xs-24 internal-content-body-content"><p>BUG #: <a href='http://bugcheck/bugs/ContentMaintenance/26632.asp' title='Link only available for Microsoft corporate network users' target='_blank'>26632 (Content Maintenance)</a></p></div></div></div></div></div><div class='kb-symptoms-section section'>You may notice slower than expected copy performance if you use  the Server Message Block (SMB) protocol to copy files from a computer that is running Microsoft Windows Server 2003 or from a Windows Server 2003 Terminal Services session to a computer on your network that is running Microsoft Windows 2000 Server or Microsoft Windows NT 4.0 Server.  You experience these symptoms if you use a mapped drive to connect to the network share.   When you analyze a network capture, Network Monitor shows the following excessive SMB Notify Change traffic: <div class='indent'> SMB C NT transact - Notify Change <br>SMB R NT transact </div>You do not experience these symptoms if you connect to the network share   by using a UNC path.</div><div class='kb-cause-section section'>This issue may occur  if a delayed TCP/IP acknowledgment, also known as a TCP ACK, occurs in an &quot;SMB: C NT transact - Notify Change&quot; packet. Typically, this issue occurs if you use Windows Explorer to copy a large number of files and folders. Change Notify requests in Windows Explorer occur more frequently when you use a mapped drive than when you use a UNC path to connect to the network share. Therefore, users who are logged on to a Windows Server 2003 Terminal Services session and who use a mapped drive may experience performance issues with Windows Explorer.</div><div class='kb-workaround-section section'><span><span class='text-base'>Important</span> This section, method, or task contains steps that tell you how to modify the registry. However, serious problems might occur if you modify the registry incorrectly. Therefore, make sure that you follow these steps carefully. For added protection, back up the registry before you modify it. Then, you can restore the registry if a problem occurs. For more information about how to back up and restore the registry, click the following article number to view the article in the Microsoft Knowledge Base: <div class='indent'><a id='kb-link-1' href='/en-us/help/322756'>322756 </a> How to back up and restore the registry in Windows</div></span><br><br>To work around  this issue, follow these steps: <ol class='sbody-num_list'><li>Install the hotfix that is documented in the following article in the Microsoft Knowledge  Base: <span><div class='indent'><a id='kb-link-2' href='/en-us/help/831129'>831129 </a> Folder tree flickers when you view a mapped network drive in Microsoft Windows Explorer <br><br></div></span></li><li>Add the NoRemoteRecursiveEvents registry entry to the following registry subkey, and then set the entry to 1: <div class='indent'><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer </strong></div>When you set the NoRemoteRecursiveEvents registry entry to 1, Change Notify requests are turned off for file and folder changes that occur in subfolders of a mapped network share. The server still sends a Change Notify event when a file or a folder is changed in the root and first folder level of the mapped network share. However, the server does not send a Change Notify event when a change is made at the level of the second subfolder or deeper in the mapped network share.<br><br><br>To add the NoRemoteRecursiveEvents registry entry to the following registry subkey, and then set the entry to 1, follow these steps: <ol class='sbody-alpha_list'><li>Click <strong class='uiterm'>Start</strong>, click <strong class='uiterm'>Run</strong>, type <span class='sbody-userinput'>regedit</span>, and then click <strong class='uiterm'>OK</strong>.</li><li>Locate and then click the following registry subkey: <div class='indent'><strong class='uiterm'><strong class='sbody-strong'>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer </strong></strong></div></li><li>On the <strong class='uiterm'>Edit</strong> menu, point to <strong class='uiterm'>New</strong>, and then click <strong class='uiterm'>DWORD Value</strong>.</li><li>Type <span class='sbody-userinput'>NoRemoteRecursiveEvents</span>, and then press ENTER.</li><li>On the <strong class='uiterm'>Edit</strong> menu, click <strong class='uiterm'>Modify</strong>.</li><li>Type <span class='sbody-userinput'>1</span> in the <strong class='uiterm'>Value data</strong> box, and then click <strong class='uiterm'>OK</strong>.</li><li>Quit Registry Editor.</li></ol></li></ol></div><div class='kb-moreinformation-section section'>To determine whether you are experiencing this issue,  map a drive to a network share, and then copy a folder to the network share.  Use a UNC path to connect to the network share, and then copy the same folder to the network share. Compare the Network Monitor captures of both copy operations, and then see whether the  captures show excessive SMB Notify Change traffic. </div><div class='kb-moreinformation-section section'>The following is an example of information that is displayed  in a  Network Monitor capture:<div class='indent'>794 0.000000 SMB C NT transact - Notify Change <strong class='sbody-strong'>WindowsServer2003Computer</strong><strong class='sbody-strong'> IPAddressofRemoteFileServer</strong><br>795 0.203125 TCP Control Bits: .A...., len:    0, seq:3285895987-3285895987, ack:1239945738, win:65535, src:  445  dst: 1095 <strong class='sbody-strong'>RemoteFileServer</strong><strong class='sbody-strong'> IPAddressofWindowsServer2003Computer</strong></div>The following is example of information that is displayed in the Ethereal output: <div class='indent'>794 12:08:06.349943 0.000000 <strong class='sbody-strong'>WindowsServer2003Computer</strong><strong class='sbody-strong'> RemoteFileServer</strong> SMB      NT Trans Request, NT NOTIFY, FID: 0x400e     1095     445<br>    795 12:08:06.553068 0.203125 <strong class='sbody-strong'>RemoteFileServer</strong><strong class='sbody-strong'> WindowsServer2003Computer</strong> TCP      microsoft-ds &gt; 1095 [ACK] Seq=3285895987 Ack=1239945738 Win=65535 Len=0  445      1095<br> <br>808 12:08:06.553068 0.000000 <strong class='sbody-strong'>RemoteFileServer</strong><strong class='sbody-strong'> WindowsServer2003Computer</strong> SMB      NT Trans Response, NT NOTIFY  445      1095<br></div>Apply the following  filter from the ethereal output to determine if you are experiencing the same issue that is described in this article:<br><div class='indent'>(ip.addr eq <strong class='sbody-strong'>IPAddressofRemoteFileServer</strong> and ip.addr eq <strong class='sbody-strong'>IPAddressofWindowsServer2003Computer</strong>) &amp;&amp; (smb.nt.function == 4) &amp;&amp;  (smb.cmd == 0xa0))<br></div></div><div class='kb-moreinformation-section section'><span>For additional information, click the following article numbers to view the articles in the Microsoft Knowledge Base:<br><br><div class='indent'><a id='kb-link-3' href='/en-us/help/831129'>831129 </a> Folder tree flickers when you view a mapped network drive in Microsoft Windows Explorer<br><br></div></span><span><div class='indent'><a id='kb-link-4' href='/en-us/help/816375'>816375 </a> Windows XP Explorer Pane flickers on mapped network drives<br><br></div></span><span><div class='indent'><a id='kb-link-5' href='/en-us/help/330929'>330929 </a> Windows XP may cause extra SMB notify change traffic<br><br></div></span><span><div class='indent'><a id='kb-link-6' href='/en-us/help/321169'>321169 </a> Slow SMB performance when you copy files from Windows XP to a Windows 2000 domain controller<br><br></div></span></div><div class='kb-moreinformation-section section'><h3 class='sbody-h3'>Steps to reproduce the issue</h3><ol class='sbody-num_list'><li>On a Windows Server 2003-based computer, map a drive to a network share that is located on a Windows 2000 Server-based computer.  For example, type the following line at the command prompt to map the network share to drive Z: <div class='indent'><span class='sbody-userinput'>net use z: \\<strong class='sbody-strong'>RemoteServerName</strong>\<strong class='sbody-strong'>ShareName</strong></span></div></li><li>Start Windows Explorer, and then do one of the following: <ul class='sbody-free_list'><li>Copy a folder  that contains a large number of files and subfolders from your  local hard disk to the mapped drive. </li><li>Copy a folder that contains a large number of files and subfolders  from your local hard disk to a subfolder on the  mapped drive. </li><li>Copy a folder that contains a large number of files and subfolders  from the mapped drive to a folder on your hard disk.</li></ul>For example, copy a folder that contains approximately 2000 files and 100 subfolders.</li></ol></div><div class='kb-securedata-section section'>Author: fredca<br>Writer: v-lanac<br>Tech Reviewer: v-raddis<br> Editor:  v-crweb</div>