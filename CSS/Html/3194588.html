<header><h1>&quot;0xc1800118&quot; error when you push Windows 10 Version 1607 by using WSUS</h1></header><div class="sbody-error">
<p><strong>Home users</strong>: This article is only intended for technical support agents and IT professionals. If you&#39;re looking for help with a problem, please <a href="https://answers.microsoft.com/en-us" managed-link="" target="_blank">ask the Microsoft Community</a>.</p>
</div>
<div class="kb-symptoms-section section">Consider the following scenario:<br>
&nbsp;
<ul class="sbody-free_list">
	<li>You have Windows Server Update Services (WSUS) configured in your environment.</li>
	<li>On the WSUS server, you install <a href="/en-us/help/3159706" id="kb-link-1">update 3159706 </a> to enable decryption of the new feature update for Windows 10.</li>
	<li>You approve the feature update for Windows 10 Version 1607.</li>
	<li>You notice that WSUS clients detect and download the feature update to C:\Windows\ccmcache, and that files populate correctly in C:\Windows\SoftwareDistribution\DataStore.</li>
</ul>
In this scenario, the installation starts, and files are decompressed to C:\$Windows.~BT. However, the process fails and returns the following error code:<br>
&nbsp;
<div class="sbody-error">
<div class="indent">0xC1800118</div>
</div>

<p><br>
Additionally, the following entry may be logged in the setuperr.log and setupact.log logs:</p>

<h5>From setuperr.log:</h5>

<div class="indent">
<pre class="sbody-pre">
 &lt;Date&gt; &lt;Time&gt;, Error SP CSetupPlatform::ResurrectNewSystem: Cannot resurrect new
 system.: Win32Exception: \\?\C:\$Windows.~BT\Sources\NewSystem.dat: The system
 cannot find the file specified. [0x00000002] __cdecl UnBCL::FileStream:
 :FileStream(const class UnBCL::String *,enum UnBCL::FileMode,enum UnBCL:
 :FileAccess,enum UnBCL::FileShare,unsigned long) [gle=0x00000002]

 &lt;Date&gt; &lt;Time&gt;, Error CONX Windows::Compat::Appraiser::SetupAppraiser:
 :StopEtlLogger (2884): Waiting on generaltel process failed:
 [258].[gle=0x00000102]

 &lt;Date&gt; &lt;Time&gt;, Error MOUPG RecoverCrypto: File is encrypted, but no key was
 provided.

 &lt;Date&gt; &lt;Time&gt;, Error MOUPG CDlpActionRecoverCrypto::DoCrypto(1713): 
 Result = 0xC1800118

 &lt;Date&gt; &lt;Time&gt;, Error MOUPG CDlpActionRecoverCrypto::ExecuteRoutine(2465): 
 Result = 0xC1800118

 &lt;Date&gt; &lt;Time&gt;, Error MOUPG CDlpActionImpl&lt;class CDlpErrorImpl&lt;class
 CDlpObjectInternalImpl&lt;class CUnknownImpl&lt;class IDlpAction&gt; &gt; &gt; &gt;:
 :Execute(441): Result = 0xC1800118
</pre>
</div>

<h5>From setupact.log:</h5>

<div class="indent">
<pre class="sbody-pre">
 &lt;Date&gt; &lt;Time&gt;, Error MOUPG RecoverCrypto: File is encrypted, but no key was
 provided.

 &lt;Date&gt; &lt;Time&gt;, Error MOUPG CDlpActionRecoverCrypto::DoCrypto(1713):
 Result = 0xC1800118

 &lt;Date&gt; &lt;Time&gt;, Error MOUPG CDlpActionRecoverCrypto::ExecuteRoutine(2465):
 Result = 0xC1800118

 &lt;Date&gt; &lt;Time&gt;, Warning MOUPG CSetupDiagnostics::ReportData - Not reporting
 WINDLP data point [0x2101]

 &lt;Date&gt; &lt;Time&gt;, Warning MOUPG CSetupDiagnostics::ReportData - Not reporting
 WINDLP data point [0x2100]

 &lt;Date&gt; &lt;Time&gt;, Error MOUPG CDlpActionImpl&lt;class CDlpErrorImpl&lt;class
 CDlpObjectInternalImpl&lt;class CUnknownImpl&lt;class IDlpAction&gt; &gt; &gt; &gt;:
 :Execute(441): Result = 0xC1800118

 &lt;Date&gt; &lt;Time&gt;, Info MOUPG RecoverCrypto: Leaving Execute Method

 &lt;Date&gt; &lt;Time&gt;, Error MOUPG CDlpTask::ExecuteAction(3243): Result = 0xC1800118


Error Details

 Hex code - 0xc1800118

 Symbolic Name - WINDLP_E_RECOVERCRYPTO_WIM_DECRYPTKEY_MISSING

 Error Description - No key was provided to decrypt the specified WIM file </pre>
</div>
</div>
<div class="kb-cause-section section">This problem occurs if the Windows 10 Version 1607 update is encrypted but does not appear as encrypted in the WSUS database. The problem may occur if the updates are synced before you apply KB 3159706.<br>
&nbsp;</div>
<p class="kb-workaround-section section"><span><span lang="EN-US"><span><span>To work around this problem, follow these steps</span></span></span></span><span>&nbsp;on all WSUS servers in the environment.</span><br>
&nbsp;</p>

<div class="kb-workaround-section section">
<ol class="sbody-num_list">
	<li>Detect whether WSUS is in a bad state. To do this, run the following query:&nbsp;<strong><span class="text-base"></span></strong><br>
	&nbsp;
	<div class="indent"><code>select Count(*)<br>
	from tbFile as f, tbFileForRevision as fr, tbRevision as r, tbUpdate as u, tbProperty as p<br>
	where f.FileDigest = fr.FileDigest and fr.RevisionID = r.RevisionID and r.LocalUpdateID = u.LocalUpdateID<br>
	and p.RevisionID = r.RevisionID and&nbsp;<br>
	(f.FileName like &#39;%15063%.esd&#39; or f.FileName like &#39;%14393%.esd&#39; or f.IsEncrypted = 1)&nbsp;<br>
	and f.DecryptionKey is null<br>
	and p.PublicationState = 0</code></div>
	<br>
	<strong>Note</strong> If the results show a &quot;TotalResults &gt; 0&quot; entry, this&nbsp;indicates that the server is in a bad state.</li>
	<li>If WSUS is in a bad state, take the following steps in the listed order and in the indicated locations:<br>
	&nbsp;
	<p><br>
	<strong>Order of steps</strong></p>

	<ol start="1" style="list-style-type:upper-roman">
		<li><span><span>Disable the &ldquo;Upgrades&rdquo; classification (USS or stand-alone WSUS)</span></span></li>
		<li><span><span><span>In Windows PowerShell ISE (admin), decline all Windows 10 upgrades.<span lang="EN-US"></span></span></span></span></li>
		<li><span><span><span>Remove all the upgrades for Windows 10 from the SUSDB.<span lang="EN-US"></span></span></span></span></li>
		<li><span><span>Delete files from the tbFile table in the WSUS database.</span></span></li>
		<li><span><span>Re-enable the classification in Windows PowerShell.</span></span></li>
		<li><span><span> Force a sync (PowerShell).</span></span></li>
	</ol>

	<ul>
		<li>Step 1: Disable the &ldquo;Upgrades&rdquo; classification (USS or stand-alone WSUS).
		<pre class="sbody-pre">
<span class="text-base">Get-WsusClassification | Where-Object -FilterScript {$_.Classification.Title -Eq &ldquo;Upgrades&rdquo;} | Set-WsusClassification -Disable </span></pre>
		</li>
		<li>Step 2: In Windows PowerShell ISE (admin), decline all Windows 10 upgrades.
		<pre>
<strong>[reflection.assembly]::LoadWithPartialName(&quot;Microsoft.UpdateServices.Administration&quot;)
$wsus = [Microsoft.UpdateServices.Administration.AdminProxy]::GetUpdateServer();
$wsus.GetUpdates() | Where {$_.UpdateClassificationTitle -eq &#39;Upgrades&#39; -and $_.Title -match &#39;Windows 10&#39;} `
| ForEach-Object {$_.Decline(); Write-Host $_.Title declined}</strong><strong> </strong>
</pre>
		</li>
		<li>Step 3: Remove all the Upgrades for Windows 10 from the SUSDB.<span lang="EN-US"></span><br>
		<br>
		<strong>Note</strong> Make sure that you run the deletion first on the WSUS server that is highest in your hierarchy. Then, work your way down. Otherwise, your deletions may be replaced by the USS on the next sync attempt.<br>
		<span class="text-base"></span>
		<pre class="sbody-pre">
<strong>[reflection.assembly]::LoadWithPartialName(&quot;Microsoft.UpdateServices.Administration&quot;)
$wsus = [Microsoft.UpdateServices.Administration.AdminProxy]::GetUpdateServer();
$wsus.GetUpdates() | Where {$_.UpdateClassificationTitle -eq &#39;Upgrades&#39; -and $_.Title -match &#39;Windows 10&#39;} `
| ForEach-Object {$wsus.DeleteUpdate($_.Id.UpdateId.ToString()); Write-Host $_.Title removed}</strong>
</pre>
		</li>
		<li>Step 4: Delete files from the tbFile table in the WSUS database.&nbsp;On the WSUS database, run the following commands from SQL Server Management Studio:<br>
		<span class="text-base"></span>
		<pre class="sbody-pre">
<strong>declare @NotNeededFiles table (FileDigest binary(20) UNIQUE)
insert into @NotNeededFiles(FileDigest) (select FileDigest from tbFile where FileName like &#39;%.esd%&#39; &nbsp;except select FileDigest from tbFileForRevision)
delete from tbFileOnServer where FileDigest in (select FileDigest from @NotNeededFiles)
delete from tbFile where FileDigest in (select FileDigest from @NotNeededFiles)</strong></pre>
		</li>
		<li>Step 5: Re-enable the classification in Windows PowerShell.<span class="text-base"></span>
		<pre class="sbody-pre">
<strong>Get-WsusClassification | Where-Object -FilterScript {$_.Classification.Title -Eq &ldquo;Upgrades&rdquo;} | Set-WsusClassification</strong>
</pre>
		</li>
		<li>Step 6: Force a Sync (PowerShell):
		<pre>
<strong>$s = Get-WsusServer
$sub = $s.GetSubscription()
$sub.StartSynchronization()</strong>
</pre>
		</li>
	</ul>
	</li>
	<li>If you are using&nbsp;<span><span><span><span lang="EN-US"><span><span>System Center Configuration Manager (ConfigMgr), follow these steps:</span></span></span></span></span></span><br>
	&nbsp;
	<ol start="1" style="list-style-type:lower-alpha">
		<li><span><span><span><span lang="EN-US"></span><span lang="EN-US"><span><span>On the topmost ConfigMgr&nbsp;server in the hierarchy<span>, </span>open <strong>&lt;sccm Install directory&gt;\inboxes\wsyncmgr.box</strong>.</span></span></span></span></span></span><span><span><span lang="EN-US"></span></span></span></li>
		<li>In the wsyngmgr.box folder, c<span><span><span><span lang="EN-US"><span><span>reate a file that is named &quot;FULL.SYN&quot; (this file&nbsp;</span></span></span></span></span></span>forces ConfigMgr to do a full sync for updates). Monitor the wsyncmgr.log to verify that the file&nbsp;ran.</li>
	</ol>
	<span lang="EN-US"></span></li>
	<li><span><span><span><span lang="EN-US"></span><span lang="EN-US"><span><span>On each client, do the following:</span></span></span></span></span></span><br>
	&nbsp;
	<ol start="1" style="list-style-type:lower-alpha">
		<li><span><span><span><span lang="EN-US"></span><span lang="EN-US"><span><span><span><span><span><span lang="EN-US"><span><span>In an elevated Command Prompt window, run the following command:</span></span></span></span></span></span><br>
		<br>
		<code><strong>net stop wuauserv</strong></code></span></span></span></span></span></span></li>
		<li><span><span><span><span lang="EN-US"></span><span lang="EN-US"><span><span>Run the following command:<br>
		<br>
		<code><strong>del %windir%\SoftwareDistribution\DataStore\*</strong></code></span></span></span></span></span></span><br>
		<span><span><span lang="EN-US"><span><span><br>
		<strong>Note</strong>&nbsp;This command also forces a full scan from the client.</span></span></span></span></span></li>
		<li><span><span><span><span lang="EN-US"></span><span lang="EN-US"><span><span>Make sure that there&#39;s no hidden ~BT folder on drive C. If there is, delete the folder.</span></span></span></span></span></span></li>
		<li><span><span><span><span lang="EN-US"></span></span></span></span><span><span><span><span lang="EN-US"></span><span lang="EN-US"><span><span>Run the following command:<br>
		<br>
		<code><strong>net start wuauserv</strong></code></span></span></span></span></span></span></li>
	</ol>
	</li>
</ol>
</div>
<div class='kb-securedata-section section'>Product Bug Number:<br><a id='kb-link-2' href='https://microsoft.visualstudio.com/defaultcollection/os/_workitems/edit/8778264?fullscreen=false' target='_self'>Bug 8778264</a><br>Author ID (email alias): kaushika<br>Writer ID (email alias): kaushika<br>Tech Review ID (email alias): rahulten; shenry<br>Editor: v-jesits<br>Confirm Article has been Tech Reviewed: Yes<br>Confirm Article released for Publishing: Yes </div>