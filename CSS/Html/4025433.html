<header><h1>Azure Support - Azure Role-Based Access Control (RBAC)</h1></header><p><u>OVERVIEW</u></p>

<p>This TSG outlines the troubleshooting steps needed for Azure Role-Bases Access Control (RBAC) issues, that fall into ASMS scope.</p>

<p><strong>What is RBAC?</strong></p>

<p>Azure RBAC allows admins to grant special permissions to users for only the amount needed to perform their jobs. Access is granted by assigning the appropriate RBAC role to users, groups and/or applications at a certain scope. The scope of a role assignment can be a subscription, a resource group, or a single resource. A role assigned at a parent scope also grants access to the children contained within it.<cite><span>&nbsp;</span></cite></p>

<p>Additional information on how RBAC works:</p>

<ol style="list-style-type:decimal" type="1">
	<li value="1"><span>&nbsp;</span><a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-understanding-resource-access"><span>Understanding resource access in Azure</span></a></li>
</ol>

<ol style="list-style-type:decimal" type="1">
	<li value="2"><a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-supported-services#resource-providers-and-types"><span>Obtaining a list of resource providers</span></a></li>
</ol>

<p><u>Policy</u></p>

<p>When first receiving a case, contact the customer to scope the case and determine what the customer is trying to do. If the issue is within your area of support, review the solutions list in the &quot;Support Scenarios&quot; section below for troubleshooting steps:</p>

<ol style="list-style-type:decimal" type="1">
	<li value="1"><span>Subscriptions</span></li>
	<li><span>Azure AD</span></li>
	<li><span>Virtual Machines</span></li>
	<li><span>Networking</span></li>
</ol>

<p><u><a id="Customer Experience and Provisioning" name="Customer Experience and Provisioning"></a>Customer Experience and Provisioning</u></p>

<p>&nbsp;</p>

<p>When an email ID is granted an RBAC role in a tenant, an invite email is sent from <a href="mailto:invites@microsoft.com">invites@microsoft.com</a>. This email contains a <em>Get Started</em> link that directs the user to the tenant where the user can accept the role. After accepting the role, the email ID becomes a guest in the tenant and is given a role on the subscription.</p>

<p><strong>Note:</strong> Adding a user as a <em>Guest</em> to the tenant will also trigger this email.</p>

<p>Only email IDs that are not part of the tenant will receive this email. (For example, a Microsoft account or an email ID from a different organization, or a different Active Directory instance.)</p>

<p>If the email ID does not have a mailbox, then the user gets added to the tenant without an invite email. However, when this email ID logs in to Azure, it is prompted to accept an invite to the tenant. There is no option to select between a Microsoft Account and a Work account while granting an RBAC role.</p>

<p>Most of the time, email IDs with Work accounts inherit the RBAC role if they have a mailbox set up to receive the invite email.</p>

<p>&nbsp;</p>

<p><u>SUPPORT SCENARIOS</u></p>

<p>Below are a list of scenarios that can be handled by ASMS. Depending on the scenario, follow the solutions outlined in the &quot;Engineer Troubleshooting &quot;section.</p>

<p><em>Scenario #1: </em><strong>User is unable to view subscriptions in the Azure Portal</strong></p>

<p>Solutions: 1, 2, 3, 4</p>

<p><strong>Scenario </strong><strong>#2: User is unable to view and manage all resources for a subscription in the Azure Portal</strong></p>

<p>Solutions<strong>:</strong> 1, 2, 3, 4, 5</p>

<p><u>ENGINEER TROUBLESHOOTING STEPS</u></p>

<p><strong>Solution #1: Verify if the user is logging into the account that is associated with the subscription </strong></p>

<ol style="list-style-type:decimal" type="1">
	<li value="1"><span>The user may be logging into a personal account (MSA) instead of a work/school account (organizational) that share a similar email address due to Azure AD and Microsoft account (MSA) overlap. </span></li>
</ol>

<ol style="list-style-type:decimal" type="1">
	<li value="2"><span>To verify follow the below steps:</span>

	<ol style="list-style-type:lower-alpha" type="a">
		<li value="1"><span>Ensure that you have the user&rsquo;s email address. </span></li>
		<li><span>Go to </span><a href="https://acis.engineering.core.windows.net/workflowtools.aspx"><span>https://acis.engineering.core.windows.net/workflowtools.aspx </span></a></li>
		<li><span>Select the following dropdown values as shown below:</span></li>
	</ol>
	</li>
</ol>

<blockquote dir="ltr">
<blockquote dir="ltr">
<blockquote dir="ltr">
<p><span><br>
&nbsp;<span asset="4025581" contenteditable="false" props="{&quot;size&quot;:&quot;full&quot;}" unselectable="on">4025581</span></span></p>

<ol style="list-style-type:lower-alpha" type="a">
</ol>

<p><span>d. Enter the user&rsquo;s email address into the </span><strong>Email ID </strong><span>field and click </span><strong>Execute. </strong></p>

<ol style="list-style-type:lower-alpha" type="a">
</ol>

<p><span>e. If the email address is both a work/school account (organizational) and a personal account (MSA) you should see 2 PUIDs in the output as shown below:</span></p>

<ol style="list-style-type:lower-alpha" type="a">
</ol>

<p><span asset="4025582" contenteditable="false" props="{&quot;size&quot;:&quot;full&quot;}" unselectable="on">4025582</span></p>

<ol style="list-style-type:lower-alpha" type="a">
</ol>

<p><span>f. If this is the issue, have the customer log into the correct account (that is associated to the subscription).</span></p>
</blockquote>
</blockquote>
</blockquote>

<p dir="ltr">3. Have the customer rename their personal MSA by following the instructions <a href="https://support.microsoft.com/en-us/help/11545/microsoft-account-rename-your-personal-account">here</a>.</p>

<blockquote dir="ltr">
<blockquote dir="ltr">&nbsp;</blockquote>

<p dir="ltr"><strong>NOTE:</strong> If the customer&rsquo;s IT department asked to create a personal Microsoft account with their work/school email (eg: to access Microsoft business services like Premier Support), then have them talk to their admin team before renaming their account.</p>

<blockquote dir="ltr">&nbsp;</blockquote>
</blockquote>

<blockquote dir="ltr">
<blockquote dir="ltr">&nbsp;</blockquote>
</blockquote>

<p dir="ltr"><span><strong>Solution #2: Verify if the user has the appropriate permissions to view the subscription</strong></span></p>

<blockquote dir="ltr">
<ol>
	<li>
	<div><span><span>The user may have the incorrect role (or none) assigned for the subscription. </span></span></div>
	</li>
	<li>
	<p><span><span>To verify follow the below steps: </span></span></p>

	<ol style="list-style-type:lower-alpha" type="a">
		<li value="1"><span><span>Ensure that you have the user&rsquo;s email address and subscription. </span></span></li>
		<li><span><span>Go to </span><a href="https://acis.engineering.core.windows.net/workflowtools.aspx"><span>https://acis.engineering.core.windows.net/workflowtools.aspx</span></a><span>. </span></span></li>
		<li><span><span>Obtain the user&rsquo;s PUID by selecting the dropdown values shown below:</span></span></li>
	</ol>
	</li>
</ol>

<blockquote dir="ltr">
<blockquote dir="ltr">
<blockquote dir="ltr">
<blockquote dir="ltr">
<p dir="ltr"><span><span asset="4025583" contenteditable="false" props="{&quot;size&quot;:&quot;full&quot;}" unselectable="on">4025583</span><br>
&nbsp;&nbsp;<br>
&nbsp;<span asset="4025584" contenteditable="false" props="{&quot;size&quot;:&quot;full&quot;}" unselectable="on">4025584</span></span></p>

<p dir="ltr"><span>d.Once you have the PUID of the user, check the subscription to see what admin role the user has on the subscription and if it is enabled:&nbsp;<br>
&nbsp;<span asset="4025585" contenteditable="false" props="{&quot;size&quot;:&quot;full&quot;}" unselectable="on">4025585</span></span></p>
</blockquote>
</blockquote>

<ol style="list-style-type:lower-alpha" type="a">
</ol>
</blockquote>
</blockquote>
</blockquote>

<blockquote dir="ltr">
<blockquote dir="ltr">
<p dir="ltr"><span><span><span>3. If the user does not have a role, add the correct roles and permissions for the subscription via steps </span><a href="https://docs.microsoft.com/en-us/azure/billing/billing-add-change-azure-subscription-administrator"><span>here</span></a><span>. </span></span></span></p>

<blockquote dir="ltr">
<blockquote dir="ltr">
<ol style="list-style-type:decimal" type="1">
</ol>
</blockquote>
</blockquote>
</blockquote>

<p dir="ltr">&nbsp;</p>
</blockquote>

<p dir="ltr"><span><span><strong>Solution #3: Verify if the user is viewing the correct directory in the Azure Portal. </strong></span></span></p>

<blockquote dir="ltr">
<ol dir="ltr">
	<li>
	<div><span><span><span>The user may be selecting the incorrect directory in the Azure Portal. To verify:</span></span></span></div>

	<ol style="list-style-type:lower-alpha" type="a">
		<li value="1"><span><span><span>Click the user profile at the top right hand corner in the Azure Portal. </span></span></span></li>
		<li><span><span><span>Confirm if the user is in the correct directory (highlighted).</span></span></span></li>
	</ol>
	</li>
</ol>

<blockquote dir="ltr">
<blockquote dir="ltr">
<blockquote dir="ltr">
<blockquote dir="ltr">
<p dir="ltr"><span><span><span asset="4025586" contenteditable="false" props="{&quot;size&quot;:&quot;full&quot;}" unselectable="on">4025586</span><br>
&nbsp;</span></span></p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>

<blockquote dir="ltr">
<blockquote dir="ltr">
<blockquote dir="ltr">
<p dir="ltr">&nbsp;</p>

<ol style="list-style-type:decimal" type="1">
</ol>
</blockquote>

<p dir="ltr"><span><span>2. If the user is not, have the user switch to the correct directory in the Azure Portal. </span></span></p>

<p dir="ltr"><span><span>3. </span><span>If the user is unable to view the desired directory, it means that they are not provisioned into that directory. </span></span></p>
</blockquote>

<p dir="ltr">&nbsp;</p>
</blockquote>

<p dir="ltr"><span><strong>Solution #4: Verify if the subscription is associated to the desired directory</strong></span></p>

<blockquote dir="ltr">
<p dir="ltr">&nbsp;</p>

<ol>
	<li>
	<p><span><span>The subscription that the user is trying to view may be associated to a different directory. </span></span></p>
	</li>
	<li>
	<p><span><span>To verify following the below steps:</span></span></p>
	</li>
</ol>

<ol style="list-style-type:decimal" type="1">
	<li>
	<ol style="list-style-type:lower-alpha" type="a">
		<li value="1"><span><span>Ensure that you have the user&rsquo;s subscription and tenant. </span></span></li>
		<li><span><span>Go to </span><a href="https://acis.engineering.core.windows.net/workflowtools.aspx"><span>https://acis.engineering.core.windows.net/workflowtools.aspx</span></a><span>. </span></span></li>
		<li><span><span>Obtain the tenant ID that the subscription is associated to by selecting the dropdown values shown below:</span></span></li>
	</ol>
	</li>
</ol>

<blockquote dir="ltr">
<blockquote dir="ltr">
<blockquote dir="ltr">
<blockquote dir="ltr">
<p dir="ltr"><span>&nbsp;<span asset="4025587" contenteditable="false" props="{&quot;size&quot;:&quot;full&quot;}" unselectable="on">4025587</span><br>
&nbsp;d. Obtain the user&rsquo;s tenant ID by looking up the user&rsquo;s tenant in ViewPoint (<a href="https://support.office.net/">https://support.office.net/</a>):</span></p>

<p><span><span asset="4025588" contenteditable="false" props="{&quot;size&quot;:&quot;full&quot;}" unselectable="on">4025588</span><br>
&nbsp;</span></p>

<p dir="ltr"><span><span>e. Compare both values &ndash; the subscription tenant ID should match the tenant ID that the user is on. </span></span></p>
</blockquote>
</blockquote>

<blockquote dir="ltr">
<blockquote dir="ltr">
<p dir="ltr"><span><span>f. If not, have the customer change the directory for the subscription by transferring the subscription to a user account in the target directory. More details can be found </span><a href="https://docs.microsoft.com/en-us/azure/billing/billing-subscription-transfer"><span>here</span></a><span>. </span></span></p>
</blockquote>

<ol style="list-style-type:lower-alpha" type="a">
</ol>
</blockquote>
</blockquote>

<p dir="ltr"><span>3. When that user completes the steps to accept transfer, the subscription is automatically moved to the target directory. </span></p>
</blockquote>
</blockquote>

<p dir="ltr"><strong>Solution #5: Verify if the user is filtering out some subscriptions in their resource view in the Azure Portal</strong></p>

<blockquote dir="ltr">
<ol dir="ltr">
	<li>
	<div><span>The user may be accidentally filtering out some subscriptions from their resource view in the Azure Portal. To verify:</span></div>

	<ol style="list-style-type:lower-alpha" type="a">
		<li value="1"><span>In the </span><em>All Resources </em><span>or </span><em>Resource Groups </em><span>blade, ensure that the correct subscriptions are selected in the filter here. </span></li>
	</ol>
	</li>
</ol>

<blockquote dir="ltr">
<blockquote dir="ltr">
<blockquote dir="ltr">
<blockquote dir="ltr">
<p dir="ltr"><span asset="4025589" contenteditable="false" props="{&quot;size&quot;:&quot;full&quot;}" unselectable="on">4025589</span></p>
</blockquote>
</blockquote>
</blockquote>

<p dir="ltr"><span>2. If this is the issue, change the filters to view the desired resources for the subscription. </span></p>

<blockquote dir="ltr">
<ol style="list-style-type:decimal" type="1">
</ol>

<p dir="ltr">&nbsp;</p>
</blockquote>
</blockquote>
</blockquote>

<p dir="ltr">&nbsp;</p>

<p dir="ltr"><strong>How to check RBAC role on a subscription:</strong></p>

<ol dir="ltr">
	<li>Go to <strong>Azure Support Center</strong>.</li>
	<li>Click on <strong>Resource Explorer</strong>. (You can load any subscription by adding the Sub GUID at the bottom left).</li>
	<li>Click on the <strong>Subscription GUID</strong> on the left.</li>
	<li>On the main screen, click on <strong>Access control (IAM)</strong>.</li>
	<li>This will show a list of all RBAC roles on the sub.</li>
	<li>Select the role type you want to check (Owner, reader, contributor etc).</li>
	<li>Expand the role.</li>
	<li>Copy the <strong>Assignment principal ID</strong>.</li>
	<li>Open Jarvis and go to <strong>Azure Resource Manager</strong> -&gt; <strong>User management</strong> -&gt; <strong><a data-bind="text: actionsModel.selectedTreeNode().operationName(), click: onOperationClick.bind($data), tooltip: { title: 'Operation: ' + actionsModel.selectedTreeNode().operationName() }" data-original-title="" title="">Get graph resource details from principal ID</a></strong>.</li>
	<li>Enter the tenant ID (of the subscription) and the principal ID copied from ASC.</li>
	<li>The output result will display the user details.</li>
</ol>

<p dir="ltr">&nbsp;</p>

<p dir="ltr"><span><u>ENGAGEMENT &amp; ESCALATION PATH</u></span></p>

<blockquote dir="ltr">
<ol>
	<li>
	<p>For escalations regarding managing RBAC roles in the IAM blade, engage the Identity team using the guidelines outlined in <a href="https://internal.support.services.microsoft.com/en-us/help/2832928" managed-link="" target="_blank">TSG 2832928</a>.</p>
	</li>
</ol>
</blockquote>

<p dir="ltr"><span><u>ADDITIONAL REFERENCES:</u></span></p>

<blockquote dir="ltr">
<ol>
	<li>
	<div><span><span>Management portal and Accounts portal Authentication (eSTS - Org ID and Live ID)</span><strong>- </strong><span>TSG </span><a href="https://internal.support.services.microsoft.com/en-us/help/2927087/azure-support---team-engagement">2820621</a></span></div>
	</li>
	<li>
	<div><span><span>How to change the default directory of a subscription: </span><span>https://docs.microsoft.com/en-us/azure/billing/billing-subscription-transfer </span></span></div>
	</li>
	<li>
	<div><span><span>How to perform a subscription ownership transfer: </span><a href="https://docs.microsoft.com/en-us/azure/billing/billing-subscription-transfer%c2%a0%c2%a0%c2%a0%c2%a0%20"><span>https://docs.microsoft.com/en-us/azure/billing/billing-subscription-transfer &nbsp;&nbsp;&nbsp;&nbsp; </span></a></span></div>
	</li>
	<li>
	<div><span><span>How to delete a subscription: </span><a href="https://docs.microsoft.com/en-us/azure/billing/billing-how-to-cancel-azure-subscription"><span>https://docs.microsoft.com/en-us/azure/billing/billing-how-to-cancel-azure-subscription &nbsp;&nbsp;&nbsp;&nbsp; </span></a></span></div>
	</li>
</ol>
</blockquote>

<p dir="ltr"><span><strong><span lang="EN"><span>How to validate if user is added using RBAC or Legacy from Ibiza Portal can be found <a class="btn btn-primary" href="https://microsoft.sharepoint.com/teams/ASMS/ASMS%20Community%20Documents/VKBDocs/RBAC%20Diagnostic%20Logs.docx?d=wc29fa589bc114c958c4f378ff9a694fd" managed-link="" target="_blank">here.</a></span></span></strong></span></p>

<p dir="ltr">&nbsp;</p>

<blockquote dir="ltr">
<h3 dir="ltr"><span>TSG CHANGE LOG</span></h3>
</blockquote>

<blockquote dir="ltr">
<div>
<table class="table">
	<tbody>
		<tr>
			<td>
			<p><span><strong>Date </strong></span></p>
			</td>
			<td>
			<p><span><strong>Updated By</strong></span></p>
			</td>
			<td>
			<p><span><strong>Content Updated</strong></span></p>
			</td>
		</tr>
		<tr>
			<td>
			<p><span>06/06/2017</span></p>
			</td>
			<td>
			<p><span>mievan</span></p>
			</td>
			<td>
			<p><span>Created TSG.</span></p>
			</td>
		</tr>
		<tr>
			<td>
			<p><span>06/27/2017</span></p>
			</td>
			<td>
			<p><span>shsims</span></p>
			</td>
			<td>
			<p><span>Added RBAC Diagnostic word doc link.</span></p>
			</td>
		</tr>
		<tr>
			<td>
			<p>09/11/2018</p>
			</td>
			<td>
			<p>v-adhigg</p>
			</td>
			<td>
			<p>Updated this article as part of ModTrack 1492. This update added the <em>Customer Experience and Provisioning</em> section to this document.</p>
			</td>
		</tr>
		<tr>
			<td>
			<p>05/28/2019</p>
			</td>
			<td>
			<p>v-brgosn</p>
			</td>
			<td>
			<p>Added&nbsp;checking RBAC role<strong> </strong>on subscription details.</p>
			</td>
		</tr>
		<tr>
			<td>11/12/2019</td>
			<td>v-ereric</td>
			<td>Updated Engagement and Escalation Path.</td>
		</tr>
		<tr>
			<td>04/29/2020</td>
			<td>v-ishan</td>
			<td>Updated steps to check RBAC role as per ModTrack 2833.</td>
		</tr>
		<tr>
			<td>06/09/2020</td>
			<td>v-viizza</td>
			<td>Replaced &quot;Roles&quot; with &quot;Access control (IAM)&quot; in step 4 under &#39;How to check RBAC...&#39; per ModTrack 2940.</td>
		</tr>
	</tbody>
</table>
</div>
</blockquote>
